---
layout: post
title: 挖洞经验 | 记一次曲折的Getshell过程
categories:
- Pocket
tags:
---
原文地址：http://mp.weixin.qq.com/s/habUyxHErkNkptAKeknaHw

收藏时间：2017-08-30 13:19:56

<div  lang="zh">
            
                        <div id="img-content" nodeIndex="6">
                
                
                <p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="11">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">freebuf</span>
                            </p><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="12">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">国内关注度最高的全球互联网安全新媒体</span>
                            </p>
                
                
                
                
                                                
                                                                
                
                <div class="rich_media_content " id="js_content" nodeIndex="13">
                    

                    

                    
                    
                    <p class=" _RIL_KEEPER_CLASS_" nodeIndex="14"><span nodeIndex="109">*本文原创作者：三只小潴，本文属FreeBuf原创奖励计划，未经许可禁止转载</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="15"><span nodeIndex="110"><strong class=" _RIL_KEEPER_CLASS_" nodeIndex="111">最近在挖某框架的漏洞，其中挖到一枚Getshell，挖的过程有点曲折感觉可以写篇文章总结一下，方便与各位大牛交流交流。</strong></span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="16"><span nodeIndex="112"><strong class=" _RIL_KEEPER_CLASS_" nodeIndex="113">因为此框架有大量用户，并且此漏洞并未修复，故此隐去所有有关此框架的信息，连文章中出现的代码都是我自己另写的，重在思路，希望大家理解。</strong></span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="17">首先通过审计定位到可能导致漏洞的代码（路径：/edit/creat.php）：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="18"><div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/1"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="19">其中 $GP 是合并 $GET 和 $_POST 的变量。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="20">可以看到写入的文件路径和写入的部分内容都是可控的，看到这里不禁露出了一丝笑容，没想到一枚 getshell 如此轻松。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="21">好吧，先测试一下，把$file的值设置为：</p><pre nodeIndex="22"><code nodeIndex="114"><?php echo 1111; ?>.php</code></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="23">post 到 /index.php? control=edit&action=creat</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="24">(此框架是单入口)</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="25"><div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/2"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="26">预计生成的文件内容是：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="27"><div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/3"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="28">好了，那访问一下生成的文件，URL：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="29"><div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/4"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="30"><span nodeIndex="115">右键查看一下源码，发现输出的内容是：</span><br nodeIndex="116"></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="31"><div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/5"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="32">居然被过滤了？ 回溯之前的代码，在 index.php 文件中发现代码：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="33"><div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/6"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="34">关键在开始的两行代码上，htmlEncode ? 搜索这个函数，找到这个函数的代码如下：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="35"><div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/7"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="36">结合起来，就是对 post 和 get 获取到的所有内容进行htmlspecialchars，所以才会出现上面所看到的尖括号被过滤的情况。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="37">看到这里，脸上的笑容都消失了，哎呀，果然没那么容易。尖括号过滤了，那就没办法写入PHP 代码的解析标签了，想不到什么突破的办法，难道就这样放弃么？开始犯愁…</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="38">一直想着：过滤了尖括号怎么办？过滤了尖括号怎么办？过滤了尖括号怎么办……</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="39">那我能不能不用尖括号呢？不用尖括号能不能解析？要怎么才能解析？想到这里，突然就想到模板！这个框架的模板和大多数 MVC 的模板一样，使用大括号作为标记:</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="40"><div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/8"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="41">这样就可以使用模板的标记 {} 来绕过尖括号 <> 的过滤，但是根据这个框架的路由协定，模板不能随便被包含，所以只能覆盖原有的模板。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="42">按照这个思路，找一个有加载模板的功能，覆盖加载的模板，覆盖之后访问了就可以解析了。按照这个思路，找到一个加载了模板的功能，URL是：</p><pre nodeIndex="43"><code nodeIndex="117">/index.php? control=basic&action=index</code></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="44">代码路径在/basic/index.php，代码最后就有调用 view(‘index’);</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="45">加载的模板路径在：</p><pre nodeIndex="46"><code nodeIndex="118">/themes/basic/index.html</code></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="47">按照这些信息，应该构造 $file 的值为：</p><pre nodeIndex="48"><code nodeIndex="119">../../themes/basic/index.html</code></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="49">但是这样又有一个问题了，虽然构造这样的值可以覆盖原有的模板文件，但是写入的文件内容就是：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="50"><div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/9"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="51">这样的话就没有写入需要的 Webshell 了，怎么办呢？！</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="52">根据 URL 的特性，./1.php 和 ./test/../1.php 访问的内容是一样的，都是 1.php 这个文件，但是 test 这个目录名我是可以随便写的，再根据模板伪代码的格式构造一个控制 $file 的测试 POC：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="53"><div id="RIL_IMG_10" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/10"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="54">（根据 view() 函数的代码，有一个{php }伪代码标签，处理的时候会替换为 <?php >。其实就算是没有这标签也可以用其他非组合的标签代替）</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="55"><div id="RIL_IMG_11" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/11"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="56">生成的文件内容为：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="57"><div id="RIL_IMG_12" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/12"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="58"><span nodeIndex="120">访问 URL：</span></p><pre nodeIndex="59"><code nodeIndex="121">/index.php? control=basic&action=index</code></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="60">右键查看源码，输出的内容为：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="61"><div id="RIL_IMG_13" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/13"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="62">证明代码执行了，那构造一个包含一句话的 POC，按照上一个 POC 的思路，应该把 file 的值构造为：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="63"><div id="RIL_IMG_14" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/14"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="64"><span nodeIndex="122"> 但是访问后发现输出的内容为：</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="65"><div id="RIL_IMG_15" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/15"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="66">想起 $file 的值是通过框架封装的 <span nodeIndex="123">$</span>GP 的值都经过了 htmlencode，怎么办呢？！ 根据 PHP 的特性，$_POST[‘w’] 获取值的时候可以把引号去掉，所以可以把 poc 改为：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="67"><div id="RIL_IMG_16" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/16"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="68"><div id="RIL_IMG_17" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/17"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="69">访问 URL：/index.php? control=basic&action=index ，给参数 w传值 echo 1111;</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="70"><div id="RIL_IMG_18" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/18"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="71">右键查看源码，内容为：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="72"><div id="RIL_IMG_19" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/19"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="73">证明 post 的代码确实被执行了，到服务器上执行：</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="74"><div id="RIL_IMG_20" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/20"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="75"><div id="RIL_IMG_21" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/21"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="76">至此，getshell 完成，虽然过程有点艰辛，但还是拿下了。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="77">最后总结一下：</p><blockquote nodeIndex="78"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="79">1. 刚开始遇到过滤尖括号等的 HTML 字符的时候，利用了 MVC 模板中的伪代码代替绕过了</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="80">2. 遇到覆盖文件时候填写完整路径不能写入payload 的问题，使用了构造一个不存在的目录（目录的名称就是 payload）的方法进行 payload 的写入</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="81">3. 最后写入 payload 的时候发现也过滤了引号导致不能写入 $POST[‘w’] ，根据 PHP 的特性，去掉引号依然可以获取 w 下标的内容，所以替换为 $POST[w]</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="82">4. 写入最终构造好的 payload，Getshell 完成！</p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="83"><span nodeIndex="124">*本文原创作者：三只小潴，本文属FreeBuf原创奖励计划，未经许可禁止转载</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="84"><div id="RIL_IMG_22" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/22"/></div></p>
                </div>
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" nodeIndex="85"></div>

                
                                <p id="js_preview_reward_wording" class="tips_global reward_tips _RIL_KEEPER_CLASS_" nodeIndex="87"></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="88">
                        <a class="reward_access" id="js_preview_reward_link" href="">赞赏</a>
                    </p>
                <p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="90">长按二维码向我转账</p><p id="js_preview_reward_ios_wording" class="reward_tips _RIL_KEEPER_CLASS_" nodeIndex="91"></p><p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="92">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p><div id="RIL_IMG_23" class="RIL_IMG"><img src="/media/posts_images/2017-08-30-1873974313/23"/></div>
                            </div>
                        
                        


                    </div>