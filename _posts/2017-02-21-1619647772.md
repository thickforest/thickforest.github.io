---
layout: post
title: Cobalt Strike之DNS Beacon使用记录
categories:
- Pocket
tags:
---
原文地址：http://mp.weixin.qq.com/s/aI0FjUbyYTlIfa-LdGwNUA

收藏时间：2017-02-21 11:42:48

<div  lang="zh">
                <div id="img-content" class="rich_media_area_primary" nodeIndex="6">
                    
                    <p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="11">
                                <label class="profile_meta_label">微信号</label>
                                <span class="profile_meta_value">freebuf</span>
                                </p><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="12">
                                <label class="profile_meta_label">功能介绍</label>
                                <span class="profile_meta_value">国内关注度最高的全球互联网安全新媒体</span>
                                </p>
                    
                    
                    
                    
                                                            
                                                            
                    
                    <div class="rich_media_content " id="js_content" nodeIndex="13">
                        

                        
                        
                        <p class=" _RIL_KEEPER_CLASS_" nodeIndex="14"><span nodeIndex="92">*原创作者：补丁君，本文属FreeBuf原创奖励计划，未经许可禁止转载</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="15"><span nodeIndex="93">笔者使用环境</span></p><table class=" _RIL_KEEPER_CLASS_ ril_dataTable" nodeIndex="94"><colgroup nodeIndex="95"><col width="49.89224137931034%" nodeIndex="96"><col width="50.10775862068966%" nodeIndex="97"></colgroup><thead nodeIndex="98"><tr nodeIndex="99"><th width="254" nodeIndex="100"><span nodeIndex="101">本机</span></th><th width="47" nodeIndex="102"><span nodeIndex="103">Debian Linux</span></th></tr></thead><tbody nodeIndex="104"><tr nodeIndex="17"><td height="30" width="103" nodeIndex="16"><span nodeIndex="105">服务器</span></td><td height="30" width="47" nodeIndex="18"><span nodeIndex="106">VPS（Debian Linux）</span></td></tr><tr nodeIndex="20"><td height="30" width="103" nodeIndex="19"><span nodeIndex="107">目标</span></td><td height="30" width="47" nodeIndex="21"><span nodeIndex="108">Windows 2003（虚拟机）</span></td></tr><tr nodeIndex="23"><td height="30" width="103" nodeIndex="22"><span nodeIndex="109">Cobalt Strike</span></td><td height="30" width="27" nodeIndex="24"><span nodeIndex="110"> v3.6（开心版）</span></td></tr></tbody></table><p class=" _RIL_KEEPER_CLASS_" nodeIndex="25">Cobalt Strike开启团队服务器模式需要Java环境，本机使用也需要，推荐安装Oracle java8</p><hr nodeIndex="111"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="26">先上传Cobalt Strike压缩包到服务器上，解压</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="27"><div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/1"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="28">如图所示，输入命令</p><blockquote nodeIndex="29"><pre nodeIndex="30"><code nodeIndex="112"><span nodeIndex="113">root@AliYun:~/cobaltstrike# nohup ./teamserver 你的服务器ip 你要设置的密码&</span></code></pre></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="31">这样就可以开启Cobalt Strike的团队服务模式了，并且可以后台挂载在那里</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="32">然后，本机打开Cobalt Strike，输入服务器IP、端口、密码，用户名任意设置</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="33"><div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/2"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="34">顺利的就连上了服务器，现在开始正题</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="35">拿出我们准备好的域名，修改NS记录绑定到DNSPod上</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="36"><div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/3"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="37">先添加一个域名A记录，指向我们的服务器IP</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="38">想用Cobalt Strike的DNS Beacon话，我们还需要添加两个域名的NS记录</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="39"><div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/4"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="40">注意：记录值要填写刚刚设置A记录的二级域名fuck.xxx.com，最后设置好如图所示</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="41"><div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/5"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="42">下面开始配置Cobalt Strike，生成后门</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="43"><div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/6"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="44">添加一个listener，选择第一个beacon_dns就是走DNS隧道协议，隐蔽性极强，不开任何端口。（缺点：响应速度慢）</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="45"><div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/7"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="46">配置好监听后，就开始生成后门吧</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="47"><div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/8"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="48"><div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/9"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="49">目标是32位的就默认就好，64位的就勾选下选项即可</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="50">生成好木马，就利用一些猥琐的手段放进目标机运行咯（笔者这里就直接复制进去双击了～～）</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="51"><div id="RIL_IMG_10" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/10"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="52">注意还未运行前端口开放状态</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="53"><div id="RIL_IMG_11" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/11"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="54">运行木马后，Cobalt Strike已经呈现出一个主机会话了</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="55"><div id="RIL_IMG_12" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/12"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="56">可以发现，会话延迟很高！主机的一些信息都还没反应过来！此时我们再来看看主机端口开放情况</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="57"><div id="RIL_IMG_13" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/13"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="58">与运行前并无什么差别的～</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="59">现在也有很多后门传输开始走DNS隧道了，比以往走HTTP、TCP等更难察觉，传送门http://www.freebuf.com/sectool/110815.html</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="60"><div id="RIL_IMG_14" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/14"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="61">笔者对此方式的理解如下：（错误之处，请提出一起交流学习～）</p><blockquote nodeIndex="62"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="63">木马向DNS服务器ns1.xxx.xxx发起通信——>DNS服务器ns1.xxx.xxx指向域名fuck.xxx.xxx——>域名fuck.xxx.xxx指向VPS的ip——>木马与VPS建立DNS隧道连接</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="64">VPS上的teamserver向本机Cobalt Strike返回主机会话</p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="65">后面怎么利用就是beacon>help 查看命令自己造吧～～</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="66">那么，我们试试不走DNS隧道呢？</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="67">再添加个监听，走http通道</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="68"><div id="RIL_IMG_15" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/15"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="69">重新生成个后门，运行后，返回了主机会话（速度很快）</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="70"><div id="RIL_IMG_16" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/16"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="71">此时，我们查看下目标主机端口开放情况</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="72"><div id="RIL_IMG_17" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/17"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="73">这就是走HTTP传输了，端口开放可以被探测到，但这种模式传输数据相对要快很多了</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="74"><div id="RIL_IMG_18" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/18"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="75">后面深入应用就不在此文表述了，仅为抛砖引玉～</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="76">参考： </p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="77"><span nodeIndex="114">https://blog.cobaltstrike.com/2013/06/06/dns-command-and-control-added-to-cobalt-strike/</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="78"><span nodeIndex="115">https://www.cobaltstrike.com/help-dns-beacon</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="79"><span nodeIndex="116">*原创作者：补丁君，本文属FreeBuf原创奖励计划，未经许可禁止转载</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="80"><div id="RIL_IMG_19" class="RIL_IMG"><img src="/media/posts_images/2017-02-21-1619647772/19"/></div></p></div></div></div>