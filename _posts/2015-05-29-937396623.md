---
layout: post
title: sshuttle：一个使用ssh的基于VPN的透明代理
categories:
- Pocket
tags:
---
原文地址：http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=206282760&idx=4&sn=861717bc106b36812eed90bf8dcf8b67#rd

收藏时间：2015-05-29 00:26:40

<div  ><div id="img-content" nodeIndex="5"><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="10">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">linux-cn</span>
                            </p><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="11">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">十万级技术订阅号，依托于『Linux中国』（https://linux.cn/）社区，专注于 Linux 学习、技术研究、开源思想传播。</span>
                            </p>
                                                
                
                <div class="rich_media_content " id="js_content" nodeIndex="13">
                    

                    

                    
                    
                    <p class=" _RIL_KEEPER_CLASS_" nodeIndex="14">sshuttle 允许你通过 ssh 创建一条从你电脑连接到任何远程服务器的 VPN 连接，只要你的服务器支持 python2.3 或者更高的版本。你必须有本机的 root 权限，但是你可以在服务端有普通账户即可。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="15">你可以在一台机器上同时运行多次 sshuttle 来连接到不同的服务器上，这样你就可以同时使用多个 VPN， sshuttle可以转发你子网中所有流量到VPN中。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="16"> </p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="17"><a class="target-fix" nodeIndex="157"></a></p><h3 nodeIndex="18">在Ubuntu中安装sshuttle</h3><p class=" _RIL_KEEPER_CLASS_" nodeIndex="19">在终端中输入下面的命令</p><pre class="prettyprint linenums prettyprinted" nodeIndex="20"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="22"><li nodeIndex="21"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="23"><code><span class="pln">sudo apt</span><span class="pun">-</span><span class="kwd">get</span><span class="pln"> install sshuttle</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="24"><a class="target-fix" nodeIndex="158"></a></p><h3 nodeIndex="25">使用 sshuttle</h3><p class=" _RIL_KEEPER_CLASS_" nodeIndex="26"><a class="target-fix" nodeIndex="159"></a></p><h4 nodeIndex="160">sshuttle 语法</h4><pre class="prettyprint linenums prettyprinted" nodeIndex="27"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="29"><li nodeIndex="28"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="30"><code><span class="pln">sshuttle </span><span class="pun">[</span><span class="pln">options</span><span class="pun">...]</span><span class="pln"> </span><span class="pun">[-</span><span class="pun">[</span><span class="pln">rusername@</span><span class="pun">]</span><span class="pln">sshserver</span><span class="pun">[:</span><span class="pln">port</span><span class="pun">]]</span><span class="pln"> </span><span class="pun">[</span><span class="pln">subnets</span><span class="pun">]</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="31"><a class="target-fix" nodeIndex="161"></a></p><h4 nodeIndex="162">选项细节</h4><p class=" _RIL_KEEPER_CLASS_" nodeIndex="32">-r, —remote=[username@]sshserver[:port]</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="33">远程主机名和可选的用户名，用于连接远程服务器的ssh端口号。比如example.com、testuser@example.com、testuser@example.com:2222或者example.com:2244。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="34"><a class="target-fix" nodeIndex="163"></a></p><h4 nodeIndex="164">sshuttle 例子</h4><p class=" _RIL_KEEPER_CLASS_" nodeIndex="35">在机器中使用下面的命令：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="36"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="38"><li nodeIndex="37"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="39"><code><span class="pln">sudo sshuttle </span><span class="pun">-</span><span class="pln">r username@sshserver </span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">0</span><span class="pln"> </span><span class="pun">-</span><span class="pln">vv</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="40">当开始后，sshuttle会创建一个ssh会话到由-r指定的服务器。如果-r被丢了，它会在本地运行客户端和服务端，这个有时会在测试时有用。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="41">连接到远程服务器后，sshuttle会上传它的（python）源码到远程服务器并执行。所以，你就不需要在远程服务器上安装sshuttle，并且客户端和服务器端间不会存在sshuttle版本冲突。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="42"><a class="target-fix" nodeIndex="165"></a></p><h4 nodeIndex="166">手册中的更多例子</h4><p class=" _RIL_KEEPER_CLASS_" nodeIndex="43">代理所有的本地连接用于本地测试，没有使用ssh：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="44"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="46"><li nodeIndex="45"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="47"><code><span class="pln">$ sudo sshuttle </span><span class="pun">-</span><span class="pln">v </span><span class="lit">0</span><span class="pun">/</span><span class="lit">0</span></code></p></li><li nodeIndex="48"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="49"><code></code></p></li><li nodeIndex="50"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="51"><code><span class="typ">Starting</span><span class="pln"> sshuttle proxy</span><span class="pun">.</span></code></p></li><li nodeIndex="52"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="53"><code><span class="typ">Listening</span><span class="pln"> on </span><span class="pun">(‘</span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">′,</span><span class="pln"> </span><span class="lit">12300</span><span class="pun">).</span></code></p></li><li nodeIndex="54"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="55"><code><span class="pun">[</span><span class="kwd">local</span><span class="pln"> sudo</span><span class="pun">]</span><span class="pln"> </span><span class="typ">Password</span><span class="pun">:</span></code></p></li><li nodeIndex="56"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="57"><code><span class="pln">firewall manager ready</span><span class="pun">.</span></code></p></li><li nodeIndex="58"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="59"><code><span class="pun">:</span><span class="pln">cconnecting to server</span><span class="pun">...</span></code></p></li><li nodeIndex="60"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="61"><code><span class="pun">:</span><span class="pln">savailable routes</span><span class="pun">:</span></code></p></li><li nodeIndex="62"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="63"><code><span class="pln">s</span><span class="pun">:</span><span class="pln"> </span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">42.0</span><span class="pun">/</span><span class="lit">24</span></code></p></li><li nodeIndex="64"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="65"><code><span class="pun">:</span><span class="pln">cconnected</span><span class="pun">.</span></code></p></li><li nodeIndex="66"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="67"><code><span class="pln">firewall manager</span><span class="pun">:</span><span class="pln"> starting transproxy</span><span class="pun">.</span></code></p></li><li nodeIndex="68"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="69"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> </span><span class="typ">Accept</span><span class="pun">:</span><span class="pln"> </span><span class="pun">‘</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">42.106</span><span class="str">':50035 -> ‘192.168.42.121'</span><span class="pun">:</span><span class="lit">139.</span></code></p></li><li nodeIndex="70"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="71"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> </span><span class="typ">Accept</span><span class="pun">:</span><span class="pln"> </span><span class="pun">‘</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">42.121</span><span class="str">':47523 -> ‘77.141.99.22'</span><span class="pun">:</span><span class="lit">443.</span></code></p></li><li nodeIndex="72"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="73"><code><span class="pun">...</span><span class="pln">etc</span><span class="pun">...</span></code></p></li><li nodeIndex="74"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="75"><code><span class="pun">^</span></code></p></li><li nodeIndex="76"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="77"><code><span class="pln">Cfirewall manager</span><span class="pun">:</span><span class="pln"> undoing changes</span><span class="pun">.</span></code></p></li><li nodeIndex="78"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="79"><code><span class="typ">KeyboardInterrupt</span></code></p></li><li nodeIndex="80"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="81"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> </span><span class="typ">Keyboard</span><span class="pln"> interrupt</span><span class="pun">:</span><span class="pln"> exiting</span><span class="pun">.</span></code></p></li><li nodeIndex="82"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="83"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> SW</span><span class="com">#8:192.168.42.121:47523: deleting</span></code></p></li><li nodeIndex="84"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="85"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> SW</span><span class="com">#6:192.168.42.106:50035: deleting</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="86">测试到远程服务器上的连接，自动猜测主机名和子网：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="87"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="89"><li nodeIndex="88"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="90"><code><span class="pln">$ sudo sshuttle </span><span class="pun">-</span><span class="pln">vNHr example</span><span class="pun">.</span><span class="pln">org</span></code></p></li><li nodeIndex="91"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="92"><code></code></p></li><li nodeIndex="93"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="94"><code><span class="typ">Starting</span><span class="pln"> sshuttle proxy</span><span class="pun">.</span></code></p></li><li nodeIndex="95"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="96"><code><span class="typ">Listening</span><span class="pln"> on </span><span class="pun">(‘</span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">′,</span><span class="pln"> </span><span class="lit">12300</span><span class="pun">).</span></code></p></li><li nodeIndex="97"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="98"><code><span class="pln">firewall manager ready</span><span class="pun">.</span></code></p></li><li nodeIndex="99"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="100"><code><span class="pun">:</span><span class="pln">cconnecting to server</span><span class="pun">...</span></code></p></li><li nodeIndex="101"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="102"><code><span class="pun">:</span><span class="pln">savailable routes</span><span class="pun">:</span></code></p></li><li nodeIndex="103"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="104"><code><span class="pln">s</span><span class="pun">:</span><span class="pln"> </span><span class="lit">77.141</span><span class="pun">.</span><span class="lit">99.0</span><span class="pun">/</span><span class="lit">24</span></code></p></li><li nodeIndex="105"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="106"><code><span class="pun">:</span><span class="pln">cconnected</span><span class="pun">.</span></code></p></li><li nodeIndex="107"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="108"><code><span class="pun">:</span><span class="pln">cseed_hosts</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[]</span></code></p></li><li nodeIndex="109"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="110"><code><span class="pln">firewall manager</span><span class="pun">:</span><span class="pln"> starting transproxy</span><span class="pun">.</span></code></p></li><li nodeIndex="111"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="112"><code><span class="pln">hostwatch</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Found</span><span class="pun">:</span><span class="pln"> testbox1</span><span class="pun">:</span><span class="pln"> </span><span class="lit">1.2</span><span class="pun">.</span><span class="lit">3.4</span></code></p></li><li nodeIndex="113"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="114"><code><span class="pln">hostwatch</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Found</span><span class="pun">:</span><span class="pln"> mytest2</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5.6</span><span class="pun">.</span><span class="lit">7.8</span></code></p></li><li nodeIndex="115"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="116"><code><span class="pln">hostwatch</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Found</span><span class="pun">:</span><span class="pln"> domaincontroller</span><span class="pun">:</span><span class="pln"> </span><span class="lit">99.1</span><span class="pun">.</span><span class="lit">2.3</span></code></p></li><li nodeIndex="117"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="118"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> </span><span class="typ">Accept</span><span class="pun">:</span><span class="pln"> </span><span class="pun">‘</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">42.121</span><span class="str">':60554 -> ‘77.141.99.22'</span><span class="pun">:</span><span class="lit">22.</span></code></p></li><li nodeIndex="119"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="120"><code><span class="pun">^</span></code></p></li><li nodeIndex="121"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="122"><code><span class="pln">Cfirewall manager</span><span class="pun">:</span><span class="pln"> undoing changes</span><span class="pun">.</span></code></p></li><li nodeIndex="123"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="124"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> </span><span class="typ">Keyboard</span><span class="pln"> interrupt</span><span class="pun">:</span><span class="pln"> exiting</span><span class="pun">.</span></code></p></li><li nodeIndex="125"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="126"><code><span class="pln">c </span><span class="pun">:</span><span class="pln"> SW</span><span class="com">#6:192.168.42.121:60554: deleting</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="127">via: <a nodeIndex="168">http://www.ubuntugeek.com/sshuttle-a-transparent-proxy-based-vpn-using-ssh.html</a></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="128">作者：<a nodeIndex="169">ruchi</a> 译者：<a nodeIndex="170">geekpi</a> 校对：<a nodeIndex="171">wxy</a></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="129">本文由 <a nodeIndex="172">LCTT</a> 原创翻译，<a nodeIndex="173">Linux中国</a> 荣誉推出</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="130"><div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2015-05-29-937396623/1"/></div></p></div><p class=" _RIL_KEEPER_CLASS_" nodeIndex="135">
                        
                        <a class="reward_access" id="js_reward_link" href=""><span class="icon-reward"></span><span id="js_reward_link_text">赞赏</span></a>
                        
                    </p><p class="tips_global reward_user_tips _RIL_KEEPER_CLASS_" id="js_reward_total_parent" nodeIndex="137"><a href="" id="js_reward_total"></a>人赞赏</p></div></div>