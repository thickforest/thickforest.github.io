---
layout: post
title: 开发一个 Linux 调试器（四）：Elves 和 dwarves
categories:
- Pocket
tags:
---
原文地址：http://mp.weixin.qq.com/s/6u4YSmCKzec3gK9lylq0dA

收藏时间：2017-07-25 11:19:32

<div  ><div id="img-content" nodeIndex="6"><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="11">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">linux-cn</span>
                            </p><p class="profile_meta _RIL_KEEPER_CLASS_" nodeIndex="12">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">十万级技术订阅号，依托于『Linux中国』（https://linux.cn/）社区，专注于 Linux 学习、技术研究、开源思想传播。</span>
                            </p><div class="rich_media_content " id="js_content" nodeIndex="13"><div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/1"/></div><p class=" _RIL_KEEPER_CLASS_" nodeIndex="14"><br nodeIndex="436"></p><section class="bm" nodeIndex="437"><nav class="bm_c y-scroll inner_menu" nodeIndex="439"><ul class="xl cl list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="16"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="17"><span class="folder">-</span>系列文章索引<span class="y">01%</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="19"><span class="folder">-</span>ELF 和 DWARF 简介<span class="y">06%</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="21"><span class="folder">-</span>DWARF 行表<span class="y">21%</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="23"><span class="folder">-</span>DWARF 调试信息<span class="y">34%</span></p><li nodeIndex="24"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="25"><span class="folder">-</span>当前我在哪个函数？<span class="y">58%</span></p></li><li nodeIndex="26"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="27"><span class="folder">-</span>如何在一个函数上设置断点？<span class="y">63%</span></p></li><li nodeIndex="28"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="29"><span class="folder">-</span>我如何读取一个变量的内容？<span class="y">75%</span></p></li><li nodeIndex="30"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="31"><span class="folder">-</span>休息一会<span class="y">94%</span></p></li></ul></nav></section><p class=" _RIL_KEEPER_CLASS_" nodeIndex="32"><br nodeIndex="440"></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="33">到目前为止，你已经偶尔听到了关于 dwarves、调试信息、一种无需解析就可以理解源码方式。今天我们会详细介绍源码级的调试信息，作为本指南后面部分使用它的准备。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="34">系列文章索引</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="35">随着后面文章的发布，这些链接会逐渐生效。</p><ol class=" list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="37"><li nodeIndex="36"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="38"><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484387&idx=1&sn=f135e3065c34e059ec46ecd9d906bb42&chksm=e9c4f282deb37b94613f0d26e0ab9b18f388d48c1cac0e432176a05d13f969827dcf05aeaaa4&scene=21#wechat_redirect" data-src="https://linux.cn/article-8626-1.html">准备环境</a></span><span class="sup">[1]</span></p></li><li nodeIndex="39"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="40"><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484395&idx=1&sn=90e56a3738e0477ec72e3a993edcb94a&chksm=e9c4f28adeb37b9ce2d402b14cf94e1942d5fa5a13ecc00c0461cc77eff8287752df086ce67d&scene=21#wechat_redirect" data-src="https://linux.cn/article-8645-1.html">断点</a></span><span class="sup">[2]</span></p></li><li nodeIndex="41"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="42"><span><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484405&idx=1&sn=0262c776538d1e603a9d9cfacb7b8796&chksm=e9c4f294deb37b820c253c5d72b86589959e8afc40df37be14d45bbd82486208baed2b6c9a85&scene=21#wechat_redirect" data-src="https://linux.cn/article-8663-1.html">寄存器和内存</a></span><span class="sup">[3]</span></p></li><li nodeIndex="43"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="44"><span>Elves 和 dwarves</span><span class="sup">[4]</span></p></li><li nodeIndex="45"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="46"><span>源码和信号</span><span class="sup">[5]</span></p></li><li nodeIndex="47"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="48"><span>源码级逐步执行</span><span class="sup">[6]</span></p></li><li nodeIndex="49"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="50">源码级断点</p></li><li nodeIndex="51"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="52">调用栈展开</p></li><li nodeIndex="53"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="54">读取变量</p></li><li nodeIndex="55"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="56">下一步</p></li></ol><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="57">ELF 和 DWARF 简介</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="58">ELF 和 DWARF 可能是两个你没有听说过，但可能大部分时间都在使用的组件。ELF（<span nodeIndex="441">Executable and Linkable Format</span><span class="sup" nodeIndex="442">[7]</span>，可执行和可链接格式）是 Linux 系统中使用最广泛的目标文件格式；它指定了一种存储二进制文件的所有不同部分的方式，例如代码、静态数据、调试信息以及字符串。它还告诉加载器如何加载二进制文件并准备执行，其中包括说明二进制文件不同部分在内存中应该放置的地点，哪些位需要根据其它组件的位置固定（<span nodeIndex="443">重分配</span>）以及其它。在这些博文中我不会用太多篇幅介绍 ELF，但是如果你感兴趣的话，你可以查看<span nodeIndex="444">这个很好的信息图</span><span class="sup" nodeIndex="445">[8]</span>或<span nodeIndex="446">该标准</span><span class="sup" nodeIndex="447">[9]</span>。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="59"><span nodeIndex="448">DWARF</span><span class="sup" nodeIndex="449">[10]</span>是通常和 ELF 一起使用的调试信息格式。它不一定要绑定到 ELF，但它们两者是一起发展的，一起工作得很好。这种格式允许编译器告诉调试器最初的源代码如何和被执行的二进制文件相关联。这些信息分散到不同的 ELF 部分，每个部分都衔接有一份它自己的信息。下面不同部分的定义，信息取自这个稍有过时但非常重要的 <span nodeIndex="450">DWARF 调试格式简介</span><span class="sup" nodeIndex="451">[11]</span>：</p><ul class=" list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="61"><li nodeIndex="60"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="62"><code>.debug_abbrev</code> <code>.debug_info</code> 部分使用的缩略语</p></li><li nodeIndex="63"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="64"><code>.debug_aranges</code> 内存地址和编译的映射</p></li><li nodeIndex="65"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="66"><code>.debug_frame</code> 调用帧信息</p></li><li nodeIndex="67"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="68"><code>.debug_info</code> 包括 </p><ruby>DWARF 信息条目<rt>DWARF Information Entries</rt></ruby><p class=" _RIL_KEEPER_CLASS_" nodeIndex="69">（DIEs）的核心 DWARF 数据</p></li><li nodeIndex="70"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="71"><code>.debug_line</code> 行号程序</p></li><li nodeIndex="72"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="73"><code>.debug_loc</code> 位置描述</p></li><li nodeIndex="74"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="75"><code>.debug_macinfo</code> 宏描述</p></li><li nodeIndex="76"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="77"><code>.debug_pubnames</code> 全局对象和函数查找表</p></li><li nodeIndex="78"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="79"><code>.debug_pubtypes</code> 全局类型查找表</p></li><li nodeIndex="80"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="81"><code>.debug_ranges</code> DIEs 的引用地址范围</p></li><li nodeIndex="82"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="83"><code>.debug_str</code> <code>.debug_info</code> 使用的字符串列表</p></li><li nodeIndex="84"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="85"><code>.debug_types</code> 类型描述</p></li></ul><p class=" _RIL_KEEPER_CLASS_" nodeIndex="86">我们最关心的是 <code nodeIndex="452">.debug_line</code> 和 <code nodeIndex="453">.debug_info</code> 部分，让我们来看一个简单程序的 DWARF 信息。</p><pre class="prettyprint linenums prettyprinted" nodeIndex="87"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="89"><li nodeIndex="88"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="90"><code><span class="kwd">int</span><span class="pln"> main</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></p></li><li nodeIndex="91"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="92"><code><span class="pln">    </span><span class="kwd">long</span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span></code></p></li><li nodeIndex="93"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="94"><code><span class="pln">    </span><span class="kwd">along</span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span></code></p></li><li nodeIndex="95"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="96"><code><span class="pln">    </span><span class="kwd">blong</span><span class="pln"> c </span><span class="pun">=</span><span class="pln"> a </span><span class="pun">+</span><span class="pln"> b</span><span class="pun">;</span></code></p></li><li nodeIndex="97"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="98"><code><span class="pln">    a </span><span class="pun">=</span><span class="pln"> </span><span class="lit">4</span><span class="pun">;</span></code></p></li><li nodeIndex="99"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="100"><code><span class="pun">}</span></code></p></li></ol></pre><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="101">DWARF 行表</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="102">如果你用 <code nodeIndex="454">-g</code> 选项编译这个程序，然后将结果传递给 <code nodeIndex="455">dwarfdump</code> 执行，在行号部分你应该可以看到类似这样的东西：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="103"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="105"><li nodeIndex="104"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="106"><code><span class="pun">.</span><span class="pln">debug_line</span><span class="pun">:</span><span class="pln"> line number </span><span class="kwd">info</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> a single cu</span></code></p></li><li nodeIndex="107"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="108"><code><span class="typ">Source</span><span class="pln"> lines </span><span class="pun">(</span><span class="kwd">from</span><span class="pln"> CU</span><span class="pun">-</span><span class="pln">DIE at </span><span class="pun">.</span><span class="pln">debug_info offset </span><span class="lit">0x0000000b</span><span class="pun">):</span></code></p></li><li nodeIndex="109"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="110"><code></code></p></li><li nodeIndex="111"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="112"><code><span class="pln">            NS </span><span class="kwd">new</span><span class="pln"> statement</span><span class="pun">,</span><span class="pln"> BB </span><span class="kwd">new</span><span class="pln"> basic block</span><span class="pun">,</span><span class="pln"> ET </span><span class="kwd">end</span><span class="pln"> of text sequence</span></code></p></li><li nodeIndex="113"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="114"><code><span class="pln">            PE prologue </span><span class="kwd">end</span><span class="pun">,</span><span class="pln"> EB epilogue </span><span class="kwd">begin</span></code></p></li><li nodeIndex="115"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="116"><code><span class="pln">            IS</span><span class="pun">=</span><span class="pln">val ISA number</span><span class="pun">,</span><span class="pln"> DI</span><span class="pun">=</span><span class="pln">val discriminator value</span></code></p></li><li nodeIndex="117"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="118"><code><span class="pun"><</span><span class="pln">pc</span><span class="pun">></span><span class="pln">        </span><span class="pun">[</span><span class="pln">lno</span><span class="pun">,</span><span class="pln">col</span><span class="pun">]</span><span class="pln"> NS BB ET PE EB IS</span><span class="pun">=</span><span class="pln"> DI</span><span class="pun">=</span><span class="pln"> uri</span><span class="pun">:</span><span class="pln"> </span><span class="str">"filepath"</span></code></p></li><li nodeIndex="119"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="120"><code><span class="lit">0x00400670</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">]</span><span class="pln"> NS uri</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/home/simon/play/MiniDbg/examples/variable.cpp"</span></code></p></li><li nodeIndex="121"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="122"><code><span class="lit">0x00400676</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">2</span><span class="pun">,</span><span class="lit">10</span><span class="pun">]</span><span class="pln"> NS PE</span></code></p></li><li nodeIndex="123"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="124"><code><span class="lit">0x0040067e</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">3</span><span class="pun">,</span><span class="lit">10</span><span class="pun">]</span><span class="pln"> NS</span></code></p></li><li nodeIndex="125"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="126"><code><span class="lit">0x00400686</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">4</span><span class="pun">,</span><span class="lit">14</span><span class="pun">]</span><span class="pln"> NS</span></code></p></li><li nodeIndex="127"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="128"><code><span class="lit">0x0040068a</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">4</span><span class="pun">,</span><span class="lit">16</span><span class="pun">]</span></code></p></li><li nodeIndex="129"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="130"><code><span class="lit">0x0040068e</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">4</span><span class="pun">,</span><span class="lit">10</span><span class="pun">]</span></code></p></li><li nodeIndex="131"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="132"><code><span class="lit">0x00400692</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> </span><span class="lit">7</span><span class="pun">]</span><span class="pln"> NS</span></code></p></li><li nodeIndex="133"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="134"><code><span class="lit">0x0040069a</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">]</span><span class="pln"> NS</span></code></p></li><li nodeIndex="135"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="136"><code><span class="lit">0x0040069c</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">6</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1</span><span class="pun">]</span><span class="pln"> NS ET</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="137">前面几行是一些如何理解 dump 的信息 - 主要的行号数据从以 <code nodeIndex="456">0x00400670</code> 开头的行开始。实际上这是一个代码内存地址到文件中行列号的映射。<code nodeIndex="457">NS</code> 表示地址标记一个新语句的开始，这通常用于设置断点或逐步执行。<code nodeIndex="458">PE</code> 表示函数序言（LCTT 译注：在汇编语言中，<span nodeIndex="459">function prologue</span><span class="sup" nodeIndex="460">[12]</span> 是程序开始的几行代码，用于准备函数中用到的栈和寄存器）的结束，这对于设置函数断点非常有帮助。<code nodeIndex="461">ET</code> 表示转换单元的结束。信息实际上并不像这样编码；真正的编码是一种非常节省空间的排序程序，可以通过执行它来建立这些行信息。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="138">那么，假设我们想在 <code nodeIndex="462">variable.cpp</code> 的第 4 行设置断点，我们该怎么做呢？我们查找和该文件对应的条目，然后查找对应的行条目，查找对应的地址，在那里设置一个断点。在我们的例子中，条目是：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="139"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="141"><li nodeIndex="140"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="142"><code><span class="lit">0x00400686</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">4</span><span class="pun">,</span><span class="lit">14</span><span class="pun">]</span><span class="pln"> NS</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="143">假设我们想在地址 <code nodeIndex="463">0x00400686</code> 处设置断点。如果你想尝试的话你可以在已经编写好的调试器上手动实现。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="144">反过来也是如此。如果我们已经有了一个内存地址 - 例如说，一个程序计数器值 - 想找到它在源码中的位置，我们只需要从行表信息中查找最接近的映射地址并从中抓取行号。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="145">DWARF 调试信息</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="146"><code nodeIndex="464">.debug_info</code> 部分是 DWARF 的核心。它给我们关于我们程序中存在的类型、函数、变量、希望和梦想的信息。这部分的基本单元是 DWARF 信息条目（DWARF Information Entry），我们亲切地称之为 DIEs。一个 DIE 包括能告诉你正在展现什么样的源码级实体的标签，后面跟着一系列该实体的属性。这是我上面展示的简单事例程序的 <code nodeIndex="465">.debug_info</code> 部分：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="147"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="149"><li nodeIndex="148"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="150"><code><span class="pun">.</span><span class="pln">debug_info</span></code></p></li><li nodeIndex="151"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="152"><code></code></p></li><li nodeIndex="153"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="154"><code><span class="pln">COMPILE_UNIT</span><span class="pun"><</span><span class="pln">header overall offset </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0x00000000</span><span class="pun">>:</span></code></p></li><li nodeIndex="155"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="156"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">0</span><span class="pun">><</span><span class="lit">0x0000000b</span><span class="pun">></span><span class="pln">  DW_TAG_compile_unit</span></code></p></li><li nodeIndex="157"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="158"><code><span class="pln">                    DW_AT_producer              clang version </span><span class="lit">3.9</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tags</span><span class="pun">/</span><span class="pln">RELEASE_391</span><span class="pun">/</span><span class="kwd">final</span><span class="pun">)</span></code></p></li><li nodeIndex="159"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="160"><code><span class="pln">                    DW_AT_language              DW_LANG_C_plus_plus</span></code></p></li><li nodeIndex="161"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="162"><code><span class="pln">                    DW_AT_name                  </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp</span></code></p></li><li nodeIndex="163"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="164"><code><span class="pln">                    DW_AT_stmt_list             </span><span class="lit">0x00000000</span></code></p></li><li nodeIndex="165"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="166"><code><span class="pln">                    DW_AT_comp_dir              </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">build</span></code></p></li><li nodeIndex="167"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="168"><code><span class="pln">                    DW_AT_low_pc                </span><span class="lit">0x00400670</span></code></p></li><li nodeIndex="169"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="170"><code><span class="pln">                    DW_AT_high_pc               </span><span class="lit">0x0040069c</span></code></p></li><li nodeIndex="171"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="172"><code></code></p></li><li nodeIndex="173"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="174"><code><span class="pln">LOCAL_SYMBOLS</span><span class="pun">:</span></code></p></li><li nodeIndex="175"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="176"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">1</span><span class="pun">><</span><span class="lit">0x0000002e</span><span class="pun">></span><span class="pln">    DW_TAG_subprogram</span></code></p></li><li nodeIndex="177"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="178"><code><span class="pln">                      DW_AT_low_pc                </span><span class="lit">0x00400670</span></code></p></li><li nodeIndex="179"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="180"><code><span class="pln">                      DW_AT_high_pc               </span><span class="lit">0x0040069c</span></code></p></li><li nodeIndex="181"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="182"><code><span class="pln">                      DW_AT_frame_base            DW_OP_reg6</span></code></p></li><li nodeIndex="183"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="184"><code><span class="pln">                      DW_AT_name                  main</span></code></p></li><li nodeIndex="185"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="186"><code><span class="pln">                      DW_AT_decl_file             </span><span class="lit">0x00000001</span><span class="pln"> </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp</span></code></p></li><li nodeIndex="187"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="188"><code><span class="pln">                      DW_AT_decl_line             </span><span class="lit">0x00000001</span></code></p></li><li nodeIndex="189"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="190"><code><span class="pln">                      DW_AT_type                  </span><span class="pun"><</span><span class="lit">0x00000077</span><span class="pun">></span></code></p></li><li nodeIndex="191"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="192"><code><span class="pln">                      DW_AT_external              </span><span class="kwd">yes</span><span class="pun">(</span><span class="lit">1</span><span class="pun">)</span></code></p></li><li nodeIndex="193"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="194"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">2</span><span class="pun">><</span><span class="lit">0x0000004c</span><span class="pun">></span><span class="pln">      DW_TAG_variable</span></code></p></li><li nodeIndex="195"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="196"><code><span class="pln">                        DW_AT_location              DW_OP_fbreg </span><span class="pun">-</span><span class="lit">8</span></code></p></li><li nodeIndex="197"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="198"><code><span class="pln">                        DW_AT_name                  a</span></code></p></li><li nodeIndex="199"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="200"><code><span class="pln">                        DW_AT_decl_file             </span><span class="lit">0x00000001</span><span class="pln"> </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp</span></code></p></li><li nodeIndex="201"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="202"><code><span class="pln">                        DW_AT_decl_line             </span><span class="lit">0x00000002</span></code></p></li><li nodeIndex="203"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="204"><code><span class="pln">                        DW_AT_type                  </span><span class="pun"><</span><span class="lit">0x0000007e</span><span class="pun">></span></code></p></li><li nodeIndex="205"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="206"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">2</span><span class="pun">><</span><span class="lit">0x0000005a</span><span class="pun">></span><span class="pln">      DW_TAG_variable</span></code></p></li><li nodeIndex="207"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="208"><code><span class="pln">                        DW_AT_location              DW_OP_fbreg </span><span class="pun">-</span><span class="lit">16</span></code></p></li><li nodeIndex="209"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="210"><code><span class="pln">                        DW_AT_name                  b</span></code></p></li><li nodeIndex="211"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="212"><code><span class="pln">                        DW_AT_decl_file             </span><span class="lit">0x00000001</span><span class="pln"> </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp</span></code></p></li><li nodeIndex="213"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="214"><code><span class="pln">                        DW_AT_decl_line             </span><span class="lit">0x00000003</span></code></p></li><li nodeIndex="215"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="216"><code><span class="pln">                        DW_AT_type                  </span><span class="pun"><</span><span class="lit">0x0000007e</span><span class="pun">></span></code></p></li><li nodeIndex="217"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="218"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">2</span><span class="pun">><</span><span class="lit">0x00000068</span><span class="pun">></span><span class="pln">      DW_TAG_variable</span></code></p></li><li nodeIndex="219"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="220"><code><span class="pln">                        DW_AT_location              DW_OP_fbreg </span><span class="pun">-</span><span class="lit">24</span></code></p></li><li nodeIndex="221"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="222"><code><span class="pln">                        DW_AT_name                  c</span></code></p></li><li nodeIndex="223"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="224"><code><span class="pln">                        DW_AT_decl_file             </span><span class="lit">0x00000001</span><span class="pln"> </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp</span></code></p></li><li nodeIndex="225"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="226"><code><span class="pln">                        DW_AT_decl_line             </span><span class="lit">0x00000004</span></code></p></li><li nodeIndex="227"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="228"><code><span class="pln">                        DW_AT_type                  </span><span class="pun"><</span><span class="lit">0x0000007e</span><span class="pun">></span></code></p></li><li nodeIndex="229"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="230"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">1</span><span class="pun">><</span><span class="lit">0x00000077</span><span class="pun">></span><span class="pln">    DW_TAG_base_type</span></code></p></li><li nodeIndex="231"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="232"><code><span class="pln">                      DW_AT_name                  </span><span class="kwd">int</span></code></p></li><li nodeIndex="233"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="234"><code><span class="pln">                      DW_AT_encoding              DW_ATE_signed</span></code></p></li><li nodeIndex="235"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="236"><code><span class="pln">                      DW_AT_byte_size             </span><span class="lit">0x00000004</span></code></p></li><li nodeIndex="237"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="238"><code><span class="pun"><</span><span class="pln"> </span><span class="lit">1</span><span class="pun">><</span><span class="lit">0x0000007e</span><span class="pun">></span><span class="pln">    DW_TAG_base_type</span></code></p></li><li nodeIndex="239"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="240"><code><span class="pln">                      DW_AT_name                  </span><span class="kwd">long</span><span class="pln"> </span><span class="kwd">int</span></code></p></li><li nodeIndex="241"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="242"><code><span class="pln">                      DW_AT_encoding              DW_ATE_signed</span></code></p></li><li nodeIndex="243"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="244"><code><span class="pln">                      DW_AT_byte_size             </span><span class="lit">0x00000008</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="245">第一个 DIE 表示一个编译单元（CU），实际上是一个包括了所有 <code nodeIndex="466">#includes</code> 和类似语句的源文件。下面是带含义注释的属性：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="246"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="248"><li nodeIndex="247"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="249"><code><span class="pln">DW_AT_producer   clang version </span><span class="lit">3.9</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tags</span><span class="pun">/</span><span class="pln">RELEASE_391</span><span class="pun">/</span><span class="kwd">final</span><span class="pun">)</span><span class="pln">    </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">产生该二进制文件的编译器</span></code></p></li><li nodeIndex="250"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="251"><code><span class="pln">DW_AT_language   DW_LANG_C_plus_plus                             </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">原编程语言</span></code></p></li><li nodeIndex="252"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="253"><code><span class="pln">DW_AT_name       </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">examples</span><span class="pun">/</span><span class="pln">variable</span><span class="pun">.</span><span class="pln">cpp  </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">该</span><span class="pln"> CU </span><span class="pun">表示的文件名称</span></code></p></li><li nodeIndex="254"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="255"><code><span class="pln">DW_AT_stmt_list  </span><span class="lit">0x00000000</span><span class="pln">                                      </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">跟踪该</span><span class="pln"> CU </span><span class="pun">的行表偏移</span></code></p></li><li nodeIndex="256"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="257"><code><span class="pln">DW_AT_comp_dir   </span><span class="pun">/</span><span class="kwd">super</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">path</span><span class="pun">/</span><span class="typ">MiniDbg</span><span class="pun">/</span><span class="pln">build                  </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">编译目录</span></code></p></li><li nodeIndex="258"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="259"><code><span class="pln">DW_AT_low_pc     </span><span class="lit">0x00400670</span><span class="pln">                                      </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">该</span><span class="pln"> CU </span><span class="pun">的代码起始</span></code></p></li><li nodeIndex="260"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="261"><code><span class="pln">DW_AT_high_pc    </span><span class="lit">0x0040069c</span><span class="pln">                                      </span><span class="pun"><--</span><span class="pln"> </span><span class="pun">该</span><span class="pln"> CU </span><span class="pun">的代码结尾</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="262">其它的 DIEs 遵循类似的模式，你也很可能推测出不同属性的含义。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="263">现在我们可以根据新学到的 DWARF 知识尝试和解决一些实际问题。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="264">当前我在哪个函数？</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="265">假设我们有一个程序计数器值然后想找到当前我们在哪一个函数。一个解决该问题的简单算法：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="266"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="268"><li nodeIndex="267"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="269"><code><span class="kwd">for</span><span class="pln"> each compile unit</span><span class="pun">:</span></code></p></li><li nodeIndex="270"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="271"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> the pc </span><span class="kwd">is</span><span class="pln"> between DW_AT_low_pc </span><span class="kwd">and</span><span class="pln"> DW_AT_high_pc</span><span class="pun">:</span></code></p></li><li nodeIndex="272"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="273"><code><span class="pln">        </span><span class="kwd">for</span><span class="pln"> each </span><span class="kwd">function</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> the compile unit</span><span class="pun">:</span></code></p></li><li nodeIndex="274"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="275"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> the pc </span><span class="kwd">is</span><span class="pln"> between DW_AT_low_pc </span><span class="kwd">and</span><span class="pln"> DW_AT_high_pc</span><span class="pun">:</span></code></p></li><li nodeIndex="276"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="277"><code><span class="pln">                </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> information</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="278">这对于很多目的都有效，但如果有成员函数或者内联（inline），就会变得更加复杂。假如有内联，一旦我们找到其范围包括我们的程序计数器（PC）的函数，我们需要递归遍历该 DIE 的所有孩子检查有没有内联函数能更好地匹配。在我的代码中，我不会为该调试器处理内联，但如果你想要的话你可以添加该功能。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="279">如何在一个函数上设置断点？</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="280">再次说明，这取决于你是否想要支持成员函数、命名空间以及类似的东西。对于简单的函数你只需要迭代遍历不同编译单元中的函数直到你找到一个合适的名字。如果你的编译器能够填充 <code nodeIndex="467">.debug_pubnames</code> 部分，你可以更高效地做到这点。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="281">一旦找到了函数，你可以在 <code nodeIndex="468">DW_AT_low_pc</code> 给定的内存地址设置一个断点。不过那会在函数序言处中断，但更合适的是在用户代码处中断。由于行表信息可以指定序言的结束的内存地址，你只需要在行表中查找 <code nodeIndex="469">DW_AT_low_pc</code> 的值，然后一直读取直到被标记为序言结束的条目。一些编译器不会输出这些信息，因此另一种方式是在该函数第二行条目指定的地址处设置断点。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="282">假如我们想在我们示例程序中的 <code nodeIndex="470">main</code> 函数设置断点。我们查找名为 <code nodeIndex="471">main</code> 的函数，获取到它的 DIE：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="283"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="285"><li nodeIndex="284"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="286"><code><span class="pln">< 1><0x0000002e>    DW_TAG_subprogram</span></code></p></li><li nodeIndex="287"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="288"><code><span class="pln">                      DW_AT_low_pc                0x00400670</span></code></p></li><li nodeIndex="289"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="290"><code><span class="pln">                      DW_AT_high_pc               0x0040069c</span></code></p></li><li nodeIndex="291"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="292"><code><span class="pln">                      DW_AT_frame_base            DW_OP_reg6</span></code></p></li><li nodeIndex="293"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="294"><code><span class="pln">                      DW_AT_name                  main</span></code></p></li><li nodeIndex="295"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="296"><code><span class="pln">                      DW_AT_decl_file             0x00000001 /super/secret/path/MiniDbg/examples/variable.cpp</span></code></p></li><li nodeIndex="297"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="298"><code><span class="pln">                      DW_AT_decl_line             0x00000001</span></code></p></li><li nodeIndex="299"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="300"><code><span class="pln">                      DW_AT_type                  <0x00000077></span></code></p></li><li nodeIndex="301"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="302"><code><span class="pln">                      DW_AT_external              yes(1)</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="303">这告诉我们函数从 <code nodeIndex="472">0x00400670</code> 开始。如果我们在行表中查找这个，我们可以获得条目：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="304"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="306"><li nodeIndex="305"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="307"><code><span class="lit">0x00400670</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">]</span><span class="pln"> NS uri</span><span class="pun">:</span><span class="pln"> </span><span class="str">"/super/secret/path/MiniDbg/examples/variable.cpp"</span></code></p></li><li nodeIndex="308"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="309"><code></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="310">我们希望跳过序言，因此我们再读取一个条目：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="311"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="313"><li nodeIndex="312"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="314"><code><span class="lit">0x00400676</span><span class="pln">  </span><span class="pun">[</span><span class="pln">   </span><span class="lit">2</span><span class="pun">,</span><span class="lit">10</span><span class="pun">]</span><span class="pln"> NS PE</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="315">Clang 在这个条目中包括了序言结束标记，因此我们知道在这里停止，然后在地址 <code nodeIndex="473">0x00400676</code> 处设一个断点。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="316">我如何读取一个变量的内容？</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="317">读取变量可能非常复杂。它们是难以捉摸的东西，可能在整个函数中移动、保存在寄存器中、被放置于内存、被优化掉、隐藏在角落里，等等。幸运的是我们的简单示例是真的很简单。如果我们想读取变量 <code nodeIndex="474">a</code> 的内容，我们需要看它的 <code nodeIndex="475">DW_AT_location</code> 属性：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="318"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="320"><li nodeIndex="319"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="321"><code><span class="pln">DW_AT_location              DW_OP_fbreg </span><span class="pun">-</span><span class="lit">8</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="322">这告诉我们内容被保存在以栈帧基（base of the stack frame）偏移为 <code nodeIndex="476">-8</code> 的地方。为了找到栈帧基，我们查找所在函数的 <code nodeIndex="477">DW_AT_frame_base</code> 属性。</p><pre class="prettyprint linenums prettyprinted" nodeIndex="323"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="325"><li nodeIndex="324"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="326"><code><span class="pln">DW_AT_frame_base            DW_OP_reg6</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="327">从 <span nodeIndex="478">System V x86_64 ABI</span><span class="sup" nodeIndex="479">[13]</span> 我们可以知道 <code nodeIndex="480">reg6</code> 在 x86 中是帧指针寄存器。现在我们读取帧指针的内容，从中减去 <code nodeIndex="481">8</code>，就找到了我们的变量。如果我们知道它具体是什么，我们还需要看它的类型：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="328"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="330"><li nodeIndex="329"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="331"><code><span class="pln">< 2><0x0000004c>      DW_TAG_variable</span></code></p></li><li nodeIndex="332"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="333"><code><span class="pln">                        DW_AT_name                  a</span></code></p></li><li nodeIndex="334"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="335"><code><span class="pln">                        DW_AT_type                  <0x0000007e></span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="336">如果我们在调试信息中查找该类型，我们得到下面的 DIE：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="337"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="339"><li nodeIndex="338"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="340"><code><span class="pln">< 1><0x0000007e>    DW_TAG_base_type</span></code></p></li><li nodeIndex="341"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="342"><code><span class="pln">                      DW_AT_name                  long int</span></code></p></li><li nodeIndex="343"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="344"><code><span class="pln">                      DW_AT_encoding              DW_ATE_signed</span></code></p></li><li nodeIndex="345"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="346"><code><span class="pln">                      DW_AT_byte_size             0x00000008</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="347">这告诉我们该类型是 8 字节（64 位）有符号整型，因此我们可以继续并把这些字节解析为 <code nodeIndex="482">int64_t</code> 并向用户显示。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="348">当然，类型可能比那要复杂得多，因为它们要能够表示类似 C++ 的类型，但是这能给你它们如何工作的基本认识。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="349">再次回到帧基（frame base），Clang 可以通过帧指针寄存器跟踪帧基。最近版本的 GCC 倾向于使用 <code nodeIndex="483">DW_OP_call_frame_cfa</code>，它包括解析 <code nodeIndex="484">.eh_frame</code> ELF 部分，那是一个我不会去写的另外一篇完全不同的文章。如果你告诉 GCC 使用 DWARF 2 而不是最近的版本，它会倾向于输出位置列表，这更便于阅读：</p><pre class="prettyprint linenums prettyprinted" nodeIndex="350"><ol class="linenums list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="352"><li nodeIndex="351"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="353"><code><span class="pln">DW_AT_frame_base            </span><span class="pun"><</span><span class="pln">loclist at offset </span><span class="lit">0x00000000</span><span class="pln"> </span><span class="kwd">with</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> entries follows</span><span class="pun">></span></code></p></li><li nodeIndex="354"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="355"><code><span class="pln"> low</span><span class="pun">-</span><span class="pln">off </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0x00000000</span><span class="pln"> addr  </span><span class="lit">0x00400696</span><span class="pln"> high</span><span class="pun">-</span><span class="pln">off  </span><span class="lit">0x00000001</span><span class="pln"> addr </span><span class="lit">0x00400697</span><span class="pun">></span><span class="pln">DW_OP_breg7</span><span class="pun">+</span><span class="lit">8</span></code></p></li><li nodeIndex="356"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="357"><code><span class="pln"> low</span><span class="pun">-</span><span class="pln">off </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0x00000001</span><span class="pln"> addr  </span><span class="lit">0x00400697</span><span class="pln"> high</span><span class="pun">-</span><span class="pln">off  </span><span class="lit">0x00000004</span><span class="pln"> addr </span><span class="lit">0x0040069a</span><span class="pun">></span><span class="pln">DW_OP_breg7</span><span class="pun">+</span><span class="lit">16</span></code></p></li><li nodeIndex="358"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="359"><code><span class="pln"> low</span><span class="pun">-</span><span class="pln">off </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0x00000004</span><span class="pln"> addr  </span><span class="lit">0x0040069a</span><span class="pln"> high</span><span class="pun">-</span><span class="pln">off  </span><span class="lit">0x00000031</span><span class="pln"> addr </span><span class="lit">0x004006c7</span><span class="pun">></span><span class="pln">DW_OP_breg6</span><span class="pun">+</span><span class="lit">16</span></code></p></li><li nodeIndex="360"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="361"><code><span class="pln"> low</span><span class="pun">-</span><span class="pln">off </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0x00000031</span><span class="pln"> addr  </span><span class="lit">0x004006c7</span><span class="pln"> high</span><span class="pun">-</span><span class="pln">off  </span><span class="lit">0x00000032</span><span class="pln"> addr </span><span class="lit">0x004006c8</span><span class="pun">></span><span class="pln">DW_OP_breg7</span><span class="pun">+</span><span class="lit">8</span></code></p></li></ol></pre><p class=" _RIL_KEEPER_CLASS_" nodeIndex="362">位置列表取决于程序计数器所处的位置给出不同的位置。这个例子告诉我们如果程序计数器是在 <code nodeIndex="485">DW_AT_low_pc</code> 偏移量为 <code nodeIndex="486">0x0</code> 的位置，那么帧基就在和寄存器 7 中保存的值偏移量为 8 的位置，如果它是在 <code nodeIndex="487">0x1</code> 和 <code nodeIndex="488">0x4</code> 之间，那么帧基就在和相同位置偏移量为 16 的位置，以此类推。</p><p class="h3 _RIL_KEEPER_CLASS_" nodeIndex="363">休息一会</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="364">这里有很多的信息需要你的大脑消化，但好消息是在后面的几篇文章中我们会用一个库替我们完成这些艰难的工作。理解概念仍然很有帮助，尤其是当出现错误或者你想支持一些你使用的 DWARF 库所没有实现的 DWARF 概念时。</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="365">如果你想了解更多关于 DWARF 的内容，那么你可以从<span nodeIndex="489">这里</span><span class="sup" nodeIndex="490">[14]</span>获取其标准。在写这篇博客时，刚刚发布了 DWARF 5，但更普遍支持 DWARF 4。</p><hr nodeIndex="491"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="366">via: https://blog.tartanllama.xyz/c++/2017/04/05/writing-a-linux-debugger-elf-dwarf/</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="367">作者：<span nodeIndex="492">Simon Brand</span><span class="sup" nodeIndex="493">[15]</span> 译者：<span nodeIndex="494">ictlyh</span> 校对：<span nodeIndex="495">wxy</span></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="368">本文由 <span nodeIndex="496">LCTT</span> 原创编译，<span nodeIndex="497">Linux中国</span> 荣誉推出</p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="369"><br nodeIndex="498"></p><section class="bm" nodeIndex="499"><section class="bm_h cl" nodeIndex="500">LCTT 译者</section><section class="bm_c" nodeIndex="501"><section nodeIndex="502"><div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/2"/></div><section nodeIndex="503"><section nodeIndex="504">나원호 (ictlyh)</section><section class="addfiles" nodeIndex="505">共计翻译：<span class="num" nodeIndex="506">125</span> 篇</section><section nodeIndex="507">贡献时间：817 天</section></section><br class="clear" nodeIndex="508"></section></section></section><nav class="bm" nodeIndex="509"><section class="bm_h" nodeIndex="510">相关阅读</section><nav class="y-scroll" nodeIndex="511"><cite class="show_links" rilp="1" nodeIndex="512"><ul class=" list-paddingleft-2 _RIL_KEEPER_CLASS_" nodeIndex="371"><li nodeIndex="370"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="372"><span>[1]: 准备环境 - https://linux.cn/article-8626-1.html</span></p></li><li nodeIndex="373"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="374"><span>[2]: 断点 - https://linux.cn/article-8645-1.html</span></p></li><li nodeIndex="375"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="376"><span>[3]: 寄存器和内存 - https://linux.cn/article-8663-1.html</span></p></li><li nodeIndex="377"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="378"><span>[4]: Elves 和 dwarves - https://blog.tartanllama.xyz/c++/2017/04/05/writing-a-linux-debugger-elf-dwarf/</span></p></li><li nodeIndex="379"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="380"><span>[5]: 源码和信号 - https://blog.tartanllama.xyz/c++/2017/04/24/writing-a-linux-debugger-source-signal/</span></p></li><li nodeIndex="381"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="382"><span>[6]: 源码级逐步执行 - https://blog.tartanllama.xyz/c++/2017/05/06/writing-a-linux-debugger-dwarf-step/</span></p></li><li nodeIndex="383"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="384"><span>[7]: Executable and Linkable Format - https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</span></p></li><li nodeIndex="385"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="386"><span>[8]: 这个很好的信息图 - https://github.com/corkami/pics/raw/master/binary/elf101/elf101-64.pdf</span></p></li><li nodeIndex="387"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="388"><span>[9]: 该标准 - http://www.skyfree.org/linux/references/ELF_Format.pdf</span></p></li><li nodeIndex="389"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="390"><span>[10]: DWARF - https://en.wikipedia.org/wiki/DWARF</span></p></li><li nodeIndex="391"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="392"><span>[11]: DWARF 调试格式简介 - http://www.dwarfstd.org/doc/Debugging%20using%20DWARF-2012.pdf</span></p></li><li nodeIndex="393"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="394"><span>[12]: function prologue - https://en.wikipedia.org/wiki/Function_prologue</span></p></li><li nodeIndex="395"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="396"><span>[13]: System V x86_64 ABI - https://www.uclibc.org/docs/psABI-x86_64.pdf</span></p></li><li nodeIndex="397"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="398"><span>[14]: 这里 - http://dwarfstd.org/Download.php</span></p></li><li nodeIndex="399"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="400"><span>[15]: Simon Brand - https://www.twitter.com/TartanLlama</span></p></li></ul></cite></nav></nav><section class="bm" nodeIndex="513"><section class="bm_h" nodeIndex="402"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="401">推荐文章</p></section><section class="bm_h" nodeIndex="404"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="403">< 左右滑动查看相关文章 ></p></section><section class="inner_menu x-scroll" nodeIndex="514"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=205691829&idx=1&sn=7e85de38c6bf2910b73efb2c3a9ecc53&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="515"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=411547876&idx=1&sn=7891bac4712bbed210c593691babd70f&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="516"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=2664608448&idx=1&sn=3ec3745861848ebd1a581e5e5e8add7d&chksm=bdce89868ab90090bffb27c3c19c4734e02809a9abb2ac02e434e4305a0f74a3d88637b3d18e&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="517"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=2664608602&idx=1&sn=9048bd4800fa10393f0bd7561b4eba08&chksm=bdce881c8ab9010aaa3d4a58b5e9bd5f8e47e3df777da56e7990afb9f83085e46a60b3a237dd&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="518"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=2664608937&idx=3&sn=191c5c53ab8b50bccfb7681519058260&chksm=bdce8fef8ab906f9b754b5f28623c8d7cb7726000dc9b0c7ba7902ff636c2f79aebefff64143&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="519"><div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/3"/></div></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=2664609034&idx=3&sn=c404769786058626b55f982d8eaa2605&chksm=bdce8e4c8ab9075a42031dc05abed22d8dc2c87712c4ceadf682aea669a12a23844b3fb44d87&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="520"><div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/4"/></div></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ4MjYwMQ==&mid=2664609051&idx=2&sn=f92b2fdce80c46da50aa82cb8ae6b34b&chksm=bdce8e5d8ab9074b24e6dd45dce6cc09261b53720b2408cbaf6b0ebf2f4426c3beffb2231f52&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="521"><div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/5"/></div></a><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484387&idx=1&sn=f135e3065c34e059ec46ecd9d906bb42&chksm=e9c4f282deb37b94613f0d26e0ab9b18f388d48c1cac0e432176a05d13f969827dcf05aeaaa4&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="522"><div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/6"/></div></a><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484395&idx=1&sn=90e56a3738e0477ec72e3a993edcb94a&chksm=e9c4f28adeb37b9ce2d402b14cf94e1942d5fa5a13ecc00c0461cc77eff8287752df086ce67d&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="523"><div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/7"/></div></a><a href="http://mp.weixin.qq.com/s?__biz=MzI1NDQwNDYyMg==&mid=2247484405&idx=1&sn=0262c776538d1e603a9d9cfacb7b8796&chksm=e9c4f294deb37b820c253c5d72b86589959e8afc40df37be14d45bbd82486208baed2b6c9a85&scene=21#wechat_redirect" class="ext" rel="external nofollow" target="_blank" nodeIndex="524"><div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/8"/></div></a><div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2017-07-25-1831852964/9"/></div></section><section class="bm_h" nodeIndex="406"><p class=" _RIL_KEEPER_CLASS_" nodeIndex="405">点击图片、输入文章 ID 或识别二维码直达</p></section></section><p class=" _RIL_KEEPER_CLASS_" nodeIndex="407"><br nodeIndex="525"></p><p class=" _RIL_KEEPER_CLASS_" nodeIndex="408"><br nodeIndex="526"></p>
                </div>
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" nodeIndex="409"></div>

                
                                <p class=" _RIL_KEEPER_CLASS_" nodeIndex="411">
                        <a class="reward_access" id="js_reward_link" href="">赞赏</a>
                    </p><p class="tips_global reward_user_tips _RIL_KEEPER_CLASS_" nodeIndex="413"><a href="" id="js_reward_total"></a>人赞赏</p>
                                <p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="416">长按二维码向我转账</p><p class="reward_tips _RIL_KEEPER_CLASS_" nodeIndex="417"></p><p class="tips_global _RIL_KEEPER_CLASS_" nodeIndex="418">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                                            </div>
                        
                        


                    </div>