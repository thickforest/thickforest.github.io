---
layout: post
title: SCSI标准分析及linux kernel中scsi_debug模块实现详解(1)-zhenchengjin-ChinaUnix博客
categories:
- Pocket
tags:
---
原文地址：http://blog.chinaunix.net/uid-20448327-id-3833354.html

收藏时间：2015-04-23 08:53:37

<div  lang="zh">

<p nodeIndex="195"><strong nodeIndex="293"><span nodeIndex="294">作者：</span></strong><strong nodeIndex="295"><span nodeIndex="296">casualfish</span></strong></p>
<p nodeIndex="196"><strong nodeIndex="297"><span nodeIndex="298">主页：</span></strong><span nodeIndex="299"><a href="http://hi.baidu.com/causalfish" target="_blank" nodeIndex="300"><span nodeIndex="301">http://hi.baidu.com/causalfish</span></a></span></p>
<p nodeIndex="197"><strong nodeIndex="302"><span nodeIndex="303">新浪微博：</span></strong><strong nodeIndex="304"><span nodeIndex="305">@casualfish</span></strong></p>
<p nodeIndex="198"><strong nodeIndex="306"><span nodeIndex="307">2012.11.18</span></strong></p>
<p nodeIndex="199"><strong nodeIndex="308"><span nodeIndex="309">(</span></strong><strong nodeIndex="310"><span nodeIndex="311">转载请保留此部分内容</span></strong><strong nodeIndex="312"><span nodeIndex="313">)</span></strong></p>
<p nodeIndex="200"><span nodeIndex="314">1 SCSI</span><span nodeIndex="315">标准</span><span nodeIndex="316"><span nodeIndex="317">1.1 SCSI</span><span nodeIndex="318">标准历史及组成</span></span></p>
<p nodeIndex="201"><span nodeIndex="319">SCSI</span><span nodeIndex="320">标准定义了计算机和外设进行数据传输的方式，包括传输命令、协议、电气和光物理接口特征。</span><span nodeIndex="321">SCSI</span><span nodeIndex="322">通常使用在硬盘和磁带设备中，但同时也能连接很多其他类型的设备，包括打印机、扫描仪、</span><span nodeIndex="323">CD</span><span nodeIndex="324">驱动器等等。</span></p>
<p nodeIndex="202"><span nodeIndex="325">1981</span><span nodeIndex="326">年</span><span nodeIndex="327">Shuagart</span><span nodeIndex="328">联合公司和</span><span nodeIndex="329">NCR</span><span nodeIndex="330">合作开发了</span><span nodeIndex="331">SASI(Shugart Associates System Interface)</span><span nodeIndex="332">，起初这个协议仅作为这两个公司使用的私有协议，随后为了使</span><span nodeIndex="333">SASI</span><span nodeIndex="334">能更广发的被业界接受，</span><span nodeIndex="335">SASI</span><span nodeIndex="336">进行了改善并重新命名为</span><span nodeIndex="337">SCSI</span><span nodeIndex="338">，</span><span nodeIndex="339">1986</span><span nodeIndex="340">年</span><span nodeIndex="341">ANSI</span><span nodeIndex="342">宣布</span><span nodeIndex="343">SCSI</span><span nodeIndex="344">为工业标准，这就是</span><span nodeIndex="345">SCSI-1</span><span nodeIndex="346">。</span><span nodeIndex="347">SCSI-1</span><span nodeIndex="348">只支持单端传输和被动结束，使用了</span><span nodeIndex="349">8</span><span nodeIndex="350">位总线，最高传输速率为</span><span nodeIndex="351">5MB/s</span><span nodeIndex="352">。</span></p>
<p nodeIndex="203"><span nodeIndex="353">为了解决</span><span nodeIndex="354">SCSI-1</span><span nodeIndex="355">协议的各种非标准实现引起的各种问题，</span><span nodeIndex="356">ANSI</span><span nodeIndex="357">定义和开发了</span><span nodeIndex="358">SCSI-2</span><span nodeIndex="359">。</span><span nodeIndex="360">SCSI-2</span><span nodeIndex="361">关注于提高性能和可靠性以及为</span><span nodeIndex="362">SCSI-1</span><span nodeIndex="363">增加新的功能，同时标准化了</span><span nodeIndex="364">SCSI</span><span nodeIndex="365">的命令。</span><span nodeIndex="366">ANSI</span><span nodeIndex="367">于</span><span nodeIndex="368">1994</span><span nodeIndex="369">年公布了</span><span nodeIndex="370">SCSI-2</span><span nodeIndex="371">标准：</span><span nodeIndex="372">X3.131-1994</span><span nodeIndex="373">，</span><span nodeIndex="374">SCSI-2</span><span nodeIndex="375">向下提供对</span><span nodeIndex="376">SCSI-1</span><span nodeIndex="377">的兼容。</span></p>
<p nodeIndex="204"><span nodeIndex="378">与此同时，</span><span nodeIndex="379">1993</span><span nodeIndex="380">年</span><span nodeIndex="381">ANSI</span><span nodeIndex="382">也开始进行</span><span nodeIndex="383">SCSI-3</span><span nodeIndex="384">标准的起草工作，与</span><span nodeIndex="385">SCSI-1</span><span nodeIndex="386">、</span><span nodeIndex="387">SCSI-2</span><span nodeIndex="388">不同，</span><span nodeIndex="389">SCSI-3</span><span nodeIndex="390">是由一系列相联系的标准组成，而不是一个单独的大型标准。起草完成</span><span nodeIndex="391">SCSI-1</span><span nodeIndex="392">使用了</span><span nodeIndex="393">3</span><span nodeIndex="394">年时间，大概有</span><span nodeIndex="395">200</span><span nodeIndex="396">页，而完成</span><span nodeIndex="397">SCSI-2</span><span nodeIndex="398">花费了近</span><span nodeIndex="399">8</span><span nodeIndex="400">年时间，近</span><span nodeIndex="401">600</span><span nodeIndex="402">页。</span></p>
<p nodeIndex="205"><span nodeIndex="403">SCSI-3</span><span nodeIndex="404">标准仍然在不断的改进和完善之中，</span><span nodeIndex="405">-3</span><span nodeIndex="406">实际上是</span><span nodeIndex="407">T10</span><span nodeIndex="408">委员会在起草新的</span><span nodeIndex="409">SCSI</span><span nodeIndex="410">标准中遇到了命名的问题，为了保持之前的命名规则，进而命名为</span><span nodeIndex="411">SCSI-3</span><span nodeIndex="412">标准，实际上并没有一个所谓的</span><span nodeIndex="413">SCSI-3</span><span nodeIndex="414">，</span><span nodeIndex="415">SCSI-3</span><span nodeIndex="416">就是最后的</span><span nodeIndex="417">SCSI</span><span nodeIndex="418">标准，之后的修改都是针对每个单独的标准进行修订的。现行的</span><span nodeIndex="419">SCSI-3</span><span nodeIndex="420">标准组成如图</span><span nodeIndex="421">1</span><span nodeIndex="422">所示（来自</span><span nodeIndex="423">T10</span><span nodeIndex="424">官网），图中的每个框都是一个单独的标准。这些标准中最重要的就是</span><span nodeIndex="425">SAM</span><span nodeIndex="426">（</span><span nodeIndex="427">SCSI Architecture Model</span><span nodeIndex="428">），有人称它为</span><span nodeIndex="429">“SCSI</span><span nodeIndex="430">标准的标准</span><span nodeIndex="431">”</span><span nodeIndex="432">，它定义了什么是</span><span nodeIndex="433">SCSI</span><span nodeIndex="434">标准，</span><span nodeIndex="435">SCSI</span><span nodeIndex="436">标准是由哪些部分组成的等等，它抽取了各个</span><span nodeIndex="437">SCSI</span><span nodeIndex="438">子标准中的公用部分，</span><span nodeIndex="439">SCSI</span><span nodeIndex="440">各个子标准中都会引用到</span><span nodeIndex="441">SAM</span><span nodeIndex="442">。</span></p>
<div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/1"/></div>

<p nodeIndex="208"><span nodeIndex="445">图</span><span nodeIndex="446">1 SCSI-3</span><span nodeIndex="447">标准及子标准</span></p>
<p nodeIndex="209"><span nodeIndex="448">SCSI</span><span nodeIndex="449">标准体系主要由以下三个部分组成，</span></p>
<div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/2"/></div>

<p nodeIndex="212"><span nodeIndex="452">图</span><span nodeIndex="453">2 SCSI-3</span><span nodeIndex="454">标准体系组成部分</span></p>
<ul nodeIndex="214"><li nodeIndex="213">
<p nodeIndex="215"><strong nodeIndex="455"><span nodeIndex="456">SCSI-3</span></strong><strong nodeIndex="457"><span nodeIndex="458">命令协议</span></strong></p>
</li>
</ul><p nodeIndex="216"><span nodeIndex="459">包含了对于所有设备通用的命令和对于某类设备特定的命令。图</span><span nodeIndex="460">1</span><span nodeIndex="461">中黄线上半部分都属于</span><span nodeIndex="462">SCSI</span><span nodeIndex="463">的命令协议。对于某种类型的设备，需要实现对应的命令协议，例如对于磁带设备，需要实现</span><span nodeIndex="464">SPC(SCSI Primary Commands)</span><span nodeIndex="465">，</span><span nodeIndex="466">SSC(SCSI Stream Commands)</span><span nodeIndex="467">，</span><span nodeIndex="468">SMC(SCSI Media Changer Commands)</span><span nodeIndex="469">，对于磁盘设备，则需要实现</span><span nodeIndex="470">SPC(SCSI Primary Commands)</span><span nodeIndex="471">，</span><span nodeIndex="472">SBC(SCSI Block Commands)</span><span nodeIndex="473">。</span></p>
<ul nodeIndex="218"><li nodeIndex="217">
<p nodeIndex="219"><strong nodeIndex="474"><span nodeIndex="475">传输层协议</span></strong></p>
</li>
</ul><p nodeIndex="220"><span nodeIndex="476">类似于</span><span nodeIndex="477">OSI</span><span nodeIndex="478">标准的七层协议，</span><span nodeIndex="479">SCSI</span><span nodeIndex="480">协议也定义了自己的传输层的协议，图</span><span nodeIndex="481">1</span><span nodeIndex="482">中黄线下半部分都属于</span><span nodeIndex="483">SCSI</span><span nodeIndex="484">的传输层协议，</span><span nodeIndex="485">SCSI</span><span nodeIndex="486">除了使用自己的</span><span nodeIndex="487">SCSI-3</span><span nodeIndex="488">传输层协议之外，还租借了其他的协议，例如与</span><span nodeIndex="489">FC</span><span nodeIndex="490">结合形成了</span><span nodeIndex="491">FCP</span><span nodeIndex="492">，与</span><span nodeIndex="493">IP</span><span nodeIndex="494">协议结合形成了</span><span nodeIndex="495">iSCSI</span><span nodeIndex="496">，时下最新的</span><span nodeIndex="497">SCSI over PCIE</span><span nodeIndex="498">就是</span><span nodeIndex="499">SCSI</span><span nodeIndex="500">命令与</span><span nodeIndex="501">PCIE</span><span nodeIndex="502">总线传输协议结合的产物。</span></p>
<ul nodeIndex="222"><li nodeIndex="221">
<p nodeIndex="223"><strong nodeIndex="503"><span nodeIndex="504">物理链路层协议</span></strong></p>
</li>
</ul><p nodeIndex="224"><span nodeIndex="505">传输层的每一种协议都定义了自己的电气化特征，例如</span><span nodeIndex="506">SCSI-3</span><span nodeIndex="507">使用的并口，</span><span nodeIndex="508">iSCSI</span><span nodeIndex="509">使用的千兆</span><span nodeIndex="510">/</span><span nodeIndex="511">万兆网络等等。</span></p>
<p nodeIndex="225"><span nodeIndex="512"><span nodeIndex="513">1.2 SCSI</span><span nodeIndex="514">的通信模式</span></span></p>
<p nodeIndex="226"><span nodeIndex="515">SCSI</span><span nodeIndex="516">协议采用了</span><span nodeIndex="517">Client-Server</span><span nodeIndex="518">的模式完成通信，由</span><span nodeIndex="519">Client</span><span nodeIndex="520">发送请求，</span><span nodeIndex="521">Server</span><span nodeIndex="522">完成请求并返回</span><span nodeIndex="523">Client</span><span nodeIndex="524">端状态及信息。在</span><span nodeIndex="525">SCSI</span><span nodeIndex="526">中将</span><span nodeIndex="527">Client</span><span nodeIndex="528">称为</span><span nodeIndex="529">Initiator</span><span nodeIndex="530">，</span><span nodeIndex="531">Server</span><span nodeIndex="532">端称为</span><span nodeIndex="533">Target</span><span nodeIndex="534">，每个</span><span nodeIndex="535">Target</span><span nodeIndex="536">可以有多个</span><span nodeIndex="537">LUN(Logical Unit)</span><span nodeIndex="538">，每个</span><span nodeIndex="539">LUN</span><span nodeIndex="540">处理</span><span nodeIndex="541">Initiator</span><span nodeIndex="542">发送过来的请求，实现</span><span nodeIndex="543">LUN</span><span nodeIndex="544">所属的</span><span nodeIndex="545">SCSI</span><span nodeIndex="546">子协议定义的命令，每个</span><span nodeIndex="547">LUN</span><span nodeIndex="548">包含了两个部分：</span><span nodeIndex="549">Device Server</span><span nodeIndex="550">和</span><span nodeIndex="551">Task Manager</span><span nodeIndex="552">，分别完成对于</span><span nodeIndex="553">Initiator</span><span nodeIndex="554">指定的处理和管理功能，如图</span><span nodeIndex="555">3</span><span nodeIndex="556">所示。</span></p>
<div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/3"/></div>

<p nodeIndex="229"><span nodeIndex="559">图</span><span nodeIndex="560">3 SCSI</span><span nodeIndex="561">的</span><span nodeIndex="562">Initiator-Target</span><span nodeIndex="563">通信模式</span></p>
<p nodeIndex="230"><span nodeIndex="564">SCSI</span><span nodeIndex="565">为设备之间的通信定义了端口，例如有</span><span nodeIndex="566">Initiator</span><span nodeIndex="567">端口，</span><span nodeIndex="568">Target</span><span nodeIndex="569">端口，</span><span nodeIndex="570">Initiator/Target</span><span nodeIndex="571">端口以及多端口的</span><span nodeIndex="572">Target</span><span nodeIndex="573">设备，对应的也就有</span><span nodeIndex="574">Initiator</span><span nodeIndex="575">模式，</span><span nodeIndex="576">Target</span><span nodeIndex="577">模式，</span><span nodeIndex="578">Combined</span><span nodeIndex="579">模式，多端口</span><span nodeIndex="580">target</span><span nodeIndex="581">模式等等。处于</span><span nodeIndex="582">Initiator</span><span nodeIndex="583">模式下只能发送请求和处理请求结果，处于</span><span nodeIndex="584">Target</span><span nodeIndex="585">模式下只能处理请求，</span><span nodeIndex="586">Combined</span><span nodeIndex="587">模式则可以针对相应端口的模式设置完成发起请求和处理请求。</span></p>
<p nodeIndex="231"><span nodeIndex="588">对应于</span><span nodeIndex="589">OSI</span><span nodeIndex="590">的七层标准协议，</span><span nodeIndex="591">SAM</span><span nodeIndex="592">中也规定了</span><span nodeIndex="593">SCSI</span><span nodeIndex="594">模式的对应层次，例如</span><span nodeIndex="595">SAL(SCSI Application Layer)</span><span nodeIndex="596">定义对应了</span><span nodeIndex="597">OSI</span><span nodeIndex="598">七层的上三层</span><span nodeIndex="599">(</span><span nodeIndex="600">应用层，表示层，会话层</span><span nodeIndex="601">)</span><span nodeIndex="602">，</span><span nodeIndex="603">STPL(SCSI Transport Layer)</span><span nodeIndex="604">对应了</span><span nodeIndex="605">OSI</span><span nodeIndex="606">七层的传输层，网络层，</span><span nodeIndex="607">Interconnect layer</span><span nodeIndex="608">对应了</span><span nodeIndex="609">OSI</span><span nodeIndex="610">七层中的数据链路层和物理层。</span></p>
<p nodeIndex="232"><span nodeIndex="611">SCSI</span><span nodeIndex="612">协议按照</span><span nodeIndex="613">(</span><span nodeIndex="614">控制器，通道，</span><span nodeIndex="615">SCSIID, LUNID)</span><span nodeIndex="616">的形式进行寻址，控制器指的是</span><span nodeIndex="617">Initiator</span><span nodeIndex="618">设备，通常是连接到主板设备的南桥上或者是以</span><span nodeIndex="619">PCIE</span><span nodeIndex="620">插卡的形式存在，每个</span><span nodeIndex="621">Initiator</span><span nodeIndex="622">可能有多个通道，</span><span nodeIndex="623">SCSIID</span><span nodeIndex="624">指每个通道上连接的</span><span nodeIndex="625">SCSI</span><span nodeIndex="626">设备，在窄总线（</span><span nodeIndex="627">8 bit</span><span nodeIndex="628">）中，</span><span nodeIndex="629">SCSI ID</span><span nodeIndex="630">可能为</span><span nodeIndex="631">0-7</span><span nodeIndex="632">，</span><span nodeIndex="633">SCSI ID</span><span nodeIndex="634">为</span><span nodeIndex="635">7</span><span nodeIndex="636">的设备有最高的优先级，</span><span nodeIndex="637">SCSI ID</span><span nodeIndex="638">为</span><span nodeIndex="639">0</span><span nodeIndex="640">的设备优先级最低，在宽总线（</span><span nodeIndex="641">16 bit</span><span nodeIndex="642">）中，</span><span nodeIndex="643">SCSIID</span><span nodeIndex="644">可能为</span><span nodeIndex="645">0-15</span><span nodeIndex="646">，为了保持兼容，</span><span nodeIndex="647">SCSI ID</span><span nodeIndex="648">为</span><span nodeIndex="649">7</span><span nodeIndex="650">的设备仍然有最高的优先级，因此此时连接到同一个</span><span nodeIndex="651">SCSI</span><span nodeIndex="652">总线（通道）上的设备的优先级顺序为</span><span nodeIndex="653">7</span><span nodeIndex="654">，</span><span nodeIndex="655">6</span><span nodeIndex="656">，</span><span nodeIndex="657">5</span><span nodeIndex="658">，</span><span nodeIndex="659">4</span><span nodeIndex="660">，</span><span nodeIndex="661">3</span><span nodeIndex="662">，</span><span nodeIndex="663">2</span><span nodeIndex="664">，</span><span nodeIndex="665">1</span><span nodeIndex="666">，</span><span nodeIndex="667">0</span><span nodeIndex="668">，</span><span nodeIndex="669">15</span><span nodeIndex="670">，</span><span nodeIndex="671">14</span><span nodeIndex="672">，</span><span nodeIndex="673">13</span><span nodeIndex="674">，</span><span nodeIndex="675">12</span><span nodeIndex="676">，</span><span nodeIndex="677">11</span><span nodeIndex="678">，</span><span nodeIndex="679">10</span><span nodeIndex="680">，</span><span nodeIndex="681">9</span><span nodeIndex="682">，</span><span nodeIndex="683">8</span><span nodeIndex="684">。由于每个</span><span nodeIndex="685">SCSI</span><span nodeIndex="686">设备上可能有多个</span><span nodeIndex="687">LUN</span><span nodeIndex="688">，因此需要一个单独的</span><span nodeIndex="689">LUN ID</span><span nodeIndex="690">进行标识。在</span><span nodeIndex="691">linux</span><span nodeIndex="692">下使用</span><span nodeIndex="693">lsscsi</span><span nodeIndex="694">会看到类似以下的输出：</span></p>
<p nodeIndex="233"><span nodeIndex="695">[0:0:0:1] disk Linux scsi_debug 0004 /dev/sda /dev/sg0</span></p>
<p nodeIndex="234"><span nodeIndex="696">[0:0:0:49409]wlun Linux scsi_debug 0004 - /dev/sg1</span></p>
<p nodeIndex="235"><span nodeIndex="697">开头的四元组对应的就是</span><span nodeIndex="698">[</span><span nodeIndex="699">控制器：通道：</span><span nodeIndex="700">SCSI ID</span><span nodeIndex="701">：</span><span nodeIndex="702">LUN ID]</span><span nodeIndex="703">。</span></p>
<p nodeIndex="236"><span nodeIndex="704"><span nodeIndex="705">1.3 SCSI</span><span nodeIndex="706">命令模型</span></span></p>

<div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/4"/></div>

<p nodeIndex="240"><span nodeIndex="742">图</span><span nodeIndex="743">4 CDB</span><span nodeIndex="744">结构</span></p>
<p nodeIndex="241"><span nodeIndex="745">操作码由</span><span nodeIndex="746">group code</span><span nodeIndex="747">和</span><span nodeIndex="748">command code</span><span nodeIndex="749">组成，</span><span nodeIndex="750">group code</span><span nodeIndex="751">为</span><span nodeIndex="752">cdb</span><span nodeIndex="753">的高三位，不同的数值定义如下表：</span></p>
<div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/5"/></div>

<p nodeIndex="244"><span nodeIndex="756">表</span><span nodeIndex="757">1 CDB</span><span nodeIndex="758">高三位与</span><span nodeIndex="759">CDB</span><span nodeIndex="760">长度的对应关系</span></p>
<p nodeIndex="245"><span nodeIndex="761">command code</span><span nodeIndex="762">是一个</span><span nodeIndex="763">5 bit</span><span nodeIndex="764">的标识，在每个长度的组内允许</span><span nodeIndex="765">32</span><span nodeIndex="766">种不同的命令码，一些常用的</span><span nodeIndex="767">command code</span><span nodeIndex="768">及解释如表</span><span nodeIndex="769">2</span><span nodeIndex="770">所示：</span></p>
<div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/6"/></div>

<p nodeIndex="248"><span nodeIndex="773">表</span><span nodeIndex="774">2 SCSI Command Code</span><span nodeIndex="775">示例</span></p>
<p nodeIndex="249"><span nodeIndex="776">此处列出的</span><span nodeIndex="777">command code</span><span nodeIndex="778">是</span><span nodeIndex="779">SPC</span><span nodeIndex="780">中规定的，其他的命令字段在</span><span nodeIndex="781">SCSI</span><span nodeIndex="782">子标准中规定，例如针对</span><span nodeIndex="783">block</span><span nodeIndex="784">设备的</span><span nodeIndex="785">SBC</span><span nodeIndex="786">中规定了</span><span nodeIndex="787">Force Unit Access</span><span nodeIndex="788">命令。</span></p>
<p nodeIndex="250"><span nodeIndex="789">控制域的定义如图</span><span nodeIndex="790">5</span><span nodeIndex="791">所示，其中</span><span nodeIndex="792">NACA</span><span nodeIndex="793">（</span><span nodeIndex="794">Normal Auto Contingent Allegiance</span><span nodeIndex="795">）表示在命令返回</span><span nodeIndex="796">check condition</span><span nodeIndex="797">状态时时候是否设置</span><span nodeIndex="798">ACA</span><span nodeIndex="799">标志，有些情况下一个命令的执行会以</span><span nodeIndex="800">CHECK CONDITION</span><span nodeIndex="801">状 态中止，表明在命令执行过程中出现了错误或异常。有些命令执行的错误或异常则可能导致命令组中的其他命令被异常中止，需要专门的命令对其做善后处理，并要 求存储设各在完成善后处理工作之前不再处理该用户的其他命令。为了让应用客户能够事先声明哪些命令执行的错误或异常需要善后处理，</span><span nodeIndex="802">SCSI</span><span nodeIndex="803">允许应用客户在</span><span nodeIndex="804">CDB</span> <span nodeIndex="805">的控制码中设置</span><span nodeIndex="806">NACA</span><span nodeIndex="807">位，请求设备在命令执行以</span><span nodeIndex="808">“</span><span nodeIndex="809">检查条件</span><span nodeIndex="810">”</span><span nodeIndex="811">状态中止时建立</span><span nodeIndex="812">“</span><span nodeIndex="813">自动跟随</span><span nodeIndex="814">”</span><span nodeIndex="815">条件</span><span nodeIndex="816">(Condition)</span><span nodeIndex="817">，从而允许应用客户在随后的善后处理命令中把新的</span><span nodeIndex="818">CDB</span><span nodeIndex="819">的属性设置成自动跟随</span><span nodeIndex="820">(Auto ContingentAllegiance</span><span nodeIndex="821">，</span><span nodeIndex="822">ACA)</span><span nodeIndex="823">，实际中这个功能极少使用。</span></p>
<div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/7"/></div>

<p nodeIndex="253"><span nodeIndex="826">图</span><span nodeIndex="827">5</span> <span nodeIndex="828">控制域定义</span></p>
<p nodeIndex="254"><span nodeIndex="829">link</span><span nodeIndex="830">位在实际中未使用，位</span><span nodeIndex="831">3-5</span><span nodeIndex="832">为保留位，</span><span nodeIndex="833">6-7</span><span nodeIndex="834">留给厂商自己定义。</span></p>
<p nodeIndex="255"><span nodeIndex="835">命令结束之后，</span><span nodeIndex="836">LUN</span><span nodeIndex="837">会把命令执行状态发送给应用客户，</span><span nodeIndex="838">SCSI</span><span nodeIndex="839">的状态码如图</span><span nodeIndex="840">6</span><span nodeIndex="841">所示：</span></p>
<div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/8"/></div>

<p nodeIndex="258"><span nodeIndex="844">图</span><span nodeIndex="845">6 SCSI</span><span nodeIndex="846">状态码</span></p>
<p nodeIndex="259"><span nodeIndex="847">2 linux kernel</span><span nodeIndex="848">中的</span><span nodeIndex="849">SCSI</span><span nodeIndex="850">子模块</span><span nodeIndex="851"><span nodeIndex="852">2.1 SCSI</span><span nodeIndex="853">子模块在</span><span nodeIndex="854">IO</span><span nodeIndex="855">栈中的位置</span></span></p>
<p nodeIndex="260"><span nodeIndex="856">谈到</span><span nodeIndex="857">SCSI</span><span nodeIndex="858">子模块在</span><span nodeIndex="859">IO</span><span nodeIndex="860">栈的位置时，首先需要谈到</span><span nodeIndex="861">linux kernel</span><span nodeIndex="862">中</span><span nodeIndex="863">io</span><span nodeIndex="864">栈的组成，如图</span><span nodeIndex="865">7</span><span nodeIndex="866">所示：</span></p>
<div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/9"/></div>

<p nodeIndex="263"><span nodeIndex="869">图</span><span nodeIndex="870">7 linux kernel IO</span><span nodeIndex="871">栈</span></p>
<p nodeIndex="264"><span nodeIndex="872">当用户调用了</span><span nodeIndex="873">write</span><span nodeIndex="874">、</span><span nodeIndex="875">read</span><span nodeIndex="876">等系统调用陷入内核之后，系统会首先针对关联的</span><span nodeIndex="877">file</span><span nodeIndex="878">对象找到对应的</span><span nodeIndex="879">file system</span><span nodeIndex="880">，此处针对后端是否有持久化存储可将众多的</span><span nodeIndex="881">file system</span><span nodeIndex="882">划分为两类，在此我们关心的是后端对应真实存储的</span><span nodeIndex="883">file system</span><span nodeIndex="884">，经过了</span><span nodeIndex="885">file system</span><span nodeIndex="886">层处理之后将所有的数据块划分为了一个个的</span><span nodeIndex="887">bio</span><span nodeIndex="888">，交给</span><span nodeIndex="889">device mapper</span><span nodeIndex="890">层处理，</span><span nodeIndex="891">device mapper</span><span nodeIndex="892">层主要完成逻辑设备到物理设备的映射工作，例如可以将</span><span nodeIndex="893">bio</span><span nodeIndex="894">按</span><span nodeIndex="895">LBA</span><span nodeIndex="896">地址分别映射到管理的多个设备上</span><span nodeIndex="897">(linear</span><span nodeIndex="898">，</span><span nodeIndex="899">raid0)</span><span nodeIndex="900">，将</span><span nodeIndex="901">bio</span><span nodeIndex="902">映射到每个设备上（</span><span nodeIndex="903">mirror, raid1</span><span nodeIndex="904">），或者是提供快照和多路径的功能，再往下是具体的</span><span nodeIndex="905">block</span><span nodeIndex="906">层，此处会为每个设备提供一个</span><span nodeIndex="907">queue</span><span nodeIndex="908">，在</span><span nodeIndex="909">queue</span><span nodeIndex="910">之上使用各种</span><span nodeIndex="911">io scheduler(noop/deadline/cfq)</span><span nodeIndex="912">进行请求的合并，最后调用各种不同的设备驱动完成服务。</span><span nodeIndex="913">SCSI</span><span nodeIndex="914">子模块就是这众多驱动中的一种，其他的还有按照协议和总线划分还有</span><span nodeIndex="915">USB</span><span nodeIndex="916">，</span><span nodeIndex="917">ATA</span><span nodeIndex="918">等等。</span></p>
<p nodeIndex="265"><span>到此主机的</span><span>IO</span><span>路径就结束了，但是在</span><span>SCSI</span><span>设备本身还有一系列的处理，如此长的</span><span>IO</span><span>路径会给一些数据库、</span><span>OLTP</span><span>之类的应用带来较大的延迟，因此时下正在兴起一股缩短</span><span>IO</span><span>路径的浪潮，例如将</span><span>SCSI</span><span>设备自己完成</span><span>block</span><span>层和</span><span>device mapper</span><span>层的工作，直接与</span><span>file system</span><span>相连，更有甚者仅通过</span><span>file system</span><span>管理元数据，而数据则是在通过系统调用直接操作</span><span>SCSI</span><span>设备获取和写入，如图</span><span>7</span><span>中所示。</span></p>
<p nodeIndex="266"><span nodeIndex="919"><span nodeIndex="920">2.2 SCSI</span><span nodeIndex="921">子模块的组成</span></span></p>
<p nodeIndex="267"><span>linux kernel</span><span>中</span><span>SCSI</span><span>子模块主要由三层组成，如图</span><span>8</span><span>所示，其中</span><span>upper layer</span><span>主要负责抽象出一些具体类型的设备，例如</span><span>scsi disk(sd)</span><span>、</span><span>scsi tape(st)</span><span>、</span><span>scsi cdrom(sr)</span><span>等等。</span><span>mid layer</span><span>主要负责提供一些公用的函数，连接</span><span>upper layer</span><span>和</span><span>lower layer</span><span>，此处负责</span><span>lower layer</span><span>中各种不同物理设备驱动的注册及</span><span>SCSI</span><span>相关错误处理，同时</span><span>mid layer</span><span>也负责了将上层传来的请求转译成为</span><span>SCSI</span><span>请求的工作。</span><span>lower layer</span><span>是不同物理设备的驱动层，因此这层的代码也最多，包括了</span><span>QLogic</span><span>，</span><span>Emulex</span><span>，</span><span>LSI</span><span>等等厂家的驱动，</span><span>lower layer</span><span>中使用了</span><span>mid layer</span><span>提供的回调函数用以通知请求的完成。</span></p>
<div id="RIL_IMG_10" class="RIL_IMG"><img src="/media/posts_images/2015-04-23-904787940/10"/></div>

<p nodeIndex="270"><span nodeIndex="924">图</span><span nodeIndex="925">8 linux kernel</span><span nodeIndex="926">中</span><span nodeIndex="927">scsi</span><span nodeIndex="928">子模块的三层</span></p>
</div>