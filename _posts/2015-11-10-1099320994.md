---
layout: post
title: Linux 0.11 在ubuntu-11和gcc-4.6.1下编译调试至正常运行的过程详解
categories:
- Pocket
tags:
---
原文地址：http://m.blog.chinaunix.net/uid-23917107-id-3173253.html

收藏时间：2015-11-10 09:49:07

<div  lang="zh">

<p class="MsoListParagraph" nodeIndex="12"><span nodeIndex="534"><span nodeIndex="535"><span lang="EN-US" nodeIndex="536"><span nodeIndex="537">1、 </span></span><span nodeIndex="538">工作背景</span></span></span></p>
<p class="MsoNormal" nodeIndex="13"><span nodeIndex="539"><span nodeIndex="540"><span nodeIndex="541">研究</span></span></span><span nodeIndex="542"><span nodeIndex="543"><span lang="EN-US" nodeIndex="544">linux</span></span></span><span nodeIndex="545"><span nodeIndex="546"><span lang="EN-US" nodeIndex="547">-</span></span></span><span nodeIndex="548"><span nodeIndex="549"><span lang="EN-US" nodeIndex="550">0.11</span></span></span><span nodeIndex="460"><span nodeIndex="551"><span nodeIndex="552">已有月余，代码看了好几遍，虽然能看懂，却总感觉如隔靴搔痒一般。这当然是正常的，毕竟不是自己写的东西，毕竟这是个操作系统。但若能亲自修改并调试一番，对其的理解就能更加深刻了。然而在</span></span></span><span nodeIndex="553"><span nodeIndex="554"><span lang="EN-US" nodeIndex="555">linux-0.11</span></span></span><span nodeIndex="556"><span nodeIndex="557"><span nodeIndex="558">的编译要在装有</span></span></span><span nodeIndex="559"><span nodeIndex="560"><span lang="EN-US" nodeIndex="561">gcc1.4</span></span></span><span nodeIndex="461"><span><span>的系统里进行，那个系统太老了，修改起来也不方便，又没法安装源码阅读器</span></span></span><span nodeIndex="562"><span nodeIndex="563"><span lang="EN-US" nodeIndex="564">. . .</span></span></span> <span nodeIndex="565"><span nodeIndex="566"><span nodeIndex="567">那能不能在</span></span></span><span nodeIndex="568"><span nodeIndex="569"><span lang="EN-US" nodeIndex="570">ubuntu</span></span></span><span nodeIndex="571"><span nodeIndex="572"><span nodeIndex="573">下用高版本的</span></span></span><span nodeIndex="574"><span nodeIndex="575"><span lang="EN-US" nodeIndex="576">gcc</span></span></span><span nodeIndex="577"><span nodeIndex="578"><span nodeIndex="579">编译并运行呢？</span></span></span></p>
<p class="MsoListParagraph" nodeIndex="14"><span nodeIndex="580"><span nodeIndex="581"><span lang="EN-US" nodeIndex="582"><span nodeIndex="583">2、 </span></span><span nodeIndex="584">工作意义</span></span></span></p>
<p class="MsoNormal" nodeIndex="15"><span nodeIndex="585"><span nodeIndex="586"><span nodeIndex="587">简单讲下本文所描述工作以及撰写本文的意义吧。</span></span></span></p>
<p class="MsoNormal" nodeIndex="16"><span nodeIndex="588"><span nodeIndex="589"><span lang="EN-US" nodeIndex="590">Linux-0.11</span></span></span><span nodeIndex="591"><span nodeIndex="592"><span nodeIndex="593">在高版本</span></span></span><span nodeIndex="594"><span nodeIndex="595"><span lang="EN-US" nodeIndex="596">gcc-4.6.11</span></span></span><span nodeIndex="597"><span nodeIndex="598"><span nodeIndex="599">下编译调试并能正常运行可以使学习</span></span></span><span nodeIndex="600"><span nodeIndex="601"><span lang="EN-US" nodeIndex="602">linux-0.11</span></span></span><span nodeIndex="603"><span nodeIndex="604"><span nodeIndex="605">更加方便、容易，也为进一步研究</span></span></span><span nodeIndex="606"><span nodeIndex="607"><span lang="EN-US" nodeIndex="608">linux2.6</span></span></span><span nodeIndex="609"><span nodeIndex="610"><span nodeIndex="611">奠定基础。更加重要的是，本项工作的过程其实就是一个深入学习的过程，对了解新旧版本</span></span></span><span nodeIndex="612"><span nodeIndex="613"><span lang="EN-US" nodeIndex="614">gcc</span></span></span><span nodeIndex="615"><span nodeIndex="616"><span nodeIndex="617">之间的差异、</span></span></span><span nodeIndex="618"><span nodeIndex="619"><span lang="EN-US" nodeIndex="620">linux</span></span></span><span nodeIndex="621"><span nodeIndex="622"><span nodeIndex="623">内核运行机制、</span></span></span><span nodeIndex="624"><span nodeIndex="625"><span lang="EN-US" nodeIndex="626">linux</span></span></span><span nodeIndex="627"><span nodeIndex="628"><span nodeIndex="629">调试方法有很大帮助。另外，对于</span></span></span><span nodeIndex="630"><span nodeIndex="631"><span lang="EN-US" nodeIndex="632">linux-0.11</span></span></span><span nodeIndex="633"><span nodeIndex="634"><span nodeIndex="635">在高版本</span></span></span><span nodeIndex="636"><span nodeIndex="637"><span lang="EN-US" nodeIndex="638">gcc</span></span></span><span nodeIndex="462"><span><span>下的编译工作，网上已有不少先驱者，但大都没能让编译过后的</span></span></span><span nodeIndex="639"><span nodeIndex="640"><span lang="EN-US" nodeIndex="641">os</span></span></span><span nodeIndex="463"><span><span>正常运行起来，偶有高人完成，也未能提供足够的调试材料，这让不少初学者对此失去了兴趣。现在有兴趣于此的大哥mm们</span></span></span><span nodeIndex="642"><span nodeIndex="643"><span lang="EN-US" nodeIndex="644">High</span></span></span><span nodeIndex="645"><span nodeIndex="646"><span nodeIndex="647">起来吧！</span></span></span></p>
<p class="MsoNormal" nodeIndex="17"><span nodeIndex="648"><span nodeIndex="649"><span nodeIndex="650">当然这项工作在很多人眼里并没多重要，他们认为它一没有科研创新价值，而没有商业盈利价值，还耗费不少时间，他们有更重要的事情去做。这个浮躁的社会里，人们做什么事情总要讲究足够的理由。对此我只能说，你们是没错的。</span></span></span></p>
<p class="MsoNormal" nodeIndex="18"><span nodeIndex="651"><span nodeIndex="652"><span nodeIndex="653">然我道中人终究还有不少，撰写本文也是希望跟我相同想法的人能从中获得他们需要的帮助，并借此与他们互相勉励一下。有句老话怎么说来着？重要的不是目的地，而是沿途的风景。</span></span></span></p>
<p class="MsoNormal" nodeIndex="19"><span><span><span>当然若有高人前辈路过，愿意批评指正的，望不吝赐教，我将不甚感激涕零。</span></span></span></p>
<p class="MsoNormal" nodeIndex="20"><span nodeIndex="654"><span nodeIndex="655"><span lang="EN-US" nodeIndex="656">3</span></span></span><span nodeIndex="657"><span nodeIndex="658"><span nodeIndex="659">、工作目的：</span></span></span></p>
<p class="MsoNormal" nodeIndex="21"><span nodeIndex="660"><span nodeIndex="661"><span nodeIndex="662">本文工作的目的在</span></span></span><span nodeIndex="663"><span nodeIndex="664"><span lang="EN-US" nodeIndex="665">ubuntu-11</span></span></span><span nodeIndex="666"><span nodeIndex="667"><span nodeIndex="668">中使用</span></span></span><span nodeIndex="669"><span nodeIndex="670"><span lang="EN-US" nodeIndex="671">gcc-4.61</span></span></span><span nodeIndex="672"><span nodeIndex="673"><span nodeIndex="674">成功编译</span></span></span><span nodeIndex="675"><span nodeIndex="676"><span lang="EN-US" nodeIndex="677">linux-0.11</span></span></span><span nodeIndex="464"><span><span>源码，并经过调试使之能正常运行。由于时间关系，并未解决系统中所有存在的</span></span></span><span nodeIndex="678"><span nodeIndex="679"><span lang="EN-US" nodeIndex="680">bug</span></span></span><span nodeIndex="465"><span><span>，十分遗憾，若有大哥mm们愿继续完成，我将非常高兴。虽如此，拥有了在这个过程中学到的这些东西，我的工作已有足够的意义。本文的特点是图文并茂，对错误原因解释详细，关键地方有对</span></span></span><span nodeIndex="681"><span nodeIndex="682"><span lang="EN-US" nodeIndex="683">linux</span></span></span><span nodeIndex="684"><span nodeIndex="685"><span nodeIndex="686">一些机制的阐述，尽量减少读者的理解障碍。</span></span></span></p>
<p class="MsoNormal" nodeIndex="22"><span nodeIndex="687"><span nodeIndex="688"><span nodeIndex="689">代码包来源：赵炯博士网站</span></span></span><span nodeIndex="690"><span nodeIndex="691"><span lang="EN-US" nodeIndex="692">http://oldlinux.org/Linux.old</span></span></span><span nodeIndex="693"><span nodeIndex="694"><span nodeIndex="695">中下载</span></span></span><span nodeIndex="696"><span nodeIndex="697"><span lang="EN-US" nodeIndex="698">bochs</span></span></span><span nodeIndex="699"><span nodeIndex="700"><span nodeIndex="701">安装文件、</span></span></span><span nodeIndex="702"><span nodeIndex="703"><span lang="EN-US" nodeIndex="704">linux-0.11.tar.Z</span></span></span><span nodeIndex="705"><span nodeIndex="706"><span nodeIndex="707">源码包、</span></span></span><span nodeIndex="708"><span nodeIndex="709"><span lang="EN-US" nodeIndex="710">linux-0.11-devel-040923.zip</span></span></span><span nodeIndex="711"><span nodeIndex="712"><span nodeIndex="713">源码包（该源码在</span></span></span><span nodeIndex="714"><span nodeIndex="715"><span lang="EN-US" nodeIndex="716">gcc1.4</span></span></span><span nodeIndex="717"><span nodeIndex="718"><span nodeIndex="719">下编译通过，作为对照使用）。</span></span></span></p>
<p class="MsoNormal" nodeIndex="23"><span nodeIndex="720"><span nodeIndex="721"><span nodeIndex="722">平台搭建：我使用的环境是</span></span></span><span nodeIndex="723"><span nodeIndex="724"><span lang="EN-US" nodeIndex="725">VirtualBox</span></span></span><span nodeIndex="726"><span nodeIndex="727"><span nodeIndex="728">中安装</span></span></span><span nodeIndex="729"><span nodeIndex="730"><span lang="EN-US" nodeIndex="731">ubuntu-11</span></span></span><span nodeIndex="732"><span nodeIndex="733"><span nodeIndex="734">，与</span></span></span><span nodeIndex="735"><span nodeIndex="736"><span lang="EN-US" nodeIndex="737">win7</span></span></span><span nodeIndex="738"><span nodeIndex="739"><span nodeIndex="740">共享工作文件夹（其中存有</span></span></span><span nodeIndex="741"><span nodeIndex="742"><span lang="EN-US" nodeIndex="743">linux-0.11</span></span></span><span nodeIndex="744"><span nodeIndex="745"><span nodeIndex="746">源码），</span></span></span><span nodeIndex="747"><span nodeIndex="748"><span lang="EN-US" nodeIndex="749">win7</span></span></span><span nodeIndex="750"><span nodeIndex="751"><span nodeIndex="752">中使用</span></span></span><span nodeIndex="753"><span nodeIndex="754"><span lang="EN-US" nodeIndex="755">editplus</span></span></span><span nodeIndex="756"><span nodeIndex="757"><span nodeIndex="758">和</span></span></span><span nodeIndex="759"><span nodeIndex="760"><span lang="EN-US" nodeIndex="761">source insight</span></span></span><span nodeIndex="762"><span nodeIndex="763"><span nodeIndex="764">进行源码的编辑和阅读。</span></span></span></p>

<p class="MsoNormal" nodeIndex="25"><span nodeIndex="765"><span nodeIndex="766"><b nodeIndex="767"><span nodeIndex="768">一、编译过程</span></b></span></span></p>
<p class="MsoNormal" nodeIndex="26"><span nodeIndex="769"><span nodeIndex="770"><span nodeIndex="771">对</span></span></span><span nodeIndex="772"><span nodeIndex="773"><span lang="EN-US" nodeIndex="774">linux-0.11</span></span></span><span nodeIndex="775"><span nodeIndex="776"><span nodeIndex="777">在高版本</span></span></span><span nodeIndex="778"><span nodeIndex="779"><span lang="EN-US" nodeIndex="780">gcc</span></span></span><span nodeIndex="466"><span><span>下的编译过程，网上也有一些散碎材料，赵炯博士的论坛里和《</span></span></span><span nodeIndex="781"><span nodeIndex="782"><span lang="EN-US" nodeIndex="783">linux</span></span></span><span nodeIndex="467"><span><span>内核完全剖析》中也有一部分介绍。本节依据先后顺序将编译过程中每个错误的解决方法依次完整地罗列出来。</span></span></span></p>
<p class="MsoNormal" nodeIndex="27"><span nodeIndex="784"><span nodeIndex="785"><span lang="EN-US" nodeIndex="786">1</span></span></span><span nodeIndex="787"><span nodeIndex="788"><span nodeIndex="789">、除错工具：</span></span></span></p>
<p class="MsoNormal" nodeIndex="28"><span nodeIndex="790"><span nodeIndex="791"><span nodeIndex="792">（</span></span></span><span nodeIndex="793"><span nodeIndex="794"><span lang="EN-US" nodeIndex="795">1</span></span></span><span nodeIndex="796"><span nodeIndex="797"><span nodeIndex="798">）</span></span></span><span nodeIndex="799"><span nodeIndex="800"><span lang="EN-US" nodeIndex="801">sourceInsight</span></span></span><span nodeIndex="468"><span><span>，源码阅读器肯定需要了，否则岂不是找崩溃吗？</span></span></span></p>
<p class="MsoNormal" nodeIndex="29"><span nodeIndex="802"><span nodeIndex="803"><span nodeIndex="804">（</span></span></span><span nodeIndex="805"><span nodeIndex="806"><span lang="EN-US" nodeIndex="807">2</span></span></span><span nodeIndex="808"><span nodeIndex="809"><span nodeIndex="810">）</span></span></span><span nodeIndex="811"><span nodeIndex="812"><span lang="EN-US" nodeIndex="813">internet</span></span></span><span nodeIndex="469"><span><span>，编译过程网上有不少人完成了，赵炯博士也完成了，对于一些问题可以查到相应资料。</span></span></span></p>
<p class="MsoNormal" nodeIndex="30"><span nodeIndex="814"><span nodeIndex="815"><span nodeIndex="816">（</span></span></span><span nodeIndex="817"><span nodeIndex="818"><span lang="EN-US" nodeIndex="819">3</span></span></span><span nodeIndex="820"><span nodeIndex="821"><span nodeIndex="822">）</span></span></span><span nodeIndex="823"><span nodeIndex="824"><span lang="EN-US" nodeIndex="825">editplus</span></span></span><span nodeIndex="826"><span nodeIndex="827"><span nodeIndex="828">，这是个编辑器了，我用之多年，比较喜欢，其特点就是小但功能全。</span></span></span></p>
<p class="MsoNormal" nodeIndex="31"><span nodeIndex="829"><span nodeIndex="830"><span lang="EN-US" nodeIndex="831">2</span></span></span><span nodeIndex="832"><span nodeIndex="833"><span nodeIndex="834">、问题及解决方法</span></span></span></p>
<p class="MsoNormal" nodeIndex="32"><span nodeIndex="835"><span nodeIndex="836"><span nodeIndex="837">问题</span></span></span><span nodeIndex="838"><span nodeIndex="839"><span lang="EN-US" nodeIndex="840">1</span></span></span><span nodeIndex="841"><span nodeIndex="842"><span nodeIndex="843">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="33"><span nodeIndex="844"><span nodeIndex="845"><span nodeIndex="846">第一次</span></span></span><span nodeIndex="847"><span nodeIndex="848"><span lang="EN-US" nodeIndex="849">make</span></span></span><span nodeIndex="850"><span nodeIndex="851"><span nodeIndex="852">会出现如图</span></span></span><span nodeIndex="853"><span nodeIndex="854"><span lang="EN-US" nodeIndex="855">1.1</span></span></span><span nodeIndex="856"><span nodeIndex="857"><span nodeIndex="858">所示的问题。</span></span></span></p>

<div id="RIL_IMG_1" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/1"/></div>
<p class="MsoNormal" nodeIndex="36"><span nodeIndex="862"><span nodeIndex="863"><span nodeIndex="864">图</span></span></span><span nodeIndex="865"><span nodeIndex="866"><span lang="EN-US" nodeIndex="867">1.1</span></span></span></p>

<p class="MsoNormal" nodeIndex="38"><span nodeIndex="868"><span nodeIndex="869"><span nodeIndex="870">这是注释方式问题</span></span></span> <span nodeIndex="871"><span nodeIndex="872"><span nodeIndex="873">，</span></span></span><span nodeIndex="874"><span nodeIndex="875"><span lang="EN-US" nodeIndex="876">as86</span></span></span><span nodeIndex="877"><span nodeIndex="878"><span nodeIndex="879">不支持</span></span></span><span nodeIndex="880"><span nodeIndex="881"><span lang="EN-US" nodeIndex="882">/**/</span></span></span><span nodeIndex="883"><span nodeIndex="884"><span nodeIndex="885">，改为每行前面用</span></span></span><span nodeIndex="886"><span nodeIndex="887"><span lang="EN-US" nodeIndex="888">!</span></span></span><span nodeIndex="889"><span nodeIndex="890"><span nodeIndex="891">注释。</span></span></span></p>
<p class="MsoNormal" nodeIndex="39"><span nodeIndex="892"><span nodeIndex="893"><span nodeIndex="894">问题</span></span></span><span nodeIndex="895"><span nodeIndex="896"><span lang="EN-US" nodeIndex="897">2</span></span></span><span nodeIndex="898"><span nodeIndex="899"><span nodeIndex="900">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="40"><span nodeIndex="901"><span nodeIndex="902"><span nodeIndex="903">再次</span></span></span><span nodeIndex="904"><span nodeIndex="905"><span lang="EN-US" nodeIndex="906">make</span></span></span><span nodeIndex="907"><span nodeIndex="908"><span nodeIndex="909">后出现如图</span></span></span><span nodeIndex="910"><span nodeIndex="911"><span lang="EN-US" nodeIndex="912">1.2</span></span></span><span nodeIndex="913"><span nodeIndex="914"><span nodeIndex="915">所示的错误。</span></span></span></p>

<div id="RIL_IMG_2" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/2"/></div>
<p class="MsoNormal" nodeIndex="43"><span nodeIndex="919"><span nodeIndex="920"><span nodeIndex="921">图</span></span></span><span nodeIndex="922"><span nodeIndex="923"><span lang="EN-US" nodeIndex="924">1.2</span></span></span></p>

<p class="MsoNormal" nodeIndex="45"><span nodeIndex="925"><span nodeIndex="926"><span nodeIndex="927">修改所有</span></span></span><span nodeIndex="928"><span nodeIndex="929"><span lang="EN-US" nodeIndex="930">makefile</span></span></span><span nodeIndex="931"><span nodeIndex="932"><span nodeIndex="933">文件的编译器修改一下，将</span></span></span><span nodeIndex="934"><span nodeIndex="935"><span lang="EN-US" nodeIndex="936">gas,gld</span></span></span><span nodeIndex="937"><span nodeIndex="938"><span nodeIndex="939">改成</span></span></span><span nodeIndex="940"><span nodeIndex="941"><span lang="EN-US" nodeIndex="942">as</span></span></span><span nodeIndex="943"><span nodeIndex="944"><span nodeIndex="945">和</span></span></span><span nodeIndex="946"><span nodeIndex="947"><span lang="EN-US" nodeIndex="948">ld</span></span></span><span nodeIndex="949"><span nodeIndex="950"><span nodeIndex="951">，所有</span></span></span><span nodeIndex="952"><span nodeIndex="953"><span lang="EN-US" nodeIndex="954">AS</span></span></span><span nodeIndex="955"><span nodeIndex="956"><span nodeIndex="957">的选项参数去掉</span></span></span><span nodeIndex="958"><span nodeIndex="959"><span lang="EN-US" nodeIndex="960">-c</span></span></span><span nodeIndex="961"><span nodeIndex="962"><span nodeIndex="963">（</span></span></span><span nodeIndex="964"><span nodeIndex="965"><span lang="EN-US" nodeIndex="966">as</span></span></span><span nodeIndex="967"><span nodeIndex="968"><span nodeIndex="969">不用这个选项），</span></span></span><span nodeIndex="970"><span nodeIndex="971"><span lang="EN-US" nodeIndex="972">gcc</span></span></span><span nodeIndex="973"><span nodeIndex="974"><span nodeIndex="975">的选项参数去掉</span></span></span><span nodeIndex="976"><span nodeIndex="977"><span lang="EN-US" nodeIndex="978">-fcombine-regs -mstring-insns</span></span></span><span nodeIndex="979"><span nodeIndex="980"><span nodeIndex="981">（这两个参数现在的</span></span></span><span nodeIndex="982"><span nodeIndex="983"><span lang="EN-US" nodeIndex="984">gcc</span></span></span><span nodeIndex="985"><span nodeIndex="986"><span nodeIndex="987">不支持了）。</span></span></span></p>
<p class="MsoNormal" nodeIndex="46"><span nodeIndex="988"><span nodeIndex="989"><span nodeIndex="990">问题</span></span></span><span nodeIndex="991"><span nodeIndex="992"><span lang="EN-US" nodeIndex="993">3</span></span></span><span nodeIndex="994"><span nodeIndex="995"><span nodeIndex="996">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="47"><span nodeIndex="997"><span nodeIndex="998"><span nodeIndex="999">接着又出现如图</span></span></span><span nodeIndex="1000"><span nodeIndex="1001"><span lang="EN-US" nodeIndex="1002">1.3</span></span></span><span nodeIndex="1003"><span nodeIndex="1004"><span nodeIndex="1005">所示的编译错误。</span></span></span></p>


<p class="MsoNormal" nodeIndex="50"><span nodeIndex="1011"><span nodeIndex="1012"><span nodeIndex="1013">图</span></span></span><span nodeIndex="1014"><span nodeIndex="1015"><span lang="EN-US" nodeIndex="1016">1.3</span></span></span></p>

<p class="MsoNormal" nodeIndex="52"><span nodeIndex="1017"><span nodeIndex="1018"><span nodeIndex="1019">这是新旧版本</span></span></span><span nodeIndex="1020"><span nodeIndex="1021"><span lang="EN-US" nodeIndex="1022">gcc</span></span></span><span nodeIndex="1023"><span nodeIndex="1024"><span nodeIndex="1025">对齐的表达方式不同所造成的，</span></span></span><span nodeIndex="1026"><span nodeIndex="1027"><span lang="EN-US" nodeIndex="1028">.align n n</span></span></span><span nodeIndex="1029"><span nodeIndex="1030"><span nodeIndex="1031">改为</span></span></span> <span nodeIndex="1032"><span nodeIndex="1033"><span lang="EN-US" nodeIndex="1034">2<sup nodeIndex="1035">n</sup></span></span></span><span nodeIndex="1036"><span nodeIndex="1037"><span nodeIndex="1038">便可。</span></span></span></p>
<p class="MsoNormal" nodeIndex="53"><span nodeIndex="1039"><span nodeIndex="1040"><span nodeIndex="1041">问题</span></span></span><span nodeIndex="1042"><span nodeIndex="1043"><span lang="EN-US" nodeIndex="1044">4</span></span></span><span nodeIndex="1045"><span nodeIndex="1046"><span nodeIndex="1047">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="54"><span nodeIndex="1048"><span nodeIndex="1049"><span nodeIndex="1050">接着又出现如图</span></span></span><span nodeIndex="1051"><span nodeIndex="1052"><span lang="EN-US" nodeIndex="1053">1.4</span></span></span><span nodeIndex="1054"><span nodeIndex="1055"><span nodeIndex="1056">所示的编译错误。</span></span></span></p>

<div id="RIL_IMG_3" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/3"/></div>
<p class="MsoNormal" nodeIndex="57"><span nodeIndex="1060"><span nodeIndex="1061"><span nodeIndex="1062">图</span></span></span><span nodeIndex="1063"><span nodeIndex="1064"><span lang="EN-US" nodeIndex="1065">1.4</span></span></span></p>
<p class="MsoNormal" nodeIndex="58"><span nodeIndex="1066"><span nodeIndex="1067"><span nodeIndex="1068">上面的错误只有</span></span></span><span nodeIndex="1069"><span nodeIndex="1070"><span lang="EN-US" nodeIndex="1071">static declaration of ‘pause’ follows non-static declaration</span></span></span><span nodeIndex="1072"><span nodeIndex="1073"><span nodeIndex="1074">这类是必须修改的，查看</span></span></span><span nodeIndex="1075"><span nodeIndex="1076"><span lang="EN-US" nodeIndex="1077">main.c</span></span></span><span nodeIndex="1078"><span nodeIndex="1079"><span nodeIndex="1080">和</span></span></span><span nodeIndex="1081"><span nodeIndex="1082"><span lang="EN-US" nodeIndex="1083">unistd.h</span></span></span><span nodeIndex="1084"><span nodeIndex="1085"><span nodeIndex="1086">发现产生错误的原因：</span></span></span></p>
<p class="MsoNormal" nodeIndex="59"><span nodeIndex="1087"><span nodeIndex="1088"><span lang="EN-US" nodeIndex="1089">Main.c</span></span></span><span nodeIndex="1090"><span nodeIndex="1091"><span nodeIndex="1092">中有如图</span></span></span><span nodeIndex="1093"><span nodeIndex="1094"><span lang="EN-US" nodeIndex="1095">1.5</span></span></span><span nodeIndex="1096"><span nodeIndex="1097"><span nodeIndex="1098">所示的语句：</span></span></span></p>

<div id="RIL_IMG_4" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/4"/></div>
<p class="MsoNormal" nodeIndex="62"><span nodeIndex="1104"><span nodeIndex="1105"><span nodeIndex="1106">图</span></span></span><span nodeIndex="1107"><span nodeIndex="1108"><span lang="EN-US" nodeIndex="1109">1.5</span></span></span></p>
<p class="MsoNormal" nodeIndex="63"><span nodeIndex="1110"><span nodeIndex="1111"><span nodeIndex="1112">而</span></span></span><a name="OLE_LINK2" nodeIndex="1113"></a><a name="OLE_LINK1" nodeIndex="1114"><span nodeIndex="1115"><span nodeIndex="1116"><span nodeIndex="1117"><span lang="EN-US" nodeIndex="1118">unistd.h</span></span></span></span></a><span nodeIndex="1119"><span nodeIndex="1120"><span nodeIndex="1121">文件中有图</span></span></span><span nodeIndex="1122"><span nodeIndex="1123"><span lang="EN-US" nodeIndex="1124">1.6</span></span></span><span nodeIndex="1125"><span nodeIndex="1126"><span nodeIndex="1127">所示的声明语句：</span></span></span></p>

<div id="RIL_IMG_5" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/5"/></div>
<p class="MsoNormal" nodeIndex="66"><span nodeIndex="1133"><span nodeIndex="1134"><span nodeIndex="1135">图</span></span></span><span nodeIndex="1136"><span nodeIndex="1137"><span lang="EN-US" nodeIndex="1138">1.6</span></span></span></p>
<p class="MsoNormal" nodeIndex="67"><span nodeIndex="1139"><span nodeIndex="1140"><span lang="EN-US" nodeIndex="1141">Main.c</span></span></span><span nodeIndex="1142"><span nodeIndex="1143"><span nodeIndex="1144">头部包含了</span></span></span><span nodeIndex="1145"><span nodeIndex="1146"><span lang="EN-US" nodeIndex="1147">unistd.h</span></span></span><span nodeIndex="1148"><span nodeIndex="1149"><span nodeIndex="1150">，那么关于</span></span></span><span nodeIndex="1151"><span nodeIndex="1152"><span lang="EN-US" nodeIndex="1153">fork</span></span></span><span nodeIndex="1154"><span nodeIndex="1155"><span nodeIndex="1156">、</span></span></span><span nodeIndex="1157"><span nodeIndex="1158"><span lang="EN-US" nodeIndex="1159">pause</span></span></span><span nodeIndex="1160"><span nodeIndex="1161"><span nodeIndex="1162">、</span></span></span><span nodeIndex="1163"><span nodeIndex="1164"><span lang="EN-US" nodeIndex="1165">sync</span></span></span><span nodeIndex="1166"><span nodeIndex="1167"><span nodeIndex="1168">系统调用的声明就重复了<span nodeIndex="1169">，不知道为什么旧版本的</span></span></span></span><span nodeIndex="1170"><span nodeIndex="1171"><span lang="EN-US" nodeIndex="1172">gcc</span></span></span><span nodeIndex="1173"><span nodeIndex="1174"><span nodeIndex="1175">可以编译通过，需要详查，</span></span></span><span nodeIndex="1176"><span nodeIndex="1177"><span nodeIndex="1178">在</span></span></span><span nodeIndex="1179"><span nodeIndex="1180"><span lang="EN-US" nodeIndex="1181">main.c</span></span></span><span nodeIndex="1182"><span nodeIndex="1183"><span nodeIndex="1184">中增加这些函数的内联声明的原因是</span></span></span><span nodeIndex="1185"><span nodeIndex="1186"><span lang="EN-US" nodeIndex="1187">linux-0.11</span></span></span><span nodeIndex="1188"><span nodeIndex="1189"><span nodeIndex="1190">的进程</span></span></span><span nodeIndex="1191"><span nodeIndex="1192"><span lang="EN-US" nodeIndex="1193">0</span></span></span><span nodeIndex="1194"><span nodeIndex="1195"><span nodeIndex="1196">和</span></span></span><span nodeIndex="1197"><span nodeIndex="1198"><span lang="EN-US" nodeIndex="1199">1</span></span></span><span nodeIndex="1200"><span nodeIndex="1201"><span nodeIndex="1202">共用一个栈，进程</span></span></span><span nodeIndex="1203"><span nodeIndex="1204"><span lang="EN-US" nodeIndex="1205">0</span></span></span><span nodeIndex="1206"><span nodeIndex="1207"><span nodeIndex="1208">在创建了进程</span></span></span><span nodeIndex="1209"><span nodeIndex="1210"><span lang="EN-US" nodeIndex="1211">1</span></span></span><span nodeIndex="1212"><span nodeIndex="1213"><span nodeIndex="1214">后只有等待</span></span></span><span nodeIndex="1215"><span nodeIndex="1216"><span lang="EN-US" nodeIndex="1217">pause</span></span></span><span nodeIndex="1218"><span nodeIndex="1219"><span nodeIndex="1220">的功能，为了避免进程</span></span></span><span nodeIndex="1221"><span nodeIndex="1222"><span lang="EN-US" nodeIndex="1223">1</span></span></span><span nodeIndex="1224"><span nodeIndex="1225"><span nodeIndex="1226">栈中数据被破坏，</span></span></span> <span nodeIndex="1227"><span nodeIndex="1228"><span nodeIndex="1229">进程</span></span></span><span nodeIndex="1230"><span nodeIndex="1231"><span lang="EN-US" nodeIndex="1232">0</span></span></span><span nodeIndex="1233"><span nodeIndex="1234"><span nodeIndex="1235">不可使用栈，那么就不可使用</span></span></span><span nodeIndex="1236"><span nodeIndex="1237"><span lang="EN-US" nodeIndex="1238">call</span></span></span><span nodeIndex="1239"><span nodeIndex="1240"><span nodeIndex="1241">来调用</span></span></span><span nodeIndex="1242"><span nodeIndex="1243"><span lang="EN-US" nodeIndex="1244">fork</span></span></span><span nodeIndex="1245"><span nodeIndex="1246"><span nodeIndex="1247">和</span></span></span><span nodeIndex="1248"><span nodeIndex="1249"><span lang="EN-US" nodeIndex="1250">pause</span></span></span><span nodeIndex="470"><span><span>库函数，而应该用内联的方法，防止参数传递将栈搞乱。</span></span></span></p>
<p class="MsoNormal" nodeIndex="68"><span nodeIndex="1251"><span nodeIndex="1252"><span nodeIndex="1253">修改这个问题的方法可以利用条件宏的预处理作用来进行。在</span></span></span><span nodeIndex="1254"><span nodeIndex="1255"><span lang="EN-US" nodeIndex="1256">main.c</span></span></span><span nodeIndex="1257"><span nodeIndex="1258"><span nodeIndex="1259">开始包含</span></span></span><span nodeIndex="1260"><span nodeIndex="1261"><span lang="EN-US" nodeIndex="1262">#define _IN_MAIN</span></span></span><span nodeIndex="1263"><span nodeIndex="1264"><span nodeIndex="1265">，而</span></span></span><span nodeIndex="1266"><span nodeIndex="1267"><span lang="EN-US" nodeIndex="1268">unistd.h</span></span></span><span nodeIndex="1269"><span nodeIndex="1270"><span nodeIndex="1271">中的声明做如图</span></span></span><span nodeIndex="1272"><span nodeIndex="1273"><span lang="EN-US" nodeIndex="1274">1.7</span></span></span><span nodeIndex="1275"><span nodeIndex="1276"><span nodeIndex="1277">所示修改即可。</span></span></span></p>

<div id="RIL_IMG_6" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/6"/></div>
<p class="MsoNormal" nodeIndex="71"><span nodeIndex="1283"><span nodeIndex="1284"><span nodeIndex="1285">图</span></span></span><span nodeIndex="1286"><span nodeIndex="1287"><span lang="EN-US" nodeIndex="1288">1.7</span></span></span></p>
<p class="MsoNormal" nodeIndex="72"><span nodeIndex="1289"><span nodeIndex="1290"><span nodeIndex="1291">问题</span></span></span><span nodeIndex="1292"><span nodeIndex="1293"><span lang="EN-US" nodeIndex="1294">5</span></span></span><span nodeIndex="1295"><span nodeIndex="1296"><span nodeIndex="1297">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="73"><span nodeIndex="1298"><span nodeIndex="1299"><span lang="EN-US" nodeIndex="1300">Make</span></span></span><span nodeIndex="1301"><span nodeIndex="1302"><span nodeIndex="1303">后又发现如图</span></span></span><span nodeIndex="1304"><span nodeIndex="1305"><span lang="EN-US" nodeIndex="1306">1.8</span></span></span><span nodeIndex="1307"><span nodeIndex="1308"><span nodeIndex="1309">所示的错误。</span></span></span></p>

<div id="RIL_IMG_7" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/7"/></div>
<p class="MsoNormal" nodeIndex="76"><span nodeIndex="1313"><span nodeIndex="1314"><span nodeIndex="1315">图</span></span></span><span nodeIndex="1316"><span nodeIndex="1317"><span lang="EN-US" nodeIndex="1318">1.8</span></span></span></p>
<p class="MsoNormal" nodeIndex="77"><span nodeIndex="471"><span><span>这是编译器对嵌入式汇编已用过的寄存器声明无效的报错信息。查看源文件发现问题出现在</span></span></span><span nodeIndex="1319"><span nodeIndex="1320"><span lang="EN-US" nodeIndex="1321">_set_base</span></span></span><span nodeIndex="1322"><span nodeIndex="1323"><span nodeIndex="1324">宏这里。</span></span></span></p>
<p class="MsoNormal" nodeIndex="78"><span nodeIndex="1325"><span nodeIndex="1326"><span nodeIndex="1327">在</span></span></span> <span nodeIndex="1328"><span nodeIndex="1329"><span lang="EN-US" nodeIndex="1330">include/linux/sched.h</span></span></span><span nodeIndex="1331"><span nodeIndex="1332"><span nodeIndex="1333">中，有如下语句：</span></span></span><span nodeIndex="1334"><span nodeIndex="1335"><span lang="EN-US" nodeIndex="1336"> <br nodeIndex="1337">
188 #define <a name="OLE_LINK4" nodeIndex="1338"></a><a name="OLE_LINK3" nodeIndex="1339"><span nodeIndex="1340">_set_base</span></a>(addr,base) \ <br nodeIndex="1341">
189 __asm__("movw %%dx,%0\n\t" \ <br nodeIndex="1342">
190 "rorl $16,%%edx\n\t" \ <br nodeIndex="1343">
191 "movb %%dl,%1\n\t" \ <br nodeIndex="1344">
192 "movb %%dh,%2" \ <br nodeIndex="1345">
193 ::"m" (*((addr)+2)), \ <br nodeIndex="1346">
194 "m" (*((addr)+4)), \ <br nodeIndex="1347">
195 "m" (*((addr)+7)), \ <br nodeIndex="1348">
196 "d" (base) \ <br nodeIndex="1349">
197 :"dx") <span nodeIndex="1350">//</span></span></span></span><span nodeIndex="1351"><span nodeIndex="1352"><span nodeIndex="1353">无效声明</span></span></span></p>
<p class="MsoNormal" nodeIndex="79"><span nodeIndex="1354"><span nodeIndex="1355"><span nodeIndex="1356">去掉</span></span></span><span nodeIndex="1357"><span nodeIndex="1358"><span lang="EN-US" nodeIndex="1359">197</span></span></span><span nodeIndex="1360"><span nodeIndex="1361"><span nodeIndex="1362">行中的</span></span></span><span nodeIndex="1363"><span nodeIndex="1364"><span lang="EN-US" nodeIndex="1365">:"dx"</span></span></span><span nodeIndex="1366"><span nodeIndex="1367"><span nodeIndex="1368">这项。也即</span></span></span><span nodeIndex="1369"><span nodeIndex="1370"><span lang="EN-US" nodeIndex="1371">197</span></span></span><span nodeIndex="1372"><span nodeIndex="1373"><span nodeIndex="1374">行变成了：</span></span></span></p>
<p class="MsoNormal" nodeIndex="80"><span nodeIndex="1375"><span nodeIndex="1376"><span lang="EN-US" nodeIndex="1377">197 )</span></span></span></p>
<p class="MsoNormal" nodeIndex="81"><span nodeIndex="1378"><span nodeIndex="1379"><span nodeIndex="1380">然后去掉所有汇编中的类似的地方：</span></span></span><span nodeIndex="1381"><span nodeIndex="1382"><span lang="EN-US" nodeIndex="1383">String.h,memory.c,buffer.c,super.c</span></span></span><span nodeIndex="1384"><span nodeIndex="1385"><span nodeIndex="1386">（原因是</span></span></span><span nodeIndex="1387"><span nodeIndex="1388"><span lang="EN-US" nodeIndex="1389">Bitmap.c</span></span></span><span nodeIndex="1390"><span nodeIndex="1391"><span nodeIndex="1392">）。</span></span></span></p>
<p class="MsoNormal" nodeIndex="82"><span nodeIndex="1393"><span nodeIndex="1394"><span nodeIndex="1395">这是由于</span></span></span><span nodeIndex="1396"><span nodeIndex="1397"><span lang="EN-US" nodeIndex="1398">as</span></span></span><span nodeIndex="472"><span><span>不断改进，目前自动化程度越来越高，不用人工指定一个变量需要的寄存器了，所以代码中的</span></span></span> <span nodeIndex="1399"><span nodeIndex="1400"><span lang="EN-US" nodeIndex="1401">__asm__("ax")</span></span></span><span nodeIndex="1402"><span nodeIndex="1403"><span nodeIndex="1404">需要全部去掉。如</span></span></span><span nodeIndex="1405"><span nodeIndex="1406"><span lang="EN-US" nodeIndex="1407">bitmap.c</span></span></span><span nodeIndex="1408"><span nodeIndex="1409"><span nodeIndex="1410">和</span></span></span><span nodeIndex="1411"><span nodeIndex="1412"><span lang="EN-US" nodeIndex="1413">namei.c</span></span></span><span nodeIndex="1414"><span nodeIndex="1415"><span nodeIndex="1416">。</span></span></span></p>
<p class="MsoNormal" nodeIndex="83"><span nodeIndex="1417"><span nodeIndex="1418"><span nodeIndex="1419">问题</span></span></span><span nodeIndex="1420"><span nodeIndex="1421"><span lang="EN-US" nodeIndex="1422">6</span></span></span><span nodeIndex="1423"><span nodeIndex="1424"><span nodeIndex="1425">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="84"><span nodeIndex="1426"><span nodeIndex="1427"><span lang="EN-US" nodeIndex="1428">Make</span></span></span><span nodeIndex="1429"><span nodeIndex="1430"><span nodeIndex="1431">后又发现如图</span></span></span><span nodeIndex="1432"><span nodeIndex="1433"><span lang="EN-US" nodeIndex="1434">1.9</span></span></span><span nodeIndex="1435"><span nodeIndex="1436"><span nodeIndex="1437">所示的错误。</span></span></span></p>

<div id="RIL_IMG_8" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/8"/></div>
<p class="MsoNormal" nodeIndex="87"><span nodeIndex="1443"><span nodeIndex="1444"><span nodeIndex="1445">图</span></span></span><span nodeIndex="1446"><span nodeIndex="1447"><span lang="EN-US" nodeIndex="1448">1.9</span></span></span></p>
<p class="MsoNormal" nodeIndex="88"><span nodeIndex="1449"><span nodeIndex="1450"><span nodeIndex="1451">查看</span></span></span><span nodeIndex="1452"><span nodeIndex="1453"><span lang="EN-US" nodeIndex="1454">segment.h</span></span></span> <span nodeIndex="1455"><span nodeIndex="1456"><span nodeIndex="1457">有如图</span></span></span><span nodeIndex="1458"><span nodeIndex="1459"><span lang="EN-US" nodeIndex="1460">1.10</span></span></span><span nodeIndex="1461"><span nodeIndex="1462"><span nodeIndex="1463">所示代码。</span></span></span></p>


<p class="MsoNormal" nodeIndex="91"><span nodeIndex="1469"><span nodeIndex="1470"><span nodeIndex="1471">图</span></span></span><span nodeIndex="1472"><span nodeIndex="1473"><span lang="EN-US" nodeIndex="1474">1.10</span></span></span></p>
<p class="MsoNormal" nodeIndex="92"><span nodeIndex="1475"><span nodeIndex="1476"><span nodeIndex="1477">将</span></span></span><span nodeIndex="1478"><span nodeIndex="1479"><span lang="EN-US" nodeIndex="1480">r</span></span></span><span nodeIndex="1481"><span nodeIndex="1482"><span nodeIndex="1483">改为</span></span></span><span nodeIndex="1484"><span nodeIndex="1485"><span lang="EN-US" nodeIndex="1486">q</span></span></span><span nodeIndex="1487"><span nodeIndex="1488"><span nodeIndex="1489">，该问题就解决了。</span></span></span><span nodeIndex="1490"><span nodeIndex="1491"><span lang="EN-US" nodeIndex="1492">r</span></span></span><span nodeIndex="1493"><span nodeIndex="1494"><span nodeIndex="1495">表示使用任意动态分配的寄存器，</span></span></span><span nodeIndex="1496"><span nodeIndex="1497"><span lang="EN-US" nodeIndex="1498">q</span></span></span><span nodeIndex="1499"><span nodeIndex="1500"><span nodeIndex="1501">表示使用动态分配字节可寻址寄存器（</span></span></span><span nodeIndex="1502"><span nodeIndex="1503"><span lang="EN-US" nodeIndex="1504">eax,ebx,ecx</span></span></span><span nodeIndex="1505"><span nodeIndex="1506"><span nodeIndex="1507">或</span></span></span><span nodeIndex="1508"><span nodeIndex="1509"><span lang="EN-US" nodeIndex="1510">edx</span></span></span><span nodeIndex="1511"><span nodeIndex="1512"><span nodeIndex="1513">）。</span></span></span></p>
<p class="MsoNormal" nodeIndex="93"><span nodeIndex="1514"><span nodeIndex="1515"><span nodeIndex="1516">问题</span></span></span><span nodeIndex="1517"><span nodeIndex="1518"><span lang="EN-US" nodeIndex="1519">7</span></span></span><span nodeIndex="1520"><span nodeIndex="1521"><span nodeIndex="1522">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="94"><span nodeIndex="1523"><span nodeIndex="1524"><span lang="EN-US" nodeIndex="1525">Make</span></span></span><span nodeIndex="1526"><span nodeIndex="1527"><span nodeIndex="1528">后又发现如图</span></span></span><span nodeIndex="1529"><span nodeIndex="1530"><span lang="EN-US" nodeIndex="1531">1.11</span></span></span><span nodeIndex="1532"><span nodeIndex="1533"><span nodeIndex="1534">所示的错误。</span></span></span></p>


<p class="MsoNormal" nodeIndex="97"><span nodeIndex="1540"><span nodeIndex="1541"><span nodeIndex="1542">图</span></span></span><span nodeIndex="1543"><span nodeIndex="1544"><span lang="EN-US" nodeIndex="1545">1.11</span></span></span></p>
<p class="MsoNormal" nodeIndex="98"><span nodeIndex="1546"><span nodeIndex="1547"><span nodeIndex="1548">这是个左值问题，查看</span></span></span><span nodeIndex="1549"><span nodeIndex="1550"><span lang="EN-US" nodeIndex="1551">exec.c</span></span></span><span nodeIndex="1552"><span nodeIndex="1553"><span nodeIndex="1554">源码如图</span></span></span><span nodeIndex="1555"><span nodeIndex="1556"><span lang="EN-US" nodeIndex="1557">1.12</span></span></span><span nodeIndex="1558"><span nodeIndex="1559"><span nodeIndex="1560">所示：</span></span></span></p>


<p class="MsoNormal" nodeIndex="101"><span nodeIndex="1566"><span nodeIndex="1567"><span nodeIndex="1568">图</span></span></span><span nodeIndex="1569"><span nodeIndex="1570"><span lang="EN-US" nodeIndex="1571">1.12</span></span></span></p>
<p class="MsoNormal" nodeIndex="102"><span nodeIndex="1572"><span nodeIndex="1573"><span nodeIndex="1574">这个写法确实有些别扭，使用</span></span></span><span nodeIndex="1575"><span nodeIndex="1576"><span lang="EN-US" nodeIndex="1577">get_free_page()</span></span></span><span nodeIndex="1578"><span nodeIndex="1579"><span nodeIndex="1580">申请新页面，页面指针</span></span></span><span nodeIndex="1581"><span nodeIndex="1582"><span lang="EN-US" nodeIndex="1583">pag</span></span></span><span nodeIndex="1584"><span nodeIndex="1585"><span nodeIndex="1586">指向新页面，申请不到空闲页面则返回</span></span></span><span nodeIndex="1587"><span nodeIndex="1588"><span lang="EN-US" nodeIndex="1589">0</span></span></span><span nodeIndex="1590"><span nodeIndex="1591"><span nodeIndex="1592">。如图</span></span></span><span nodeIndex="1593"><span nodeIndex="1594"><span lang="EN-US" nodeIndex="1595">1.13</span></span></span><span nodeIndex="1596"><span nodeIndex="1597"><span nodeIndex="1598">修改便可。</span></span></span></p>

<div id="RIL_IMG_9" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/9"/></div>
<p class="MsoNormal" nodeIndex="105"><span nodeIndex="1602"><span nodeIndex="1603"><span nodeIndex="1604">图</span></span></span><span nodeIndex="1605"><span nodeIndex="1606"><span lang="EN-US" nodeIndex="1607">1.13</span></span></span></p>

<p class="MsoNormal" nodeIndex="107"><span nodeIndex="1608"><span nodeIndex="1609"><span nodeIndex="1610">类似问题在</span></span></span><span nodeIndex="1611"><span nodeIndex="1612"><span lang="EN-US" nodeIndex="1613">malloc.c</span></span></span><span nodeIndex="1614"><span nodeIndex="1615"><span nodeIndex="1616">中也有。</span></span></span></p>
<p class="MsoNormal" nodeIndex="108"><span nodeIndex="1617"><span nodeIndex="1618"><span nodeIndex="1619">问题</span></span></span><span nodeIndex="1620"><span nodeIndex="1621"><span lang="EN-US" nodeIndex="1622">8</span></span></span><span nodeIndex="1623"><span nodeIndex="1624"><span nodeIndex="1625">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="109"><span nodeIndex="1626"><span nodeIndex="1627"><span lang="EN-US" nodeIndex="1628">Make</span></span></span><span nodeIndex="1629"><span nodeIndex="1630"><span nodeIndex="1631">后又发现如图</span></span></span><span nodeIndex="1632"><span nodeIndex="1633"><span lang="EN-US" nodeIndex="1634">1.14</span></span></span><span nodeIndex="1635"><span nodeIndex="1636"><span nodeIndex="1637">所示的错误。</span></span></span></p>


<p class="MsoNormal" nodeIndex="112"><span nodeIndex="1643"><span nodeIndex="1644"><span nodeIndex="1645">图</span></span></span><span nodeIndex="1646"><span nodeIndex="1647"><span lang="EN-US" nodeIndex="1648">1.14</span></span></span></p>
<p class="MsoNormal" nodeIndex="113"><span nodeIndex="1649"><span nodeIndex="1650"><span nodeIndex="1651">查看代码</span></span></span><span nodeIndex="1652"><span nodeIndex="1653"><span lang="EN-US" nodeIndex="1654">blk.h</span></span></span><span nodeIndex="1655"><span nodeIndex="1656"><span nodeIndex="1657">发现是</span></span></span><a name="OLE_LINK6" nodeIndex="1658"></a><a name="OLE_LINK5" nodeIndex="1659"><span nodeIndex="1660"><span nodeIndex="1661"><span nodeIndex="1662"><span lang="EN-US" nodeIndex="1663">#elif</span></span></span></span></a><span nodeIndex="1664"><span nodeIndex="1665"><span nodeIndex="1666">木有判断的逻辑表达式，改为</span></span></span><span nodeIndex="1667"><span nodeIndex="1668"><span lang="EN-US" nodeIndex="1669">#elif 1</span></span></span><span nodeIndex="1670"><span nodeIndex="1671"><span nodeIndex="1672">便可。</span></span></span></p>
<p class="MsoNormal" nodeIndex="114"><span nodeIndex="1673"><span nodeIndex="1674"><span nodeIndex="1675">问题</span></span></span><span nodeIndex="1676"><span nodeIndex="1677"><span lang="EN-US" nodeIndex="1678">9</span></span></span><span nodeIndex="1679"><span nodeIndex="1680"><span nodeIndex="1681">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="115"><span nodeIndex="1682"><span nodeIndex="1683"><span lang="EN-US" nodeIndex="1684">Make</span></span></span><span nodeIndex="1685"><span nodeIndex="1686"><span nodeIndex="1687">后又发现如图</span></span></span><span nodeIndex="1688"><span nodeIndex="1689"><span lang="EN-US" nodeIndex="1690">1.15</span></span></span><span nodeIndex="1691"><span nodeIndex="1692"><span nodeIndex="1693">所示的错误。</span></span></span></p>

<div id="RIL_IMG_10" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/10"/></div>
<p class="MsoNormal" nodeIndex="118"><span nodeIndex="1697"><span nodeIndex="1698"><span nodeIndex="1699">图</span></span></span><span nodeIndex="1700"><span nodeIndex="1701"><span lang="EN-US" nodeIndex="1702">1.15</span></span></span></p>
<p class="MsoNormal" nodeIndex="119"><span nodeIndex="473"><span><span>这个问题不懂怎么改，按照之间类似问题将第三个冒号后面的寄存器删掉也不行，<span>求指点。</span>这里我果断把所有汇编注释掉，因为</span></span></span><span nodeIndex="1703"><span nodeIndex="1704"><span lang="EN-US" nodeIndex="1705">strtok</span></span></span><span nodeIndex="1706"><span nodeIndex="1707"><span nodeIndex="1708">这个函数在内核中没有被调用。</span></span></span></p>
<p class="MsoNormal" nodeIndex="120"><span nodeIndex="1709"><span nodeIndex="1710"><span nodeIndex="1711">至此，编译问题全部解决。</span></span></span></p>
<p class="MsoNormal" nodeIndex="121"><span nodeIndex="1712"><span nodeIndex="1713"><b nodeIndex="1714"><span nodeIndex="1715">二、链接过程</span></b></span></span></p>
<p class="MsoNormal" nodeIndex="122"><span nodeIndex="1716"><span nodeIndex="1717"><span nodeIndex="1718">编译通过了，但请别高兴太早，因为链接过程中遇到的问题一点也不少。</span></span></span></p>
<p class="MsoNormal" nodeIndex="123"><span nodeIndex="1719"><span nodeIndex="1720"><span lang="EN-US" nodeIndex="1721">1</span></span></span><span nodeIndex="1722"><span nodeIndex="1723"><span nodeIndex="1724">、除错工具：</span></span></span></p>
<p class="MsoNormal" nodeIndex="124"><span nodeIndex="1725"><span nodeIndex="1726"><span nodeIndex="1727">（</span></span></span><span nodeIndex="1728"><span nodeIndex="1729"><span lang="EN-US" nodeIndex="1730">1</span></span></span><span nodeIndex="1731"><span nodeIndex="1732"><span nodeIndex="1733">）</span></span></span><span nodeIndex="1734"><span nodeIndex="1735"><span lang="EN-US" nodeIndex="1736">sourceInsight</span></span></span><span nodeIndex="474"><span><span>，源码阅读器肯定需要了，否则岂不是找崩溃吗？</span></span></span></p>
<p class="MsoNormal" nodeIndex="125"><span nodeIndex="1737"><span nodeIndex="1738"><span nodeIndex="1739">（</span></span></span><span nodeIndex="1740"><span nodeIndex="1741"><span lang="EN-US" nodeIndex="1742">2</span></span></span><span nodeIndex="1743"><span nodeIndex="1744"><span nodeIndex="1745">）</span></span></span><span nodeIndex="1746"><span nodeIndex="1747"><span lang="EN-US" nodeIndex="1748">internet</span></span></span><span nodeIndex="475"><span><span>，链接过程网上有不少人完成了，赵炯博士也完成了，对于一些问题可以查到相应资料。</span></span></span></p>
<p class="MsoNormal" nodeIndex="126"><span nodeIndex="1749"><span nodeIndex="1750"><span nodeIndex="1751">（</span></span></span><span nodeIndex="1752"><span nodeIndex="1753"><span lang="EN-US" nodeIndex="1754">3</span></span></span><span nodeIndex="1755"><span nodeIndex="1756"><span nodeIndex="1757">）</span></span></span><span nodeIndex="1758"><span nodeIndex="1759"><span lang="EN-US" nodeIndex="1760">editplus</span></span></span><span nodeIndex="1761"><span nodeIndex="1762"><span nodeIndex="1763">，这是个编辑器了，我用之多年，比较喜欢，其特点就是小但功能全。</span></span></span></p>
<p class="MsoNormal" nodeIndex="127"><span nodeIndex="1764"><span nodeIndex="1765"><span lang="EN-US" nodeIndex="1766">2</span></span></span><span nodeIndex="1767"><span nodeIndex="1768"><span nodeIndex="1769">、问题及解决方法</span></span></span></p>
<p class="MsoNormal" nodeIndex="128"><span nodeIndex="1770"><span nodeIndex="1771"><span nodeIndex="1772">问题</span></span></span><span nodeIndex="1773"><span nodeIndex="1774"><span lang="EN-US" nodeIndex="1775">1</span></span></span><span nodeIndex="1776"><span nodeIndex="1777"><span nodeIndex="1778">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="129"><span nodeIndex="1779"><span nodeIndex="1780"><span nodeIndex="1781">链接错误中，程序入口问题首当其冲。错误信息如图</span></span></span><span nodeIndex="1782"><span nodeIndex="1783"><span lang="EN-US" nodeIndex="1784">2.1</span></span></span><span nodeIndex="1785"><span nodeIndex="1786"><span nodeIndex="1787">所示。</span></span></span></p>

<div id="RIL_IMG_11" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/11"/></div>
<p class="MsoNormal" nodeIndex="132"><span nodeIndex="1791"><span nodeIndex="1792"><span nodeIndex="1793">图</span></span></span><span nodeIndex="1794"><span nodeIndex="1795"><span lang="EN-US" nodeIndex="1796">2.1</span></span></span></p>
<p class="MsoNormal" nodeIndex="133"><span nodeIndex="476"><span nodeIndex="1797"><span nodeIndex="1798">这个链接问题的原因就是链接器在将一堆目标文件组合到一起的时候，不知道那个应该放在开头，也就是生成的可执行文件的第一条指令应该是哪个目标文件的第一条。根据内核知识可知，内核最先运行的是</span></span></span><span nodeIndex="1799"><span nodeIndex="1800"><span lang="EN-US" nodeIndex="1801">head</span></span></span><span nodeIndex="1802"><span nodeIndex="1803"><span nodeIndex="1804">程序，所以打开</span></span></span><span nodeIndex="1805"><span nodeIndex="1806"><span lang="EN-US" nodeIndex="1807">head.s</span></span></span><span nodeIndex="1808"><span nodeIndex="1809"><span nodeIndex="1810">在</span></span></span><span nodeIndex="1811"><span nodeIndex="1812"><span lang="EN-US" nodeIndex="1813">.text</span></span></span><span nodeIndex="1814"><span nodeIndex="1815"><span nodeIndex="1816">段中增加</span></span></span><span nodeIndex="1817"><span nodeIndex="1818"><span lang="EN-US" nodeIndex="1819">.globl start_32</span></span></span><span nodeIndex="1820"><span nodeIndex="1821"><span nodeIndex="1822">。然后在</span></span></span><span nodeIndex="1823"><span nodeIndex="1824"><span lang="EN-US" nodeIndex="1825">ld</span></span></span><span nodeIndex="1826"><span nodeIndex="1827"><span nodeIndex="1828">的参数选项中增加</span></span></span><span nodeIndex="1829"><span nodeIndex="1830"><span lang="EN-US" nodeIndex="1831">-m elf_i386 -Ttext 0 -e startup_32</span></span></span><span nodeIndex="1832"><span nodeIndex="1833"><span nodeIndex="1834">。</span></span></span></p>
<p class="MsoNormal" nodeIndex="134"><span nodeIndex="1835"><span nodeIndex="1836"><span nodeIndex="1837">问题</span></span></span><span nodeIndex="1838"><span nodeIndex="1839"><span lang="EN-US" nodeIndex="1840">2</span></span></span><span nodeIndex="1841"><span nodeIndex="1842"><span nodeIndex="1843">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="135"><span nodeIndex="1844"><span nodeIndex="1845"><span nodeIndex="1846">之后又出现如图</span></span></span><span nodeIndex="1847"><span nodeIndex="1848"><span lang="EN-US" nodeIndex="1849">2.2</span></span></span><span nodeIndex="1850"><span nodeIndex="1851"><span nodeIndex="1852">所示的问题。</span></span></span></p>

<div id="RIL_IMG_12" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/12"/></div>
<p class="MsoNormal" nodeIndex="138"><span nodeIndex="1858"><span nodeIndex="1859"><span nodeIndex="1860">图</span></span></span><span nodeIndex="1861"><span nodeIndex="1862"><span lang="EN-US" nodeIndex="1863">2.2</span></span></span></p>
<p class="MsoNormal" nodeIndex="139"><span nodeIndex="1864"><span nodeIndex="1865"><span nodeIndex="1866">这个链接问题是由于找不到变量所致，原因是早期编译</span></span></span><span nodeIndex="1867"><span nodeIndex="1868"><span lang="EN-US" nodeIndex="1869">linux-0.11</span></span></span><span nodeIndex="1870"><span nodeIndex="1871"><span nodeIndex="1872">的汇编器需要在</span></span></span><span nodeIndex="1873"><span nodeIndex="1874"><span lang="EN-US" nodeIndex="1875">c</span></span></span><span nodeIndex="477"><span><span>变量之前增加下划线来识别，而目前的汇编器已足够强大，不用下划线了，所以要全部去掉，这是个枯燥的工程啊。</span></span></span></p>
<p class="MsoNormal" nodeIndex="140"><span nodeIndex="1876"><span nodeIndex="1877"><span nodeIndex="1878">问题</span></span></span><span nodeIndex="1879"><span nodeIndex="1880"><span lang="EN-US" nodeIndex="1881">3</span></span></span><span nodeIndex="1882"><span nodeIndex="1883"><span nodeIndex="1884">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="141"><span nodeIndex="1885"><span nodeIndex="1886"><span nodeIndex="1887">然后又出现如图</span></span></span><span nodeIndex="1888"><span nodeIndex="1889"><span lang="EN-US" nodeIndex="1890">2.3</span></span></span><span nodeIndex="1891"><span nodeIndex="1892"><span nodeIndex="1893">所示的问题。</span></span></span></p>


<p class="MsoNormal" nodeIndex="144"><span nodeIndex="1899"><span nodeIndex="1900"><span nodeIndex="1901">图</span></span></span><span nodeIndex="1902"><span nodeIndex="1903"><span lang="EN-US" nodeIndex="1904">2.3</span></span></span></p>

<p class="MsoNormal" nodeIndex="146"><span nodeIndex="1905"><span nodeIndex="1906"><span nodeIndex="1907">这种问题是由于没有这两个串口中断处理程序，可以定义一个空程序，或者直接去掉初始化内容</span></span></span></p>
<p class="MsoNormal" nodeIndex="147"><span nodeIndex="1908"><span nodeIndex="1909"><span nodeIndex="1910">问题</span></span></span><span nodeIndex="1911"><span nodeIndex="1912"><span lang="EN-US" nodeIndex="1913">4</span></span></span><span nodeIndex="1914"><span nodeIndex="1915"><span nodeIndex="1916">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="148"><span nodeIndex="1917"><span nodeIndex="1918"><span nodeIndex="1919">之后又出现如图</span></span></span><span nodeIndex="1920"><span nodeIndex="1921"><span lang="EN-US" nodeIndex="1922">2.4</span></span></span><span nodeIndex="1923"><span nodeIndex="1924"><span nodeIndex="1925">所示的问题。</span></span></span></p>

<div id="RIL_IMG_13" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/13"/></div>
<p class="MsoNormal" nodeIndex="151"><span nodeIndex="1931"><span nodeIndex="1932"><span nodeIndex="1933">图</span></span></span><span nodeIndex="1934"><span nodeIndex="1935"><span lang="EN-US" nodeIndex="1936">2.4</span></span></span></p>
<p class="MsoNormal" nodeIndex="152"><span nodeIndex="1937"><span nodeIndex="1938"><span nodeIndex="1939">这个问题比较有意思，对</span></span></span><span nodeIndex="1940"><span nodeIndex="1941"><span lang="EN-US" nodeIndex="1942">keyboard.S</span></span></span><span nodeIndex="1943"><span nodeIndex="1944"><span nodeIndex="1945">做一些处理后生成</span></span></span><span nodeIndex="1946"><span nodeIndex="1947"><span lang="EN-US" nodeIndex="1948">keyboard.s</span></span></span><span nodeIndex="1949"><span nodeIndex="1950"><span nodeIndex="1951">，但是</span></span></span><span nodeIndex="1952"><span nodeIndex="1953"><span lang="EN-US" nodeIndex="1954">gcc-4.6.1</span></span></span><span nodeIndex="478"><span><span>不区分文件名大小写，故而源文件和目标文件成了同一个。解决方法很简单，将源文件</span></span></span><span nodeIndex="1955"><span nodeIndex="1956"><span lang="EN-US" nodeIndex="1957">keyboard.S</span></span></span><span nodeIndex="1958"><span nodeIndex="1959"><span nodeIndex="1960">改名为</span></span></span><span nodeIndex="1961"><span nodeIndex="1962"><span lang="EN-US" nodeIndex="1963">keyboard1.S</span></span></span><span nodeIndex="1964"><span nodeIndex="1965"><span nodeIndex="1966">，同时修改其</span></span></span><span nodeIndex="1967"><span nodeIndex="1968"><span lang="EN-US" nodeIndex="1969">makefile</span></span></span><span nodeIndex="1970"><span nodeIndex="1971"><span nodeIndex="1972">便可。</span></span></span></p>
<p class="MsoNormal" nodeIndex="153"><span nodeIndex="1973"><span nodeIndex="1974"><span nodeIndex="1975">问题</span></span></span><span nodeIndex="1976"><span nodeIndex="1977"><span lang="EN-US" nodeIndex="1978">5</span></span></span><span nodeIndex="1979"><span nodeIndex="1980"><span nodeIndex="1981">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="154"><span nodeIndex="1982"><span nodeIndex="1983"><span nodeIndex="1984">接着又出现如图</span></span></span><span nodeIndex="1985"><span nodeIndex="1986"><span lang="EN-US" nodeIndex="1987">2.5</span></span></span><span nodeIndex="1988"><span nodeIndex="1989"><span nodeIndex="1990">所示的问题。</span></span></span></p>

<div id="RIL_IMG_14" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/14"/></div>
<p class="MsoNormal" nodeIndex="157"><span nodeIndex="1994"><span nodeIndex="1995"><span nodeIndex="1996">图</span></span></span><span nodeIndex="1997"><span nodeIndex="1998"><span lang="EN-US" nodeIndex="1999">2.5</span></span></span></p>
<p class="MsoNormal" nodeIndex="158"><span nodeIndex="2000"><span nodeIndex="2001"><span nodeIndex="2002">在所有错误涉及到的目录下（这里是</span></span></span><span nodeIndex="2003"><span nodeIndex="2004"><span lang="EN-US" nodeIndex="2005">kernel/</span></span></span><span nodeIndex="2006"><span nodeIndex="2007"><span nodeIndex="2008">，</span></span></span><span nodeIndex="2009"><span nodeIndex="2010"><span lang="EN-US" nodeIndex="2011">fs/</span></span></span><span nodeIndex="2012"><span nodeIndex="2013"><span nodeIndex="2014">，</span></span></span><span nodeIndex="2015"><span nodeIndex="2016"><span lang="EN-US" nodeIndex="2017">kernel/chr_drv/</span></span></span><span nodeIndex="2018"><span nodeIndex="2019"><span nodeIndex="2020">）的</span></span></span><span nodeIndex="2021"><span nodeIndex="2022"><span lang="EN-US" nodeIndex="2023">Makefile</span></span></span><span nodeIndex="2024"><span nodeIndex="2025"><span nodeIndex="2026">里找到</span></span></span><span nodeIndex="2027"><span nodeIndex="2028"><span lang="EN-US" nodeIndex="2029">CFLAGS</span></span></span><span nodeIndex="2030"><span nodeIndex="2031"><span nodeIndex="2032">然后添加</span></span></span><span nodeIndex="2033"><span nodeIndex="2034"><span lang="EN-US" nodeIndex="2035">-fno-stack-protector</span></span></span><span nodeIndex="2036"><span nodeIndex="2037"><span nodeIndex="2038">标志！其实这是传给</span></span></span><span nodeIndex="2039"><span nodeIndex="2040"><span lang="EN-US" nodeIndex="2041">GCC</span></span></span><span nodeIndex="2042"><span nodeIndex="2043"><span nodeIndex="2044">的一个编译选项。</span></span></span><span nodeIndex="2045"><span nodeIndex="2046"><span lang="EN-US" nodeIndex="2047">-fno-stack-protector</span></span></span><span nodeIndex="2048"><span nodeIndex="2049"><span nodeIndex="2050">参数用来</span></span></span><span nodeIndex="2051"><span nodeIndex="2052"><span lang="EN-US" nodeIndex="2053">disable Stack-smashing protection ,</span></span></span><span nodeIndex="2054"><span nodeIndex="2055"><span nodeIndex="2056">高版本</span></span></span><span nodeIndex="2057"><span nodeIndex="2058"><span lang="EN-US" nodeIndex="2059">gcc</span></span></span><span nodeIndex="2060"><span nodeIndex="2061"><span nodeIndex="2062">默认用</span></span></span><span nodeIndex="2063"><span nodeIndex="2064"><span lang="EN-US" nodeIndex="2065">-fstack-protector</span></span></span><span nodeIndex="2066"><span nodeIndex="2067"><span nodeIndex="2068">参数进行编译。</span></span></span></p>
<p class="MsoNormal" nodeIndex="159"><span nodeIndex="2069"><span nodeIndex="2070"><span nodeIndex="2071">问题</span></span></span><span nodeIndex="2072"><span nodeIndex="2073"><span lang="EN-US" nodeIndex="2074">6</span></span></span><span nodeIndex="2075"><span nodeIndex="2076"><span nodeIndex="2077">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="160"><span nodeIndex="2078"><span nodeIndex="2079"><span nodeIndex="2080">之后又出现如图</span></span></span><span nodeIndex="2081"><span nodeIndex="2082"><span lang="EN-US" nodeIndex="2083">2.6</span></span></span><span nodeIndex="2084"><span nodeIndex="2085"><span nodeIndex="2086">所示的问题。</span></span></span></p>

<div id="RIL_IMG_15" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/15"/></div>
<p class="MsoNormal" nodeIndex="163"><span nodeIndex="2090"><span nodeIndex="2091"><span nodeIndex="2092">图</span></span></span><span nodeIndex="2093"><span nodeIndex="2094"><span lang="EN-US" nodeIndex="2095">2.6</span></span></span></p>
<p class="MsoNormal" nodeIndex="164"><span nodeIndex="2096"><span nodeIndex="2097"><span nodeIndex="2098">这个问题简单，就是</span></span></span><span nodeIndex="2099"><span nodeIndex="2100"><span lang="EN-US" nodeIndex="2101">build.c</span></span></span><span nodeIndex="2102"><span nodeIndex="2103"><span nodeIndex="2104">程序找不到</span></span></span><span nodeIndex="2105"><span nodeIndex="2106"><span lang="EN-US" nodeIndex="2107">MAJOR</span></span></span><span nodeIndex="2108"><span nodeIndex="2109"><span nodeIndex="2110">和</span></span></span><span nodeIndex="2111"><span nodeIndex="2112"><span lang="EN-US" nodeIndex="2113">MINOR</span></span></span><span nodeIndex="2114"><span nodeIndex="2115"><span nodeIndex="2116">的实现体，那么就打开</span></span></span><span nodeIndex="2117"><span nodeIndex="2118"><span lang="EN-US" nodeIndex="2119">build.c</span></span></span><span nodeIndex="2120"><span nodeIndex="2121"><span nodeIndex="2122">将这两个宏的实现加入便可，如图</span></span></span><span nodeIndex="2123"><span nodeIndex="2124"><span lang="EN-US" nodeIndex="2125">2.7</span></span></span><span nodeIndex="2126"><span nodeIndex="2127"><span nodeIndex="2128">所示。</span></span></span></p>

<div id="RIL_IMG_16" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/16"/></div>
<p class="MsoNormal" nodeIndex="167"><span nodeIndex="2132"><span nodeIndex="2133"><span nodeIndex="2134">图</span></span></span><span nodeIndex="2135"><span nodeIndex="2136"><span lang="EN-US" nodeIndex="2137">2.7</span></span></span></p>
<p class="MsoNormal" nodeIndex="168"><span nodeIndex="2138"><span nodeIndex="2139"><span nodeIndex="2140">至此，</span></span></span><span nodeIndex="2141"><span nodeIndex="2142"><span lang="EN-US" nodeIndex="2143">make</span></span></span><span nodeIndex="2144"><span nodeIndex="2145"><span nodeIndex="2146">已经可以通过了。</span></span></span></p>
<p class="MsoNormal" nodeIndex="169"><span nodeIndex="2147"><span nodeIndex="2148"><b nodeIndex="2149"><span nodeIndex="2150">三、调试过程</span></b></span></span></p>
<p class="MsoNormal" nodeIndex="170"><span nodeIndex="2151"><span nodeIndex="2152"><span nodeIndex="2153">编译链接成功后，运行如图</span></span></span><span nodeIndex="2154"><span nodeIndex="2155"><span lang="EN-US" nodeIndex="2156">3.2</span></span></span><span nodeIndex="2157"><span nodeIndex="2158"><span nodeIndex="2159">所示。大多数</span></span></span><span nodeIndex="2160"><span nodeIndex="2161"><span lang="EN-US" nodeIndex="2162">linux-0.11</span></span></span><span nodeIndex="479"><span><span>的玩家都停到这里了，但是咱不是得做小部分人嘛，那继续吧。</span></span></span></p>
<p class="MsoNormal" nodeIndex="171"><span nodeIndex="2163"><span nodeIndex="2164"><span lang="EN-US" nodeIndex="2165">1</span></span></span><span nodeIndex="2166"><span nodeIndex="2167"><span nodeIndex="2168">、调试方法与工具：</span></span></span></p>
<p class="MsoNormal" nodeIndex="172"><span nodeIndex="2169"><span nodeIndex="2170"><span nodeIndex="2171">（</span></span></span><span nodeIndex="2172"><span nodeIndex="2173"><span lang="EN-US" nodeIndex="2174">1</span></span></span><span nodeIndex="2175"><span nodeIndex="2176"><span nodeIndex="2177">）</span></span></span><span nodeIndex="2178"><span nodeIndex="2179"><span nodeIndex="2180">插桩（</span></span></span><span nodeIndex="2181"><span nodeIndex="2182"><span lang="EN-US" nodeIndex="2183">printf</span></span></span><span nodeIndex="2184"><span nodeIndex="2185"><span nodeIndex="2186">、</span></span></span><span nodeIndex="2187"><span nodeIndex="2188"><span lang="EN-US" nodeIndex="2189">while(1)()</span></span></span><span nodeIndex="2190"><span nodeIndex="2191"><span nodeIndex="2192">等手段）。注意</span></span></span> <span nodeIndex="2193"><span nodeIndex="2194"><span lang="EN-US" nodeIndex="2195">Printk</span></span></span><span nodeIndex="480"><span><span>在内核态使用，比如中断处理函数，系统调用处理函数等，而</span></span></span><span nodeIndex="2196"><span nodeIndex="2197"><span lang="EN-US" nodeIndex="2198">printf</span></span></span><span nodeIndex="2199"><span nodeIndex="2200"><span nodeIndex="2201">在用户态使用，比如</span></span></span><span nodeIndex="2202"><span nodeIndex="2203"><span lang="EN-US" nodeIndex="2204">init</span></span></span><span nodeIndex="2205"><span nodeIndex="2206"><span nodeIndex="2207">进程体里面。</span></span></span></p>
<p class="MsoNormal" nodeIndex="173"><span nodeIndex="2208"><span nodeIndex="2209"><span nodeIndex="2210">（</span></span></span><span nodeIndex="2211"><span nodeIndex="2212"><span lang="EN-US" nodeIndex="2213">2</span></span></span><span nodeIndex="2214"><span nodeIndex="2215"><span nodeIndex="2216">）</span></span></span><span nodeIndex="2217"><span nodeIndex="2218"><span lang="EN-US" nodeIndex="2219">bochs</span></span></span><span nodeIndex="2220"><span nodeIndex="2221"><span nodeIndex="2222">单步（</span></span></span><span nodeIndex="2223"><span nodeIndex="2224"><span lang="EN-US" nodeIndex="2225">s</span></span></span><span nodeIndex="2226"><span nodeIndex="2227"><span nodeIndex="2228">、</span></span></span><span nodeIndex="2229"><span nodeIndex="2230"><span lang="EN-US" nodeIndex="2231">n</span></span></span><span nodeIndex="2232"><span nodeIndex="2233"><span nodeIndex="2234">）、断点（</span></span></span><span nodeIndex="2238"><span nodeIndex="2239"><span nodeIndex="2240">、</span></span></span><span nodeIndex="2241"><span nodeIndex="2242"><span lang="EN-US" nodeIndex="2243">bblist</span></span></span><span nodeIndex="2244"><span nodeIndex="2245"><span nodeIndex="2246">、</span></span></span><span nodeIndex="2247"><span nodeIndex="2248"><span lang="EN-US" nodeIndex="2249">del</span></span></span><span nodeIndex="2250"><span nodeIndex="2251"><span nodeIndex="2252">、</span></span></span><span nodeIndex="2253"><span nodeIndex="2254"><span lang="EN-US" nodeIndex="2255">c</span></span></span><span nodeIndex="2256"><span nodeIndex="2257"><span nodeIndex="2258">）、内存检测（</span></span></span><span nodeIndex="2262"><span nodeIndex="2263"><span nodeIndex="2264">、</span></span></span><span nodeIndex="2265"><span nodeIndex="2266"><span lang="EN-US" nodeIndex="2267">xwatch</span></span></span><span nodeIndex="2268"><span nodeIndex="2269"><span nodeIndex="2270">）等调试手段。</span></span></span></p>
<p class="MsoNormal" nodeIndex="174"><span nodeIndex="2271"><span nodeIndex="2272"><span nodeIndex="2273">（</span></span></span><span nodeIndex="2274"><span nodeIndex="2275"><span lang="EN-US" nodeIndex="2276">3</span></span></span><span nodeIndex="2277"><span nodeIndex="2278"><span nodeIndex="2279">）</span></span></span><span nodeIndex="2280"><span nodeIndex="2281"><span lang="EN-US" nodeIndex="2282">make</span></span></span><span nodeIndex="2283"><span nodeIndex="2284"><span nodeIndex="2285">时自动生成的可执行文件链接图</span></span></span><span nodeIndex="2286"><span nodeIndex="2287"><span lang="EN-US" nodeIndex="2288">system.map</span></span></span><span nodeIndex="2289"><span nodeIndex="2290"><span nodeIndex="2291">，如图</span></span></span><span nodeIndex="2292"><span nodeIndex="2293"><span lang="EN-US" nodeIndex="2294">3.1</span></span></span><span nodeIndex="2295"><span nodeIndex="2296"><span nodeIndex="2297">所示，</span></span></span><span nodeIndex="2298"><span nodeIndex="2299"><span lang="EN-US" nodeIndex="2300">LDFLAGS</span></span></span><span nodeIndex="2301"><span nodeIndex="2302"><span nodeIndex="2303">中的</span></span></span><span nodeIndex="2304"><span nodeIndex="2305"><span lang="EN-US" nodeIndex="2306">-M</span></span></span><span nodeIndex="481"><span><span>选项实现此功能。这个文件在调试内核时相当重要，它展示了每个全局变量、全局可见的函数的地址，该文件配合</span></span></span><span nodeIndex="2307"><span nodeIndex="2308"><span lang="EN-US" nodeIndex="2309">bochs</span></span></span><span nodeIndex="2310"><span nodeIndex="2311"><span nodeIndex="2312">的断点和内存查看、监控命令，几乎无所不能。</span></span></span></p>
<p class="MsoNormal" nodeIndex="175"><span nodeIndex="2313"><span nodeIndex="2314"><span nodeIndex="2315">（</span></span></span><span nodeIndex="2316"><span nodeIndex="2317"><span lang="EN-US" nodeIndex="2318">4</span></span></span><span nodeIndex="2319"><span nodeIndex="2320"><span nodeIndex="2321">）</span></span></span><span nodeIndex="2322"><span nodeIndex="2323"><span lang="EN-US" nodeIndex="2324">objdump</span></span></span><span nodeIndex="2325"><span nodeIndex="2326"><span nodeIndex="2327">生成的反汇编文件（如图</span></span></span><span nodeIndex="2328"><span nodeIndex="2329"><span lang="EN-US" nodeIndex="2330">3.1</span></span></span><span nodeIndex="2331"><span nodeIndex="2332"><span nodeIndex="2333">红线标注部分所示修改</span></span></span><span nodeIndex="2334"><span nodeIndex="2335"><span lang="EN-US" nodeIndex="2336">makefile</span></span></span><span nodeIndex="2337"><span nodeIndex="2338"><span nodeIndex="2339">，然后</span></span></span><span nodeIndex="2340"><span nodeIndex="2341"><span lang="EN-US" nodeIndex="2342">make DISASM</span></span></span><span nodeIndex="482"><span><span>便可生成该文件）调试时可以用来确认汇编码所属的函数，也可用来阅读汇编码。</span></span></span></p>

<div id="RIL_IMG_17" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/17"/></div>
<p class="MsoNormal" nodeIndex="178"><span nodeIndex="2346"><span nodeIndex="2347"><span nodeIndex="2348">图</span></span></span><a name="OLE_LINK26" nodeIndex="2349"></a><a name="OLE_LINK25" nodeIndex="2350"><span nodeIndex="2351"><span nodeIndex="2352"><span nodeIndex="2353"><span lang="EN-US" nodeIndex="2354">3.1</span></span></span></span></a></p>
<p class="MsoNormal" nodeIndex="179"><span nodeIndex="2355"><span nodeIndex="2356"><span nodeIndex="2357">（</span></span></span><span nodeIndex="2358"><span nodeIndex="2359"><span lang="EN-US" nodeIndex="2360">5</span></span></span><span nodeIndex="2361"><span nodeIndex="2362"><span nodeIndex="2363">）</span></span></span><span nodeIndex="2364"><span nodeIndex="2365"><span nodeIndex="2366">赵炯博士</span></span></span><span nodeIndex="2367"><span nodeIndex="2368"><span lang="EN-US" nodeIndex="2369">oldlinux</span></span></span><span nodeIndex="2370"><span nodeIndex="2371"><span nodeIndex="2372">网站上下载的</span></span></span><span nodeIndex="2373"><span nodeIndex="2374"><span lang="EN-US" nodeIndex="2375">linux-0.11-devel-040923</span></span></span><span nodeIndex="2376"><span nodeIndex="2377"><span nodeIndex="2378">包，可获得用</span></span></span><span nodeIndex="2379"><span nodeIndex="2380"><span lang="EN-US" nodeIndex="2381">gcc1.4</span></span></span><span nodeIndex="2382"><span nodeIndex="2383"><span nodeIndex="2384">编译后可正常运行</span></span></span><span nodeIndex="2385"><span nodeIndex="2386"><span lang="EN-US" nodeIndex="2387">linux-0.11</span></span></span><span nodeIndex="2388"><span nodeIndex="2389"><span nodeIndex="2390">。调试时我们用</span></span></span><span nodeIndex="2391"><span nodeIndex="2392"><span lang="EN-US" nodeIndex="2393">gcc-4.6.1</span></span></span><span nodeIndex="483"><span><span>编译的内核运行情况和正确的对比，有确认错误的功能。</span></span></span></p>
<p class="MsoNormal" nodeIndex="180"><span nodeIndex="2394"><span nodeIndex="2395"><span nodeIndex="2396">（</span></span></span><span nodeIndex="2397"><span nodeIndex="2398"><span lang="EN-US" nodeIndex="2399">6</span></span></span><span nodeIndex="2400"><span nodeIndex="2401"><span nodeIndex="2402">）</span></span></span><span nodeIndex="2403"><span nodeIndex="2404"><span lang="EN-US" nodeIndex="2405">hexdump –C rootimage-0.11 |less</span></span></span><span nodeIndex="2406"><span nodeIndex="2407"><span nodeIndex="2408">命令可用来查看文件系统数据，并确认其正确性，调试过程涉及到</span></span></span><span nodeIndex="2409"><span nodeIndex="2410"><span lang="EN-US" nodeIndex="2411">execve</span></span></span><span nodeIndex="484"><span><span>系统调用后，每次运行系统都需重新更换文件系统软盘镜像，因为上次运行可能修改了其中的数据。</span></span></span></p>
<p class="MsoNormal" nodeIndex="181"><span nodeIndex="2412"><span nodeIndex="2413"><span lang="EN-US" nodeIndex="2414">2</span></span></span><span nodeIndex="2415"><span nodeIndex="2416"><span nodeIndex="2417">、问题及解决方法</span></span></span></p>
<p class="MsoNormal" nodeIndex="182"><span nodeIndex="2418"><span nodeIndex="2419"><span nodeIndex="2420">问题</span></span></span><span nodeIndex="2421"><span nodeIndex="2422"><span lang="EN-US" nodeIndex="2423">1</span></span></span><span nodeIndex="2424"><span nodeIndex="2425"><span nodeIndex="2426">：</span></span></span></p>

<div id="RIL_IMG_18" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/18"/></div>
<p class="MsoNormal" nodeIndex="185"><span nodeIndex="2430"><span nodeIndex="2431"><span nodeIndex="2432">图</span></span></span><span nodeIndex="2433"><span nodeIndex="2434"><span lang="EN-US" nodeIndex="2435">3.2</span></span></span></p>

<p class="MsoNormal" nodeIndex="187"><span nodeIndex="2436"><span nodeIndex="2437"><span nodeIndex="2438">首先需要确定的是图</span></span></span><span nodeIndex="2439"><span nodeIndex="2440"><span lang="EN-US" nodeIndex="2441">3.2</span></span></span><span nodeIndex="485"><span><span>所示的运行到底停在了那里。内核刚开始正式运行时进入了</span></span></span><span nodeIndex="2442"><span nodeIndex="2443"><span lang="EN-US" nodeIndex="2444">main</span></span></span><span nodeIndex="2445"><span nodeIndex="2446"><span nodeIndex="2447">函数，在这里进入第</span></span></span><span nodeIndex="2448"><span nodeIndex="2449"><span lang="EN-US" nodeIndex="2450">0</span></span></span><span nodeIndex="2451"><span nodeIndex="2452"><span nodeIndex="2453">个进程后，创建出第一个进程运行</span></span></span><span nodeIndex="2454"><span nodeIndex="2455"><span lang="EN-US" nodeIndex="2456">init</span></span></span><span nodeIndex="2457"><span nodeIndex="2458"><span nodeIndex="2459">函数，如图</span></span></span><span nodeIndex="2460"><span nodeIndex="2461"><span lang="EN-US" nodeIndex="2462">3.3</span></span></span><span nodeIndex="2463"><span nodeIndex="2464"><span nodeIndex="2465">所示。插桩输出是最普通也常常是最有效的调试方法。在</span></span></span><span nodeIndex="2466"><span nodeIndex="2467"><span lang="EN-US" nodeIndex="2468">init</span></span></span><span nodeIndex="2469"><span nodeIndex="2470"><span nodeIndex="2471">函数中使用</span></span></span><span nodeIndex="2472"><span nodeIndex="2473"><span lang="EN-US" nodeIndex="2474">printf</span></span></span><span nodeIndex="2475"><span nodeIndex="2476"><span nodeIndex="2477">发现并没有输出，说明系统没有进入第一个进程，那么</span></span></span><span nodeIndex="2478"><span nodeIndex="2479"><span lang="EN-US" nodeIndex="2480">fork</span></span></span><span nodeIndex="2481"><span nodeIndex="2482"><span nodeIndex="2483">系统调用（功能：创建新进程）就有问题。使用</span></span></span><span nodeIndex="2484"><span nodeIndex="2485"><span lang="EN-US" nodeIndex="2486">bochs</span></span></span><span nodeIndex="2487"><span nodeIndex="2488"><span nodeIndex="2489">调试功能查看</span></span></span><span nodeIndex="2490"><span nodeIndex="2491"><span lang="EN-US" nodeIndex="2492">main</span></span></span><span nodeIndex="2493"><span nodeIndex="2494"><span nodeIndex="2495">函数汇编源码，发现调用</span></span></span><span nodeIndex="2496"><span nodeIndex="2497"><span lang="EN-US" nodeIndex="2498">fork</span></span></span><span nodeIndex="2499"><span nodeIndex="2500"><span nodeIndex="2501">时使用了</span></span></span><span nodeIndex="2502"><span nodeIndex="2503"><span lang="EN-US" nodeIndex="2504">call</span></span></span><span nodeIndex="2505"><span nodeIndex="2506"><span nodeIndex="2507">指令而非应有的内联。</span></span></span></p>


<p class="MsoNormal" nodeIndex="190"><span nodeIndex="2513"><span nodeIndex="2514"><span nodeIndex="2515">图</span></span></span><span nodeIndex="2516"><span nodeIndex="2517"><span lang="EN-US" nodeIndex="2518">3.3</span></span></span></p>

<p class="MsoNormal" nodeIndex="192"><span nodeIndex="2519"><span nodeIndex="2520"><span lang="EN-US" nodeIndex="2521">linux-0.11</span></span></span><span nodeIndex="2522"><span nodeIndex="2523"><span nodeIndex="2524">的进程</span></span></span><span nodeIndex="2525"><span nodeIndex="2526"><span lang="EN-US" nodeIndex="2527">0</span></span></span><span nodeIndex="2528"><span nodeIndex="2529"><span nodeIndex="2530">和</span></span></span><span nodeIndex="2531"><span nodeIndex="2532"><span lang="EN-US" nodeIndex="2533">1</span></span></span><span nodeIndex="2534"><span nodeIndex="2535"><span nodeIndex="2536">共用一个栈，进程</span></span></span><span nodeIndex="2537"><span nodeIndex="2538"><span lang="EN-US" nodeIndex="2539">0</span></span></span><span nodeIndex="2540"><span nodeIndex="2541"><span nodeIndex="2542">在创建了进程</span></span></span><span nodeIndex="2543"><span nodeIndex="2544"><span lang="EN-US" nodeIndex="2545">1</span></span></span><span nodeIndex="2546"><span nodeIndex="2547"><span nodeIndex="2548">后只有等待</span></span></span><span nodeIndex="2549"><span nodeIndex="2550"><span lang="EN-US" nodeIndex="2551">pause</span></span></span><span nodeIndex="2552"><span nodeIndex="2553"><span nodeIndex="2554">的功能，为了避免进程</span></span></span><span nodeIndex="2555"><span nodeIndex="2556"><span lang="EN-US" nodeIndex="2557">1</span></span></span><span nodeIndex="2558"><span nodeIndex="2559"><span nodeIndex="2560">栈中数据被破坏，</span></span></span> <span nodeIndex="2561"><span nodeIndex="2562"><span nodeIndex="2563">进程</span></span></span><span nodeIndex="2564"><span nodeIndex="2565"><span lang="EN-US" nodeIndex="2566">0</span></span></span><span nodeIndex="2567"><span nodeIndex="2568"><span nodeIndex="2569">不可使用栈，那么就不可使用</span></span></span><span nodeIndex="2570"><span nodeIndex="2571"><span lang="EN-US" nodeIndex="2572">call</span></span></span><span nodeIndex="2573"><span nodeIndex="2574"><span nodeIndex="2575">来调用</span></span></span><span nodeIndex="2576"><span nodeIndex="2577"><span lang="EN-US" nodeIndex="2578">fork</span></span></span><span nodeIndex="2579"><span nodeIndex="2580"><span nodeIndex="2581">和</span></span></span><span nodeIndex="2582"><span nodeIndex="2583"><span lang="EN-US" nodeIndex="2584">pause</span></span></span><span nodeIndex="486"><span><span>库函数，而应该用内联的方法，防止参数传递将栈搞乱。为了实现这一点，在</span></span></span><span nodeIndex="2585"><span nodeIndex="2586"><span lang="EN-US" nodeIndex="2587">main.c</span></span></span><span nodeIndex="2588"><span nodeIndex="2589"><span nodeIndex="2590">开始为几个系统调用出了内联声明，如图</span></span></span><span nodeIndex="2591"><span nodeIndex="2592"><span lang="EN-US" nodeIndex="2593">3.4</span></span></span><span nodeIndex="2594"><span nodeIndex="2595"><span nodeIndex="2596">所示，</span></span></span><span nodeIndex="2597"><span nodeIndex="2598"><span lang="EN-US" nodeIndex="2599">static inline</span></span></span><span nodeIndex="2600"><span nodeIndex="2601"><span nodeIndex="2602">表示仅仅在该文件中这些系统调用时内联的。</span></span></span></p>

<div id="RIL_IMG_19" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/19"/></div>
<p class="MsoNormal" nodeIndex="195"><span nodeIndex="2608"><span nodeIndex="2609"><span nodeIndex="2610">图</span></span></span><span nodeIndex="2611"><span nodeIndex="2612"><span lang="EN-US" nodeIndex="2613">3.4</span></span></span></p>

<p class="MsoNormal" nodeIndex="197"><span nodeIndex="487"><span><span>然而通过调试可知，该内联功能并未实现（具体原因不详，求高人指点），以至于进程</span></span></span><span nodeIndex="2614"><span nodeIndex="2615"><span lang="EN-US" nodeIndex="2616">1</span></span></span><span nodeIndex="2617"><span nodeIndex="2618"><span nodeIndex="2619">栈混乱。但仍可以做如图</span></span></span><span nodeIndex="2620"><span nodeIndex="2621"><span lang="EN-US" nodeIndex="2622">3.5</span></span></span><span nodeIndex="488"><span><span>所示修改使之运行通过，其实就是直接将这两个库函数的实现拷入</span></span></span><span nodeIndex="2623"><span nodeIndex="2624"><span lang="EN-US" nodeIndex="2625">main.c</span></span></span><span nodeIndex="2626"><span nodeIndex="2627"><span nodeIndex="2628">中。</span></span></span></p>

<div id="RIL_IMG_20" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/20"/></div>
<p class="MsoNormal" nodeIndex="200"><span nodeIndex="2632"><span nodeIndex="2633"><span nodeIndex="2634">图</span></span></span><span nodeIndex="2635"><span nodeIndex="2636"><span lang="EN-US" nodeIndex="2637">3.5</span></span></span></p>

<p class="MsoNormal" nodeIndex="202"><span nodeIndex="2638"><span nodeIndex="2639"><span nodeIndex="2640">问题</span></span></span><span nodeIndex="2641"><span nodeIndex="2642"><span lang="EN-US" nodeIndex="2643">2</span></span></span><span nodeIndex="2644"><span nodeIndex="2645"><span nodeIndex="2646">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="203"><span nodeIndex="2647"><span nodeIndex="2648"><span nodeIndex="2649">经过上述修改后，编译运行发现系统运行状况依然如故。天呐，求你动一动吧</span></span></span><span nodeIndex="2650"><span nodeIndex="2651"><span lang="EN-US" nodeIndex="2652">. . .</span></span></span></p>
<p class="MsoNormal" nodeIndex="204"><span nodeIndex="2653"><span nodeIndex="2654"><span nodeIndex="2655">说明</span></span></span><span nodeIndex="2656"><span nodeIndex="2657"><span lang="EN-US" nodeIndex="2658">fork</span></span></span><span nodeIndex="2659"><span nodeIndex="2660"><span nodeIndex="2661">系统调用还有其他问题。</span></span></span><span nodeIndex="2662"><span nodeIndex="2663"><span lang="EN-US" nodeIndex="2664">Bochs</span></span></span><span nodeIndex="2665"><span nodeIndex="2666"><span nodeIndex="2667">在</span></span></span><span nodeIndex="2668"><span nodeIndex="2669"><span lang="EN-US" nodeIndex="2670">fork</span></span></span><span nodeIndex="2671"><span nodeIndex="2672"><span nodeIndex="2673">软中断的处理函数</span></span></span><span nodeIndex="2674"><span nodeIndex="2675"><span lang="EN-US" nodeIndex="2676">copy_process</span></span></span><span nodeIndex="2677"><span nodeIndex="2678"><span nodeIndex="2679">中设断点，但不执行并使用</span></span></span><span nodeIndex="2680"><span nodeIndex="2681"><span lang="EN-US" nodeIndex="2682">x /nwx addr</span></span></span><span nodeIndex="2683"><span nodeIndex="2684"><span nodeIndex="2685">命令验证每一步的操作是否成功。发现</span></span></span><span nodeIndex="2686"><span nodeIndex="2687"><span lang="EN-US" nodeIndex="2688">*p=*current</span></span></span><span nodeIndex="2689"><span nodeIndex="2690"><span nodeIndex="2691">并没有将进程</span></span></span><span nodeIndex="2692"><span nodeIndex="2693"><span lang="EN-US" nodeIndex="2694">0</span></span></span><span nodeIndex="2695"><span nodeIndex="2696"><span nodeIndex="2697">的进程描述体赋值给进程</span></span></span><span nodeIndex="2698"><span nodeIndex="2699"><span lang="EN-US" nodeIndex="2700">p</span></span></span><span nodeIndex="2701"><span nodeIndex="2702"><span nodeIndex="2703">地址指向的内存，而是赋给了以</span></span></span><span nodeIndex="2704"><span nodeIndex="2705"><span lang="EN-US" nodeIndex="2706">p</span></span></span><span nodeIndex="2707"><span nodeIndex="2708"><span nodeIndex="2709">地址为末尾、以</span></span></span><span nodeIndex="2710"><span nodeIndex="2711"><span lang="EN-US" nodeIndex="2712">sizeof(task_struct)</span></span></span><span nodeIndex="2713"><span nodeIndex="2714"><span nodeIndex="2715">为大小的一段内存。那么问题明显了，这句</span></span></span><span nodeIndex="2716"><span nodeIndex="2717"><span lang="EN-US" nodeIndex="2718">c</span></span></span><span nodeIndex="2719"><span nodeIndex="2720"><span nodeIndex="2721">语句一定是用了</span></span></span><span nodeIndex="2722"><span nodeIndex="2723"><span lang="EN-US" nodeIndex="2724">rep</span></span></span><span nodeIndex="2725"><span nodeIndex="2726"><span nodeIndex="2727">指令，</span></span></span><span nodeIndex="2728"><span nodeIndex="2729"><span lang="EN-US" nodeIndex="2730">df</span></span></span><span nodeIndex="2731"><span nodeIndex="2732"><span nodeIndex="2733">位为向下拷贝（之前某个地方使用了</span></span></span><span nodeIndex="2734"><span nodeIndex="2735"><span lang="EN-US" nodeIndex="2736">std</span></span></span><span nodeIndex="2737"><span nodeIndex="2738"><span nodeIndex="2739">指令）。而新编译器编译</span></span></span><span nodeIndex="2740"><span nodeIndex="2741"><span lang="EN-US" nodeIndex="2742">c</span></span></span><span nodeIndex="2743"><span nodeIndex="2744"><span nodeIndex="2745">代码时，会认为已经</span></span></span><span nodeIndex="2746"><span nodeIndex="2747"><span lang="EN-US" nodeIndex="2748">cld</span></span></span><span nodeIndex="2749"><span nodeIndex="2750"><span nodeIndex="2751">过了，因此没加修改</span></span></span><a name="OLE_LINK18" nodeIndex="2752"></a><a name="OLE_LINK17" nodeIndex="2753"><span nodeIndex="2754"><span nodeIndex="2755"><span nodeIndex="2756"><span lang="EN-US" nodeIndex="2757">df</span></span></span></span></a><span nodeIndex="2758"><span nodeIndex="2759"><span nodeIndex="2760">位的指令。所以在所有</span></span></span><span nodeIndex="2761"><span nodeIndex="2762"><span lang="EN-US" nodeIndex="2763">c</span></span></span><span nodeIndex="2764"><span nodeIndex="2765"><span nodeIndex="2766">语言汇编后使用了</span></span></span><span nodeIndex="2767"><span nodeIndex="2768"><span lang="EN-US" nodeIndex="2769">rep</span></span></span><span nodeIndex="2770"><span nodeIndex="2771"><span nodeIndex="2772">指令拷贝数据的地方（使用</span></span></span><span nodeIndex="2773"><span nodeIndex="2774"><span lang="EN-US" nodeIndex="2775">objdump</span></span></span><span nodeIndex="2776"><span nodeIndex="2777"><span nodeIndex="2778">生成的反汇编文件中，搜索</span></span></span><span nodeIndex="2779"><span nodeIndex="2780"><span lang="EN-US" nodeIndex="2781">rep</span></span></span><span nodeIndex="2782"><span nodeIndex="2783"><span nodeIndex="2784">），都加上</span></span></span><span nodeIndex="2785"><span nodeIndex="2786"><span lang="EN-US" nodeIndex="2787">cld</span></span></span><span nodeIndex="2788"><span nodeIndex="2789"><span nodeIndex="2790">内嵌汇编。其实只有</span></span></span><span nodeIndex="2791"><span nodeIndex="2792"><span lang="EN-US" nodeIndex="2793">copy_process</span></span></span><span nodeIndex="2794"><span nodeIndex="2795"><span nodeIndex="2796">一个，其他用到</span></span></span><span nodeIndex="2797"><span nodeIndex="2798"><span lang="EN-US" nodeIndex="2799">rep</span></span></span><span nodeIndex="2800"><span nodeIndex="2801"><span nodeIndex="2802">的地方本来就是汇编，拷贝前都有</span></span></span><span nodeIndex="2803"><span nodeIndex="2804"><span lang="EN-US" nodeIndex="2805">cld</span></span></span><span nodeIndex="2806"><span nodeIndex="2807"><span nodeIndex="2808">或者</span></span></span><span nodeIndex="2809"><span nodeIndex="2810"><span lang="EN-US" nodeIndex="2811">std</span></span></span><span nodeIndex="2812"><span nodeIndex="2813"><span nodeIndex="2814">。做如图</span></span></span><span nodeIndex="2815"><span nodeIndex="2816"><span lang="EN-US" nodeIndex="2817">3.6</span></span></span><span nodeIndex="2818"><span nodeIndex="2819"><span nodeIndex="2820">所示修改后，编译运行如图</span></span></span><span nodeIndex="2821"><span nodeIndex="2822"><span lang="EN-US" nodeIndex="2823">3.7</span></span></span><span nodeIndex="2824"><span nodeIndex="2825"><span nodeIndex="2826">所示。</span></span></span></p>

<div id="RIL_IMG_21" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/21"/></div>
<p class="MsoNormal" nodeIndex="207"><span nodeIndex="2830"><span nodeIndex="2831"><span nodeIndex="2832">图</span></span></span><span nodeIndex="2833"><span nodeIndex="2834"><span lang="EN-US" nodeIndex="2835">3.6</span></span></span></p>


<div id="RIL_IMG_22" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/22"/></div>
<p class="MsoNormal" nodeIndex="211"><span nodeIndex="2839"><span nodeIndex="2840"><span nodeIndex="2841">图</span></span></span><span nodeIndex="2842"><span nodeIndex="2843"><span lang="EN-US" nodeIndex="2844">3.7</span></span></span></p>

<p class="MsoNormal" nodeIndex="213"><span nodeIndex="2845"><span nodeIndex="2846"><span nodeIndex="2847">问题</span></span></span><span nodeIndex="2848"><span nodeIndex="2849"><span lang="EN-US" nodeIndex="2850">3</span></span></span></p>
<p class="MsoNormal" nodeIndex="214"><span nodeIndex="2851"><span nodeIndex="2852"><span nodeIndex="2853">这个问题提示信息比较直接一些，就是文件系统无法读取。那肯定是软盘或者硬盘根设备没有配置好了。为了简单，本文且使用软盘装着文件系统。需要配置以下几个地方。</span></span></span></p>
<p class="MsoNormal" nodeIndex="215"><span nodeIndex="2854"><span nodeIndex="2855"><span nodeIndex="2856">（</span></span></span><span nodeIndex="2857"><span nodeIndex="2858"><span lang="EN-US" nodeIndex="2859">1</span></span></span><span nodeIndex="2860"><span nodeIndex="2861"><span nodeIndex="2862">）</span></span></span><span nodeIndex="2863"><span nodeIndex="2864"><span lang="EN-US" nodeIndex="2865">bochsrc-hd.bxrc</span></span></span><span nodeIndex="2866"><span nodeIndex="2867"><span nodeIndex="2868">中配置，使用软盘驱动器</span></span></span><span nodeIndex="2869"><span nodeIndex="2870"><span lang="EN-US" nodeIndex="2871">b</span></span></span><span nodeIndex="2872"><span nodeIndex="2873"><span nodeIndex="2874">来装载文件系统盘。</span></span></span></p>
<p class="MsoNormal" nodeIndex="216"><span nodeIndex="2875"><span nodeIndex="2876"><span lang="EN-US" nodeIndex="2877">floppya: 1_44="Image", status=inserted #</span></span></span><span nodeIndex="2878"><span nodeIndex="2879"><span nodeIndex="2880">内核映像</span></span></span></p>
<p class="MsoNormal" nodeIndex="217"><span nodeIndex="2881"><span nodeIndex="2882"><span lang="EN-US" nodeIndex="2883">floppyb: 1_44=rootimage-0.11, status=inserted #</span></span></span><span nodeIndex="489"><span><span>软盘镜像及其文件系统，该软盘从赵炯博士的</span></span></span><span nodeIndex="2884"><span nodeIndex="2885"><span lang="EN-US" nodeIndex="2886">oldlinux</span></span></span><span nodeIndex="2887"><span nodeIndex="2888"><span nodeIndex="2889">网站上下载的</span></span></span><span nodeIndex="2890"><span nodeIndex="2891"><span lang="EN-US" nodeIndex="2892">linux-0.11-devel-040923</span></span></span><span nodeIndex="490"><span><span>压缩包中可以找到，当然也可以自己制作。</span></span></span></p>
<p class="MsoNormal" nodeIndex="218"><span nodeIndex="2893"><span nodeIndex="2894"><span nodeIndex="2895">（</span></span></span><span nodeIndex="2896"><span nodeIndex="2897"><span lang="EN-US" nodeIndex="2898">2</span></span></span><span nodeIndex="2899"><span nodeIndex="2900"><span nodeIndex="2901">）</span></span></span><span nodeIndex="2902"><span nodeIndex="2903"><span nodeIndex="2904">修改</span></span></span><span nodeIndex="2905"><span nodeIndex="2906"><span lang="EN-US" nodeIndex="2907">Image</span></span></span><span nodeIndex="2908"><span nodeIndex="2909"><span nodeIndex="2910">的生成工具</span></span></span><span nodeIndex="2911"><span nodeIndex="2912"><span lang="EN-US" nodeIndex="2913">----build</span></span></span><span nodeIndex="2914"><span nodeIndex="2915"><span nodeIndex="2916">。在</span></span></span><span nodeIndex="2917"><span nodeIndex="2918"><span lang="EN-US" nodeIndex="2919">tool</span></span></span><span nodeIndex="2920"><span nodeIndex="2921"><span nodeIndex="2922">目录下打开</span></span></span><span nodeIndex="2923"><span nodeIndex="2924"><span lang="EN-US" nodeIndex="2925">build.c</span></span></span><span nodeIndex="2926"><span nodeIndex="2927"><span nodeIndex="2928">，做如图</span></span></span><span nodeIndex="2929"><span nodeIndex="2930"><span lang="EN-US" nodeIndex="2931">3.8</span></span></span><span nodeIndex="2932"><span nodeIndex="2933"><span nodeIndex="2934">所示修改，将设备号设置为</span></span></span><span nodeIndex="2935"><span nodeIndex="2936"><span lang="EN-US" nodeIndex="2937">021d</span></span></span><span nodeIndex="2938"><span nodeIndex="2939"><span nodeIndex="2940">。</span></span></span></p>

<div id="RIL_IMG_23" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/23"/></div>
<p class="MsoNormal" nodeIndex="221"><span nodeIndex="2944"><span nodeIndex="2945"><span nodeIndex="2946">图</span></span></span><span nodeIndex="2947"><span nodeIndex="2948"><span lang="EN-US" nodeIndex="2949">3.8</span></span></span></p>

<p class="MsoNormal" nodeIndex="223"><span nodeIndex="2950"><span nodeIndex="2951"><span nodeIndex="2952">（</span></span></span><span nodeIndex="2953"><span nodeIndex="2954"><span lang="EN-US" nodeIndex="2955">3</span></span></span><span nodeIndex="2956"><span nodeIndex="2957"><span nodeIndex="2958">）</span></span></span><span nodeIndex="2959"><span nodeIndex="2960"><span nodeIndex="2961">在引导程序</span></span></span><span nodeIndex="2962"><span nodeIndex="2963"><span lang="EN-US" nodeIndex="2964">bootsect.S</span></span></span><span nodeIndex="2965"><span nodeIndex="2966"><span nodeIndex="2967">中修改</span></span></span><span nodeIndex="2968"><span nodeIndex="2969"><span lang="EN-US" nodeIndex="2970">ROOT_DEV</span></span></span><span nodeIndex="2971"><span nodeIndex="2972"><span nodeIndex="2973">常量的值为根设备号，如图</span></span></span><span nodeIndex="2974"><span nodeIndex="2975"><span lang="EN-US" nodeIndex="2976">3.9</span></span></span><span nodeIndex="2977"><span nodeIndex="2978"><span nodeIndex="2979">所示。</span></span></span></p>


<p class="MsoNormal" nodeIndex="226"><span nodeIndex="2985"><span nodeIndex="2986"><span nodeIndex="2987">图</span></span></span><span nodeIndex="2988"><span nodeIndex="2989"><span lang="EN-US" nodeIndex="2990">3.9</span></span></span></p>

<p class="MsoNormal" nodeIndex="228"><span nodeIndex="2991"><span nodeIndex="2992"><span nodeIndex="2993">内核中的</span></span></span><span nodeIndex="2994"><span nodeIndex="2995"><span lang="EN-US" nodeIndex="2996">ROOT_DEV</span></span></span><span nodeIndex="491"><span><span>不用修改或者复制，因为在系统初始化时（</span></span></span><span nodeIndex="2997"><span nodeIndex="2998"><span lang="EN-US" nodeIndex="2999">main</span></span></span><span nodeIndex="3000"><span nodeIndex="3001"><span nodeIndex="3002">函数开始），使用</span></span></span><span nodeIndex="3003"><span nodeIndex="3004"><span lang="EN-US" nodeIndex="3005">ORIG_ROOT_DEV</span></span></span><span nodeIndex="3006"><span nodeIndex="3007"><span nodeIndex="3008">初始化了该变量，而</span></span></span><span nodeIndex="3009"><span nodeIndex="3010"><span lang="EN-US" nodeIndex="3011">ORIG_ROOT_DEV</span></span></span><span nodeIndex="3012"><span nodeIndex="3013"><span nodeIndex="3014">指向</span></span></span><span nodeIndex="3015"><span nodeIndex="3016"><span lang="EN-US" nodeIndex="3017">bootsect</span></span></span><span nodeIndex="3018"><span nodeIndex="3019"><span nodeIndex="3020">中</span></span></span><span nodeIndex="3021"><span nodeIndex="3022"><span lang="EN-US" nodeIndex="3023">INITSEG</span></span></span><span nodeIndex="3024"><span nodeIndex="3025"><span nodeIndex="3026">（初始化段）中的内存单元，在引导程序中已被赋值成</span></span></span><span nodeIndex="3027"><span nodeIndex="3028"><span lang="EN-US" nodeIndex="3029">021d</span></span></span><span nodeIndex="3030"><span nodeIndex="3031"><span nodeIndex="3032">。</span></span></span></p>
<p class="MsoNormal" nodeIndex="229"><span nodeIndex="3033"><span nodeIndex="3034"><span nodeIndex="3035">完成上述配置后，从</span></span></span><span nodeIndex="3036"><span nodeIndex="3037"><span lang="EN-US" nodeIndex="3038">linux-0.11-devel-040923</span></span></span><span nodeIndex="3039"><span nodeIndex="3040"><span nodeIndex="3041">中拷贝</span></span></span><span nodeIndex="3042"><span nodeIndex="3043"><span lang="EN-US" nodeIndex="3044">rootimage-0.11</span></span></span><span nodeIndex="3045"><span nodeIndex="3046"><span nodeIndex="3047">软盘文件系统到本编译的根目录下，</span></span></span><span nodeIndex="3051"><span nodeIndex="3052"><span lang="EN-US" nodeIndex="3053">make</span></span></span><span nodeIndex="3054"><span nodeIndex="3055"><span nodeIndex="3056">、运行，结果如图</span></span></span><span nodeIndex="3057"><span nodeIndex="3058"><span lang="EN-US" nodeIndex="3059">3.10</span></span></span><span nodeIndex="3060"><span nodeIndex="3061"><span nodeIndex="3062">所示。</span></span></span></p>


<div id="RIL_IMG_24" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/24"/></div>
<p class="MsoNormal" nodeIndex="233"><span nodeIndex="3066"><span nodeIndex="3067"><span nodeIndex="3068">图</span></span></span><span nodeIndex="3069"><span nodeIndex="3070"><span lang="EN-US" nodeIndex="3071">3.10</span></span></span></p>

<p class="MsoNormal" nodeIndex="235"><span nodeIndex="3072"><span nodeIndex="3073"><span nodeIndex="3074">问题</span></span></span><span nodeIndex="3075"><span nodeIndex="3076"><span lang="EN-US" nodeIndex="3077">4</span></span></span><span nodeIndex="3078"><span nodeIndex="3079"><span nodeIndex="3080">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="236"><span nodeIndex="3081"><span nodeIndex="3082"><span nodeIndex="3083">这个问题也比较清晰，在</span></span></span><span nodeIndex="3084"><span nodeIndex="3085"><span lang="EN-US" nodeIndex="3086">source insight</span></span></span><span nodeIndex="3087"><span nodeIndex="3088"><span nodeIndex="3089">中搜索</span></span></span><span nodeIndex="3090"><span nodeIndex="3091"><span lang="EN-US" nodeIndex="3092">Bad data_limit</span></span></span><span nodeIndex="3093"><span nodeIndex="3094"><span nodeIndex="3095">的引用便可以查到是在</span></span></span><span nodeIndex="3096"><span nodeIndex="3097"><span lang="EN-US" nodeIndex="3098">copy_mem</span></span></span><span nodeIndex="3099"><span nodeIndex="3100"><span nodeIndex="3101">中的出错信息，可见</span></span></span><span nodeIndex="3102"><span nodeIndex="3103"><span lang="EN-US" nodeIndex="3104">fork</span></span></span><span nodeIndex="3105"><span nodeIndex="3106"><span nodeIndex="3107">调用仍然创建进程失败。</span></span></span><span nodeIndex="3108"><span nodeIndex="3109"><span lang="EN-US" nodeIndex="3110">copy_mem()</span></span></span><span nodeIndex="3111"><span nodeIndex="3112"><span nodeIndex="3113">在</span></span></span><span nodeIndex="3114"><span nodeIndex="3115"><span lang="EN-US" nodeIndex="3116">fork.c</span></span></span><span nodeIndex="3117"><span nodeIndex="3118"><span nodeIndex="3119">中由</span></span></span><span nodeIndex="3120"><span nodeIndex="3121"><span lang="EN-US" nodeIndex="3122">copy_process()</span></span></span><span nodeIndex="3123"><span nodeIndex="3124"><span nodeIndex="3125">调用。如图</span></span></span><span nodeIndex="3126"><span nodeIndex="3127"><span lang="EN-US" nodeIndex="3128">3.11</span></span></span><span nodeIndex="3129"><span nodeIndex="3130"><span nodeIndex="3131">所示，</span></span></span><span nodeIndex="3132"><span nodeIndex="3133"><span lang="EN-US" nodeIndex="3134">copy_mem</span></span></span><span nodeIndex="3135"><span nodeIndex="3136"><span nodeIndex="3137">首先用</span></span></span><span nodeIndex="3138"><span nodeIndex="3139"><span lang="EN-US" nodeIndex="3140">get_base</span></span></span><span nodeIndex="3141"><span nodeIndex="3142"><span nodeIndex="3143">函数取进程</span></span></span><span nodeIndex="3144"><span nodeIndex="3145"><span lang="EN-US" nodeIndex="3146">0</span></span></span><span nodeIndex="3147"><span nodeIndex="3148"><span nodeIndex="3149">的代码段和数据段基址，检查是否相等（早期的</span></span></span><span nodeIndex="3150"><span nodeIndex="3151"><span lang="EN-US" nodeIndex="3152">linux</span></span></span><span nodeIndex="3153"><span nodeIndex="3154"><span nodeIndex="3155">二者是相等的），然后就出错了。</span></span></span></p>
<div id="RIL_IMG_25" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/25"/></div>
<p class="MsoNormal" nodeIndex="238"><span nodeIndex="3159"><span nodeIndex="3160"><span nodeIndex="3161">图</span></span></span><span nodeIndex="3162"><span nodeIndex="3163"><span lang="EN-US" nodeIndex="3164">3.11</span></span></span></p>

<p class="MsoNormal" nodeIndex="240"><span nodeIndex="3165"><span nodeIndex="3166"><span lang="EN-US" nodeIndex="3167">Bochs</span></span></span><span nodeIndex="3168"><span nodeIndex="3169"><span nodeIndex="3170">调试跟踪并查看</span></span></span><span nodeIndex="3171"><span nodeIndex="3172"><span lang="EN-US" nodeIndex="3173">copy_mem</span></span></span><span nodeIndex="3174"><span nodeIndex="3175"><span nodeIndex="3176">函数汇编如图</span></span></span><span nodeIndex="3177"><span nodeIndex="3178"><span lang="EN-US" nodeIndex="3179">3.12</span></span></span><span nodeIndex="3180"><span nodeIndex="3181"><span nodeIndex="3182">所示。每个红色括号包括一个</span></span></span><span nodeIndex="3183"><span nodeIndex="3184"><span lang="EN-US" nodeIndex="3185">get_base</span></span></span><span nodeIndex="3186"><span nodeIndex="3187"><span nodeIndex="3188">内联函数的汇编码。显而易见，两个</span></span></span><span nodeIndex="3189"><span nodeIndex="3190"><span lang="EN-US" nodeIndex="3191">get_base</span></span></span><span nodeIndex="492"><span><span>调用的汇编语句数量居然不同，而且后者直接使用了前者生成的</span></span></span><span nodeIndex="3192"><span nodeIndex="3193"><span lang="EN-US" nodeIndex="3194">edx</span></span></span><span nodeIndex="3195"><span nodeIndex="3196"><span nodeIndex="3197">数据，对于两个独立的函数调用这当然是不允许的。后一个</span></span></span><span nodeIndex="3198"><span nodeIndex="3199"><span lang="EN-US" nodeIndex="3200">get_base</span></span></span><span nodeIndex="3201"><span nodeIndex="3202"><span nodeIndex="3203">必须重新给</span></span></span><span nodeIndex="3204"><span nodeIndex="3205"><span lang="EN-US" nodeIndex="3206">edx</span></span></span><span nodeIndex="3207"><span nodeIndex="3208"><span nodeIndex="3209">赋值。</span></span></span></p>

<div id="RIL_IMG_26" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/26"/></div>
<p class="MsoNormal" nodeIndex="243"><span nodeIndex="3213"><span nodeIndex="3214"><span nodeIndex="3215">图</span></span></span><span nodeIndex="3216"><span nodeIndex="3217"><span lang="EN-US" nodeIndex="3218">3.12</span></span></span></p>

<p class="MsoNormal" nodeIndex="245"><span nodeIndex="3219"><span nodeIndex="3220"><span nodeIndex="3221">如图</span></span></span><span nodeIndex="3222"><span nodeIndex="3223"><span lang="EN-US" nodeIndex="3224">3.13</span></span></span><span nodeIndex="493"><span><span>所示，增加下划线标注的语句，每次调用先保存和恢复</span></span></span><span nodeIndex="3225"><span nodeIndex="3226"><span lang="EN-US" nodeIndex="3227">edx</span></span></span><span nodeIndex="3228"><span nodeIndex="3229"><span nodeIndex="3230">的值。</span></span></span></p>

<div id="RIL_IMG_27" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/27"/></div>
<p class="MsoNormal" nodeIndex="248"><span nodeIndex="3234"><span nodeIndex="3235"><span nodeIndex="3236">图</span></span></span><span nodeIndex="3237"><span nodeIndex="3238"><span lang="EN-US" nodeIndex="3239">3.13</span></span></span></p>


<p class="MsoNormal" nodeIndex="251"><span nodeIndex="3240"><span nodeIndex="3241"><span nodeIndex="3242">问题</span></span></span><span nodeIndex="3243"><span nodeIndex="3244"><span lang="EN-US" nodeIndex="3245">5</span></span></span></p>
<p class="MsoNormal" nodeIndex="252"><span nodeIndex="494"><span><span>十分遗憾，这个问题的运行图没留下来，因为那几天太忙了，总想赶快调完，结果欲速却不达。好了，进行上述修改后，</span></span></span><span nodeIndex="3246"><span nodeIndex="3247"><span lang="EN-US" nodeIndex="3248">init</span></span></span><span nodeIndex="495"><span><span>进程可以运行起来了，但却显示打不开文件，查看</span></span></span><span nodeIndex="3249"><span nodeIndex="3250"><span lang="EN-US" nodeIndex="3251">init</span></span></span><span nodeIndex="3252"><span nodeIndex="3253"><span nodeIndex="3254">代码可知，现在无法打开</span></span></span><span nodeIndex="3255"><span nodeIndex="3256"><span lang="EN-US" nodeIndex="3257">/dev/tty0</span></span></span><span nodeIndex="3258"><span nodeIndex="3259"><span nodeIndex="3260">。到底</span></span></span><span nodeIndex="3261"><span nodeIndex="3262"><span lang="EN-US" nodeIndex="3263">open</span></span></span><span nodeIndex="3264"><span nodeIndex="3265"><span nodeIndex="3266">系统调用哪里出现了问题呢？先看看</span></span></span><span nodeIndex="3267"><span nodeIndex="3268"><span lang="EN-US" nodeIndex="3269">open</span></span></span><span nodeIndex="3270"><span nodeIndex="3271"><span nodeIndex="3272">系统调用的函数调用关系：</span></span></span><span nodeIndex="3273"><span nodeIndex="3274"><span lang="EN-US" nodeIndex="3275">sys_open->open_namei->dir_namei->get_dir</span></span></span><span nodeIndex="3276"><span nodeIndex="3277"><span nodeIndex="3278">。使用</span></span></span><span nodeIndex="3279"><span nodeIndex="3280"><span lang="EN-US" nodeIndex="3281">bochs</span></span></span><span nodeIndex="3282"><span nodeIndex="3283"><span nodeIndex="3284">调试功能一步一步进行跟踪，发现</span></span></span><span nodeIndex="3285"><span nodeIndex="3286"><span lang="EN-US" nodeIndex="3287">get_dir</span></span></span><span nodeIndex="3288"><span nodeIndex="3289"><span nodeIndex="3290">中使用</span></span></span><span nodeIndex="3291"><span nodeIndex="3292"><span lang="EN-US" nodeIndex="3293">get_fs_byte</span></span></span><span nodeIndex="3294"><span nodeIndex="3295"><span nodeIndex="3296">无法获取路径字符串的值。</span></span></span></p>
<p class="MsoNormal" nodeIndex="253"><span nodeIndex="3297"><span nodeIndex="3298"><span lang="EN-US" nodeIndex="3299">get_fs_byte</span></span></span><span nodeIndex="3300"><span nodeIndex="3301"><span nodeIndex="3302">的作用是使用</span></span></span><span nodeIndex="3303"><span nodeIndex="3304"><span lang="EN-US" nodeIndex="3305">fs</span></span></span><span nodeIndex="3306"><span nodeIndex="3307"><span nodeIndex="3308">中的值作为数据段选择子来访问内存地址一个字节数据。进程</span></span></span><span nodeIndex="3309"><span nodeIndex="3310"><span lang="EN-US" nodeIndex="3311">1</span></span></span><span nodeIndex="3312"><span nodeIndex="3313"><span nodeIndex="3314">的局部变量</span></span></span><span nodeIndex="3315"><span nodeIndex="3316"><span lang="EN-US" nodeIndex="3317">” /dev/tty0”</span></span></span><span nodeIndex="3318"><span nodeIndex="3319"><span nodeIndex="3320">的首地址</span></span></span><span nodeIndex="3321"><span nodeIndex="3322"><span lang="EN-US" nodeIndex="3323">addr</span></span></span><span nodeIndex="3324"><span nodeIndex="3325"><span nodeIndex="3326">一定保存在该进程的栈里，若在进程</span></span></span><span nodeIndex="3327"><span nodeIndex="3328"><span lang="EN-US" nodeIndex="3329">1</span></span></span><span nodeIndex="3330"><span nodeIndex="3331"><span nodeIndex="3332">中访问该变量应该是这种形式：</span></span></span><span nodeIndex="3333"><span nodeIndex="3334"><span lang="EN-US" nodeIndex="3335">ds:addr</span></span></span><span nodeIndex="3336"><span nodeIndex="3337"><span nodeIndex="3338">（</span></span></span><span nodeIndex="3339"><span nodeIndex="3340"><span lang="EN-US" nodeIndex="3341">ds</span></span></span><span nodeIndex="3342"><span nodeIndex="3343"><span nodeIndex="3344">就是数据段的意思，根据</span></span></span><span nodeIndex="3345"><span nodeIndex="3346"><span lang="EN-US" nodeIndex="3347">ds</span></span></span><span nodeIndex="496"><span><span>可得到数据段选择子，从而得到数据段基地址，加上偏移地址</span></span></span><span nodeIndex="3348"><span nodeIndex="3349"><span lang="EN-US" nodeIndex="3350">addr</span></span></span><span nodeIndex="3351"><span nodeIndex="3352"><span nodeIndex="3353">便是线性地址，</span></span></span><span nodeIndex="3354"><span nodeIndex="3355"><span lang="EN-US" nodeIndex="3356">linux-0.11</span></span></span><span nodeIndex="3357"><span nodeIndex="3358"><span nodeIndex="3359">内存完全分页，故而已</span></span></span><span nodeIndex="3360"><span nodeIndex="3361"><span lang="EN-US" nodeIndex="3362">0</span></span></span><span nodeIndex="3363"><span nodeIndex="3364"><span nodeIndex="3365">为基地址的数据段其局部变量的线性地址</span></span></span><span nodeIndex="3366"><span nodeIndex="3367"><span lang="EN-US" nodeIndex="3368">==</span></span></span><span nodeIndex="3369"><span nodeIndex="3370"><span nodeIndex="3371">物理地址）。在进程内部</span></span></span><span nodeIndex="3372"><span nodeIndex="3373"><span lang="EN-US" nodeIndex="3374">ds</span></span></span><span nodeIndex="3375"><span nodeIndex="3376"><span nodeIndex="3377">、</span></span></span><span nodeIndex="3378"><span nodeIndex="3379"><span lang="EN-US" nodeIndex="3380">fs</span></span></span><span nodeIndex="497"><span><span>的值都是该进程数据段的首地址，而若在内核态访问该进程的局部变量就不应该使用</span></span></span><span nodeIndex="3381"><span nodeIndex="3382"><span lang="EN-US" nodeIndex="3383">ds</span></span></span><span nodeIndex="3384"><span nodeIndex="3385"><span nodeIndex="3386">（包含内核态数据段选择子）了，而应该用：</span></span></span><span nodeIndex="3387"><span nodeIndex="3388"><span lang="EN-US" nodeIndex="3389">fs: addr</span></span></span><span nodeIndex="3390"><span nodeIndex="3391"><span nodeIndex="3392">（</span></span></span><span nodeIndex="3393"><span nodeIndex="3394"><span lang="EN-US" nodeIndex="3395">fs</span></span></span><span nodeIndex="3396"><span nodeIndex="3397"><span nodeIndex="3398">指向的数据段的基地址</span></span></span><span nodeIndex="3399"><span nodeIndex="3400"><span lang="EN-US" nodeIndex="3401">+addr</span></span></span><span nodeIndex="3402"><span nodeIndex="3403"><span nodeIndex="3404">就是线性地址）</span></span></span><span nodeIndex="3405"><span nodeIndex="3406"><span nodeIndex="3407">，因为</span></span></span><span nodeIndex="3408"><span nodeIndex="3409"><span lang="EN-US" nodeIndex="3410">linux-0.11</span></span></span><span nodeIndex="498"><span><span>为了能在内核态访问用户态的数据，由用户态在进入内核态时没有修改</span></span></span><span nodeIndex="3411"><span nodeIndex="3412"><span lang="EN-US" nodeIndex="3413">fs</span></span></span><span nodeIndex="3414"><span nodeIndex="3415"><span nodeIndex="3416">的值，即</span></span></span><span nodeIndex="3417"><span nodeIndex="3418"><span lang="EN-US" nodeIndex="3419">fs</span></span></span><span nodeIndex="3420"><span nodeIndex="3421"><span nodeIndex="3422">仍然包含用户态某一进程的数据段选择子。</span></span></span></p>
<p class="MsoNormal" nodeIndex="254"><span nodeIndex="3423"><span nodeIndex="3424"><span nodeIndex="3425">因此要特别注意不能在</span></span></span><span nodeIndex="3426"><span nodeIndex="3427"><span lang="EN-US" nodeIndex="3428">get_dir</span></span></span><span nodeIndex="3429"><span nodeIndex="3430"><span nodeIndex="3431">中直接使用</span></span></span><span nodeIndex="3432"><span nodeIndex="3433"><span lang="EN-US" nodeIndex="3434">printk</span></span></span><span nodeIndex="3435"><span nodeIndex="3436"><span nodeIndex="3437">输出</span></span></span><span nodeIndex="3438"><span nodeIndex="3439"><span lang="EN-US" nodeIndex="3440">pathname</span></span></span><span nodeIndex="3441"><span nodeIndex="3442"><span nodeIndex="3443">来验证函数传参的正确性，因为</span></span></span><span nodeIndex="3444"><span nodeIndex="3445"><span lang="EN-US" nodeIndex="3446">printk</span></span></span><span nodeIndex="3447"><span nodeIndex="3448"><span nodeIndex="3449">访问</span></span></span><span nodeIndex="3450"><span nodeIndex="3451"><span lang="EN-US" nodeIndex="3452">pathname</span></span></span><span nodeIndex="3453"><span nodeIndex="3454"><span nodeIndex="3455">肯定是以</span></span></span><span nodeIndex="3456"><span nodeIndex="3457"><span lang="EN-US" nodeIndex="3458">ds</span></span></span><span nodeIndex="3459"><span nodeIndex="3460"><span nodeIndex="3461">作为数据段的，而</span></span></span><span nodeIndex="3462"><span nodeIndex="3463"><span lang="EN-US" nodeIndex="3464">pathname</span></span></span><span nodeIndex="3465"><span nodeIndex="3466"><span nodeIndex="3467">指向的变量在</span></span></span><span nodeIndex="3468"><span nodeIndex="3469"><span lang="EN-US" nodeIndex="3470">fs</span></span></span><span nodeIndex="3471"><span nodeIndex="3472"><span nodeIndex="3473">（用户态）数据段中。而且这里还有一个特别迷惑性的状况：使用</span></span></span><span nodeIndex="3474"><span nodeIndex="3475"><span lang="EN-US" nodeIndex="3476">printk</span></span></span><span nodeIndex="3477"><span nodeIndex="3478"><span nodeIndex="3479">输出</span></span></span><span nodeIndex="3480"><span nodeIndex="3481"><span lang="EN-US" nodeIndex="3482">”/dev/tty0”</span></span></span><span nodeIndex="499"><span><span>字符串是成功的，让人误以为这里没问题，其实大错特错，因为这只是一种特殊的情况。由于编译器在编译时，把所有它能看见的代码放到一起，并以</span></span></span><span nodeIndex="3483"><span nodeIndex="3484"><span lang="EN-US" nodeIndex="3485">0</span></span></span><span nodeIndex="3486"><span nodeIndex="3487"><span nodeIndex="3488">为基地址为每个函数局部变量分配地址</span></span></span><span nodeIndex="3489"><span nodeIndex="3490"><span lang="EN-US" nodeIndex="3491">addr</span></span></span><span nodeIndex="3492"><span nodeIndex="3493"><span nodeIndex="3494">。编译器不知道</span></span></span><span nodeIndex="3495"><span nodeIndex="3496"><span lang="EN-US" nodeIndex="3497">init</span></span></span><span nodeIndex="3498"><span nodeIndex="3499"><span nodeIndex="3500">函数是一个数据段基地址非</span></span></span><span nodeIndex="3501"><span nodeIndex="3502"><span lang="EN-US" nodeIndex="3503">0</span></span></span><span nodeIndex="3504"><span nodeIndex="3505"><span nodeIndex="3506">的进程体，因此不论在内核态还是用户态，以</span></span></span><span nodeIndex="3507"><span nodeIndex="3508"><span lang="EN-US" nodeIndex="3509">0</span></span></span><span nodeIndex="3510"><span nodeIndex="3511"><span nodeIndex="3512">为数据段基地址，</span></span></span><span nodeIndex="3513"><span nodeIndex="3514"><span lang="EN-US" nodeIndex="3515">addr</span></span></span><span nodeIndex="3516"><span nodeIndex="3517"><span nodeIndex="3518">为偏移地址肯定能访问得到想要的局部变量。因此这里</span></span></span><span nodeIndex="3519"><span nodeIndex="3520"><span lang="EN-US" nodeIndex="3521">get_dir</span></span></span><span nodeIndex="3522"><span nodeIndex="3523"><span nodeIndex="3524">函数虽然在内核态，还是可以通过</span></span></span><span nodeIndex="3525"><span nodeIndex="3526"><span lang="EN-US" nodeIndex="3527">ds:addr</span></span></span><span nodeIndex="3528"><span nodeIndex="3529"><span nodeIndex="3530">访问得到</span></span></span><span nodeIndex="3531"><span nodeIndex="3532"><span lang="EN-US" nodeIndex="3533">pathname</span></span></span><span nodeIndex="3534"><span nodeIndex="3535"><span nodeIndex="3536">的值。而进程</span></span></span><span nodeIndex="3537"><span nodeIndex="3538"><span lang="EN-US" nodeIndex="3539">1</span></span></span><span nodeIndex="3540"><span nodeIndex="3541"><span nodeIndex="3542">的数据段基地址是</span></span></span><span nodeIndex="3543"><span nodeIndex="3544"><span lang="EN-US" nodeIndex="3545">0x4000000</span></span></span><span nodeIndex="3546"><span nodeIndex="3547"><span nodeIndex="3548">（每个进程</span></span></span><span nodeIndex="3549"><span nodeIndex="3550"><span lang="EN-US" nodeIndex="3551">64M</span></span></span><span nodeIndex="3552"><span nodeIndex="3553"><span nodeIndex="3554">虚拟空间），在</span></span></span><span nodeIndex="3555"><span nodeIndex="3556"><span lang="EN-US" nodeIndex="3557">fork</span></span></span><span nodeIndex="3558"><span nodeIndex="3559"><span nodeIndex="3560">创建的时候共享了父进程的页表，故而</span></span></span><span nodeIndex="3561"><span nodeIndex="3562"><span lang="EN-US" nodeIndex="3563">0x4000000+addr</span></span></span><span nodeIndex="500"><span><span>同样可以访问该字符串的值，而且这种方式才是正确的方式，</span></span></span><span nodeIndex="3564"><span nodeIndex="3565"><span lang="EN-US" nodeIndex="3566">get_fs_byte</span></span></span><span nodeIndex="3567"><span nodeIndex="3568"><span nodeIndex="3569">使用的就是这种方式。总之，这里无论是用</span></span></span><span nodeIndex="3570"><span nodeIndex="3571"><span lang="EN-US" nodeIndex="3572">0+addr</span></span></span><span nodeIndex="3573"><span nodeIndex="3574"><span nodeIndex="3575">（</span></span></span><span nodeIndex="3576"><span nodeIndex="3577"><span lang="EN-US" nodeIndex="3578">ds:addr</span></span></span><span nodeIndex="3579"><span nodeIndex="3580"><span nodeIndex="3581">）还是</span></span></span><span nodeIndex="3582"><span nodeIndex="3583"><span lang="EN-US" nodeIndex="3584">0x4000000+addr</span></span></span><span nodeIndex="3585"><span nodeIndex="3586"><span nodeIndex="3587">（</span></span></span><span nodeIndex="3588"><span nodeIndex="3589"><span lang="EN-US" nodeIndex="3590">fs:addr</span></span></span><span nodeIndex="501"><span><span>）都应该可以访问到该字符串。如果进程的代码不是编译器可见的，比如</span></span></span><span nodeIndex="3591"><span nodeIndex="3592"><span lang="EN-US" nodeIndex="3593">execeve</span></span></span><span nodeIndex="3594"><span nodeIndex="3595"><span nodeIndex="3596">之后从文件系统加载的</span></span></span><span nodeIndex="3597"><span nodeIndex="3598"><span lang="EN-US" nodeIndex="3599">shell</span></span></span><span nodeIndex="3600"><span nodeIndex="3601"><span nodeIndex="3602">可执行文件，那么它的局部变量就不能从以</span></span></span><span nodeIndex="3603"><span nodeIndex="3604"><span lang="EN-US" nodeIndex="3605">0</span></span></span><span nodeIndex="502"><span><span>为基地址的数据段访问（编译器未为其局部变量分配空间），只能用该进程数据段的基地址加偏移来访问了，这时，内核态就无法使用</span></span></span><span nodeIndex="3606"><span nodeIndex="3607"><span lang="EN-US" nodeIndex="3608">printk</span></span></span><span nodeIndex="3609"><span nodeIndex="3610"><span nodeIndex="3611">输出</span></span></span><span nodeIndex="3612"><span nodeIndex="3613"><span lang="EN-US" nodeIndex="3614">pathname</span></span></span><span nodeIndex="3615"><span nodeIndex="3616"><span nodeIndex="3617">了。这一点曾经差点纠结死我。</span></span></span></p>
<p class="MsoNormal" nodeIndex="255"><span nodeIndex="3618"><span nodeIndex="3619"><span nodeIndex="3620">还要注意，在</span></span></span><span nodeIndex="3621"><span nodeIndex="3622"><span lang="EN-US" nodeIndex="3623">linux-0.11</span></span></span><span nodeIndex="3624"><span nodeIndex="3625"><span nodeIndex="3626">中倘若进程的数据段以</span></span></span><span nodeIndex="3627"><span nodeIndex="3628"><span lang="EN-US" nodeIndex="3629">0</span></span></span><span nodeIndex="3630"><span nodeIndex="3631"><span nodeIndex="3632">为基地址，那么其局部变量的线性地址</span></span></span><span nodeIndex="3633"><span nodeIndex="3634"><span lang="EN-US" nodeIndex="3635">==</span></span></span><span nodeIndex="3636"><span nodeIndex="3637"><span nodeIndex="3638">物理地址，因为</span></span></span><span nodeIndex="3639"><span nodeIndex="3640"><span lang="EN-US" nodeIndex="3641">linux</span></span></span><span nodeIndex="3642"><span nodeIndex="3643"><span nodeIndex="3644">分页管理是从</span></span></span><span nodeIndex="3645"><span nodeIndex="3646"><span lang="EN-US" nodeIndex="3647">0</span></span></span><span nodeIndex="3648"><span nodeIndex="3649"><span nodeIndex="3650">开始完全分页的（学习内存管理时，理解这一点很重要）。</span></span></span></p>
<p class="MsoNormal" nodeIndex="256"><span nodeIndex="3651"><span nodeIndex="3652"><span nodeIndex="3653">根据</span></span></span><span nodeIndex="3654"><span nodeIndex="3655"><span lang="EN-US" nodeIndex="3656">get_dir</span></span></span><span nodeIndex="3657"><span nodeIndex="3658"><span nodeIndex="3659">中使用</span></span></span><span nodeIndex="3660"><span nodeIndex="3661"><span lang="EN-US" nodeIndex="3662">get_fs_byte</span></span></span><span nodeIndex="3663"><span nodeIndex="3664"><span nodeIndex="3665">无法获取路径字符串的值这一现象，我用</span></span></span><span nodeIndex="3666"><span nodeIndex="3667"><span lang="EN-US" nodeIndex="3668">x</span></span></span><span nodeIndex="3669"><span nodeIndex="3670"><span nodeIndex="3671">命令查看了</span></span></span><span nodeIndex="3672"><span nodeIndex="3673"><span lang="EN-US" nodeIndex="3674">fs</span></span></span><span nodeIndex="503"><span><span>选择子所指向的数据段描述符，从中提取的基地址却不是</span></span></span><span nodeIndex="3675"><span nodeIndex="3676"><span lang="EN-US" nodeIndex="3677">0x4000000</span></span></span><span nodeIndex="3678"><span nodeIndex="3679"><span nodeIndex="3680">，那么这就是原因所在了。一定是</span></span></span><span nodeIndex="3681"><span nodeIndex="3682"><span lang="EN-US" nodeIndex="3683">fork</span></span></span><span nodeIndex="3684"><span nodeIndex="3685"><span nodeIndex="3686">创建进程</span></span></span><span nodeIndex="3687"><span nodeIndex="3688"><span lang="EN-US" nodeIndex="3689">1</span></span></span><span nodeIndex="3690"><span nodeIndex="3691"><span nodeIndex="3692">时，在</span></span></span><span nodeIndex="3693"><span nodeIndex="3694"><span lang="EN-US" nodeIndex="3695">copy_mem()</span></span></span><span nodeIndex="3696"><span nodeIndex="3697"><span nodeIndex="3698">中没能给新进程设置正确的数据段基地址，查看</span></span></span><span nodeIndex="3699"><span nodeIndex="3700"><span lang="EN-US" nodeIndex="3701">copy_mem()</span></span></span><span nodeIndex="3702"><span nodeIndex="3703"><span nodeIndex="3704">汇编码如图</span></span></span><span nodeIndex="3705"><span nodeIndex="3706"><span lang="EN-US" nodeIndex="3707">3.14</span></span></span><span nodeIndex="3708"><span nodeIndex="3709"><span nodeIndex="3710">所示，红色括号标注的是该函数连续两次调用的</span></span></span><span nodeIndex="3711"><span nodeIndex="3712"><span lang="EN-US" nodeIndex="3713">set_base</span></span></span><span nodeIndex="504"><span><span>函数，为数据段和代码段设置基地址。很明显先后两次调用的函数体汇编码数量却不一样，而且第二次调用直接使用了第一次使用的</span></span></span><span nodeIndex="3714"><span nodeIndex="3715"><span lang="EN-US" nodeIndex="3716">edx</span></span></span><span nodeIndex="3717"><span nodeIndex="3718"><span nodeIndex="3719">数值，跟问题</span></span></span><span nodeIndex="3720"><span nodeIndex="3721"><span lang="EN-US" nodeIndex="3722">4</span></span></span><span nodeIndex="3723"><span nodeIndex="3724"><span nodeIndex="3725">一样，这是不允许的。第二次调用之前一定要恢复</span></span></span><span nodeIndex="3726"><span nodeIndex="3727"><span lang="EN-US" nodeIndex="3728">edx</span></span></span><span nodeIndex="3729"><span nodeIndex="3730"><span nodeIndex="3731">第一次调用修改之前的数值。</span></span></span></p>

<div id="RIL_IMG_28" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/28"/></div>
<p class="MsoNormal" nodeIndex="259"><span nodeIndex="3735"><span nodeIndex="3736"><span nodeIndex="3737">图</span></span></span><span nodeIndex="3738"><span nodeIndex="3739"><span lang="EN-US" nodeIndex="3740">3.14</span></span></span></p>

<p class="MsoNormal" nodeIndex="261"><span nodeIndex="3741"><span nodeIndex="3742"><span nodeIndex="3743">因此增加如图</span></span></span><span nodeIndex="3744"><span nodeIndex="3745"><span lang="EN-US" nodeIndex="3746">3.15</span></span></span><span nodeIndex="3747"><span nodeIndex="3748"><span nodeIndex="3749">所标注的指令。</span></span></span><span nodeIndex="3750"><span nodeIndex="3751"><span lang="EN-US" nodeIndex="3752">edx</span></span></span><span nodeIndex="3753"><span nodeIndex="3754"><span nodeIndex="3755">之前循环右移</span></span></span><span nodeIndex="3756"><span nodeIndex="3757"><span lang="EN-US" nodeIndex="3758">16</span></span></span><span nodeIndex="3759"><span nodeIndex="3760"><span nodeIndex="3761">位，函数功能完成后，再循环右移</span></span></span><span nodeIndex="3762"><span nodeIndex="3763"><span lang="EN-US" nodeIndex="3764">16</span></span></span><span nodeIndex="3765"><span nodeIndex="3766"><span nodeIndex="3767">位，恢复原值。</span></span></span></p>

<div id="RIL_IMG_29" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/29"/></div>
<p class="MsoNormal" nodeIndex="264"><span nodeIndex="3771"><span nodeIndex="3772"><span nodeIndex="3773">图</span></span></span><span nodeIndex="3774"><span nodeIndex="3775"><span lang="EN-US" nodeIndex="3776">3.15</span></span></span></p>

<p class="MsoNormal" nodeIndex="266"><span nodeIndex="3777"><span nodeIndex="3778"><span nodeIndex="3779">编译，运行后，情况如图</span></span></span><span nodeIndex="3780"><span nodeIndex="3781"><span lang="EN-US" nodeIndex="3782">3.16</span></span></span><span nodeIndex="3783"><span nodeIndex="3784"><span nodeIndex="3785">所示，新问题出现了。</span></span></span></p>

<div id="RIL_IMG_30" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/30"/></div>
<p class="MsoNormal" nodeIndex="269"><span nodeIndex="3789"><span nodeIndex="3790"><span nodeIndex="3791">图</span></span></span><span nodeIndex="3792"><span nodeIndex="3793"><span lang="EN-US" nodeIndex="3794">3.16</span></span></span></p>

<p class="MsoNormal" nodeIndex="271"><span nodeIndex="3795"><span nodeIndex="3796"><a name="OLE_LINK20" nodeIndex="3797"></a><a name="OLE_LINK19" nodeIndex="3798"><span nodeIndex="3799"><span nodeIndex="3800">问题</span></span></a></span></span><span nodeIndex="3801"><span nodeIndex="3802"><span nodeIndex="3803"><span nodeIndex="3804"><span lang="EN-US" nodeIndex="3805">6</span></span></span></span></span><span nodeIndex="3806"><span nodeIndex="3807"><span nodeIndex="3808"><span nodeIndex="3809"><span nodeIndex="3810">：</span></span></span></span></span></p>
<p class="MsoNormal" nodeIndex="272"><span nodeIndex="3811"><span nodeIndex="3812"><span nodeIndex="3813"><span nodeIndex="3814"><span nodeIndex="3815">这个问题提示信息很不明确，调试也相对麻烦一些。</span></span></span></span></span></p>
<p class="MsoNormal" nodeIndex="273"><span nodeIndex="3816"><span nodeIndex="3817"><span nodeIndex="3818"><span nodeIndex="3819"><span nodeIndex="3820">根据单步、断点等一顿乱调，最后确定出错的位置是</span></span></span></span></span><span nodeIndex="3821"><span nodeIndex="3822"><span nodeIndex="3823"><span nodeIndex="3824"><span lang="EN-US" nodeIndex="3825">do_execve()</span></span></span></span></span><span nodeIndex="3826"><span nodeIndex="3827"><span nodeIndex="3828"><span nodeIndex="3829"><span nodeIndex="3830">中两个</span></span></span></span></span><a name="OLE_LINK22" nodeIndex="3831"></a><a name="OLE_LINK21" nodeIndex="3832"><span nodeIndex="3833"><span nodeIndex="3834"><span nodeIndex="3835"><span nodeIndex="3836"><span nodeIndex="3837"><span lang="EN-US" nodeIndex="3838">free_page_table</span></span></span></span></span></span></a><span nodeIndex="3839"><span nodeIndex="3840"><span nodeIndex="3841"><span nodeIndex="3842"><span nodeIndex="3843">调用出现了问题，源码如图</span></span></span></span></span><span nodeIndex="3844"><span nodeIndex="3845"><span nodeIndex="3846"><span nodeIndex="3847"><span lang="EN-US" nodeIndex="3848">3.17</span></span></span></span></span><span nodeIndex="3849"><span nodeIndex="3850"><span nodeIndex="3851"><span nodeIndex="3852"><span nodeIndex="3853">所示</span></span></span></span></span><span nodeIndex="3854"><span nodeIndex="3855"><span nodeIndex="3856"><span nodeIndex="3857"><span nodeIndex="3858">。（请容我稍微</span></span></span></span></span><span nodeIndex="3859"><span nodeIndex="3860"><span nodeIndex="3861"><span nodeIndex="3862"><span lang="EN-US" nodeIndex="3863">complaint</span></span></span></span></span><span nodeIndex="3864"><span nodeIndex="3865"><span nodeIndex="3866"><span nodeIndex="3867"><span nodeIndex="3868">一下：看看</span></span></span></span></span><span nodeIndex="3869"><span nodeIndex="3870"><span nodeIndex="3871"><span nodeIndex="3872"><span lang="EN-US" nodeIndex="3873">do_execve</span></span></span></span></span><span nodeIndex="3874"><span nodeIndex="3875"><span nodeIndex="3876"><span nodeIndex="3877"><span nodeIndex="3878">那近两百行的</span></span></span></span></span><span nodeIndex="3879"><span nodeIndex="3880"><span nodeIndex="3881"><span nodeIndex="3882"><span lang="EN-US" nodeIndex="3883">c</span></span></span></span></span><span nodeIndex="3884"><span nodeIndex="3885"><span nodeIndex="3886"><span nodeIndex="3887"><span nodeIndex="3888">代码，想想它可能编译出的汇编码数量，你也许可以</span></span></span></span></span><span nodeIndex="3889"><span nodeIndex="3890"><span nodeIndex="3891"><span nodeIndex="3892"><span lang="EN-US" nodeIndex="3893">image</span></span></span></span></span><span nodeIndex="505"><span><span><span><span>一下我定位这个错误费了多大周章，因为这种调试最悲催的一点就是即便用插桩得到了大致位置，也得从函数头单步走过去详细查看，除非你愿意花大量时间将汇编和</span></span></span></span></span><span nodeIndex="3894"><span nodeIndex="3895"><span nodeIndex="3896"><span nodeIndex="3897"><span lang="EN-US" nodeIndex="3898">c</span></span></span></span></span><span nodeIndex="3899"><span nodeIndex="3900"><span nodeIndex="3901"><span nodeIndex="3902"><span nodeIndex="3903">代码一一对应起来</span></span></span></span></span><span nodeIndex="3904"><span nodeIndex="3905"><span nodeIndex="3906"><span nodeIndex="3907"><span lang="EN-US" nodeIndex="3908">…</span></span></span></span></span><span nodeIndex="3909"><span nodeIndex="3910"><span nodeIndex="3911"><span nodeIndex="3912"><span nodeIndex="3913">）。</span></span></span></span></span></p>
<p class="MsoNormal" nodeIndex="274"><span nodeIndex="3914"><span nodeIndex="3915"><span nodeIndex="3916"><span nodeIndex="3917"><span nodeIndex="3918">当我们单步运行第一个</span></span></span></span></span><span nodeIndex="3919"><span nodeIndex="3920"><span nodeIndex="3921"><span nodeIndex="3922"><span lang="EN-US" nodeIndex="3923">free_page_table</span></span></span></span></span><span nodeIndex="3924"><span nodeIndex="3925"><span nodeIndex="3926"><span nodeIndex="3927"><span nodeIndex="3928">时，发现仍旧是</span></span></span></span></span><span nodeIndex="3929"><span nodeIndex="3930"><span nodeIndex="3931"><span nodeIndex="3932"><span lang="EN-US" nodeIndex="3933">get_base()</span></span></span></span></span><span nodeIndex="3934"><span nodeIndex="3935"><span nodeIndex="3936"><span nodeIndex="3937"><span nodeIndex="3938">函数出了问题。</span></span></span></span></span></p>


<p class="MsoNormal" nodeIndex="277"><span nodeIndex="3946"><span nodeIndex="3947"><span nodeIndex="3948"><span nodeIndex="3949"><span nodeIndex="3950">图</span></span></span></span></span><span nodeIndex="3951"><span nodeIndex="3952"><span nodeIndex="3953"><span nodeIndex="3954"><span lang="EN-US" nodeIndex="3955">3.17</span></span></span></span></span></p>

<p class="MsoNormal" nodeIndex="279"><span nodeIndex="3956"><span nodeIndex="3957"><span nodeIndex="3958"><span nodeIndex="3959"><span nodeIndex="3960">分析</span></span></span></span></span><span nodeIndex="3961"><span nodeIndex="3962"><span nodeIndex="3963"><span nodeIndex="3964"><span lang="EN-US" nodeIndex="3965">eflags</span></span></span></span></span><span nodeIndex="3966"><span nodeIndex="3967"><span nodeIndex="3968"><span nodeIndex="3969"><span nodeIndex="3970">寄存器的值，其溢出位为</span></span></span></span></span><span nodeIndex="3971"><span nodeIndex="3972"><span nodeIndex="3973"><span nodeIndex="3974"><span lang="EN-US" nodeIndex="3975">1</span></span></span></span></span><span nodeIndex="3976"><span nodeIndex="3977"><span nodeIndex="3978"><span nodeIndex="3979"><span nodeIndex="3980">，即发生了溢出错误。（注意：</span></span></span></span></span><span nodeIndex="3981"><span nodeIndex="3982"><span nodeIndex="3983"><span nodeIndex="3984"><span lang="EN-US" nodeIndex="3985">linux-0.11</span></span></span></span></span><span nodeIndex="506"><span><span><span><span>被新编译器编译后，错误提示并不正常，提示是</span></span></span></span></span><span nodeIndex="3986"><span nodeIndex="3987"><span nodeIndex="3988"><span nodeIndex="3989"><span lang="EN-US" nodeIndex="3990">divide</span></span></span></span></span><span nodeIndex="3991"><span nodeIndex="3992"><span nodeIndex="3993"><span nodeIndex="3994"><span nodeIndex="3995">异常，但</span></span></span></span></span><span nodeIndex="3996"><span nodeIndex="3997"><span nodeIndex="3998"><span nodeIndex="3999"><span lang="EN-US" nodeIndex="4000">eflags</span></span></span></span></span><span nodeIndex="507"><span><span><span><span>确实溢出错误。这些错误我们姑且放任，先让其能正常运行起来）。</span></span></span></span></span></p>
<p class="MsoNormal" nodeIndex="280"><span nodeIndex="4001"><span nodeIndex="4002"><span nodeIndex="4003"><span nodeIndex="4004"><span nodeIndex="4005">经过单步调试后发现，还是在上述</span></span></span></span></span><span nodeIndex="4006"><span nodeIndex="4007"><span nodeIndex="4008"><span nodeIndex="4009"><span lang="EN-US" nodeIndex="4010">free_page_tables</span></span></span></span></span><span nodeIndex="4011"><span nodeIndex="4012"><span nodeIndex="4013"><span nodeIndex="4014"><span nodeIndex="4015">调用的</span></span></span></span></span><span nodeIndex="4016"><span nodeIndex="4017"><span nodeIndex="4018"><span nodeIndex="4019"><span lang="EN-US" nodeIndex="4020">get_base</span></span></span></span></span><span nodeIndex="4021"><span nodeIndex="4022"><span nodeIndex="4023"><span nodeIndex="4024"><span nodeIndex="4025">内部发生了溢出。查看溢出时的处理器信息如图</span></span></span></span></span><span nodeIndex="4026"><span nodeIndex="4027"><span nodeIndex="4028"><span nodeIndex="4029"><span lang="EN-US" nodeIndex="4030">3.18</span></span></span></span></span><span nodeIndex="4031"><span nodeIndex="4032"><span nodeIndex="4033"><span nodeIndex="4034"><span nodeIndex="4035">所示，</span></span></span></span></span> <span nodeIndex="4036"><span nodeIndex="4037"><span nodeIndex="4038"><span nodeIndex="4039"><span lang="EN-US" nodeIndex="4040">edx</span></span></span></span></span><span nodeIndex="4041"><span nodeIndex="4042"><span nodeIndex="4043"><span nodeIndex="4044"><span nodeIndex="4045">左移</span></span></span></span></span><span nodeIndex="4046"><span nodeIndex="4047"><span nodeIndex="4048"><span nodeIndex="4049"><span lang="EN-US" nodeIndex="4050">16</span></span></span></span></span><span nodeIndex="4051"><span nodeIndex="4052"><span nodeIndex="4053"><span nodeIndex="4054"><span nodeIndex="4055">位时，</span></span></span></span></span><span nodeIndex="4056"><span nodeIndex="4057"><span nodeIndex="4058"><span nodeIndex="4059"><span lang="EN-US" nodeIndex="4060">eflags</span></span></span></span></span><span nodeIndex="4061"><span nodeIndex="4062"><span nodeIndex="4063"><span nodeIndex="4064"><span nodeIndex="4065">的值由</span></span></span></span></span><span nodeIndex="4066"><span nodeIndex="4067"><span nodeIndex="4068"><span nodeIndex="4069"><span lang="EN-US" nodeIndex="4070">0x207</span></span></span></span></span><span nodeIndex="4071"><span nodeIndex="4072"><span nodeIndex="4073"><span nodeIndex="4074"><span nodeIndex="4075">变成</span></span></span></span></span><span nodeIndex="4076"><span nodeIndex="4077"><span nodeIndex="4078"><span nodeIndex="4079"><span lang="EN-US" nodeIndex="4080">0xa07</span></span></span></span></span><span nodeIndex="4081"><span nodeIndex="4082"><span nodeIndex="4083"><span nodeIndex="4084"><span nodeIndex="4085">，</span></span></span></span></span> <span nodeIndex="4086"><span nodeIndex="4087"><span nodeIndex="4088"><span nodeIndex="4089"><span lang="EN-US" nodeIndex="4090">edx</span></span></span></span></span><span nodeIndex="4091"><span nodeIndex="4092"><span nodeIndex="4093"><span nodeIndex="4094"><span nodeIndex="4095">溢出了，说明左移时</span></span></span></span></span><span nodeIndex="4096"><span nodeIndex="4097"><span nodeIndex="4098"><span nodeIndex="4099"><span lang="EN-US" nodeIndex="4100">edx</span></span></span></span></span><span nodeIndex="4101"><span nodeIndex="4102"><span nodeIndex="4103"><span nodeIndex="4104"><span nodeIndex="4105">高</span></span></span></span></span><span nodeIndex="4106"><span nodeIndex="4107"><span nodeIndex="4108"><span nodeIndex="4109"><span lang="EN-US" nodeIndex="4110">16</span></span></span></span></span><span nodeIndex="4111"><span nodeIndex="4112"><span nodeIndex="4113"><span nodeIndex="4114"><span nodeIndex="4115">位不是</span></span></span></span></span><span nodeIndex="4116"><span nodeIndex="4117"><span nodeIndex="4118"><span nodeIndex="4119"><span lang="EN-US" nodeIndex="4120">0</span></span></span></span></span><span nodeIndex="4121"><span nodeIndex="4122"><span nodeIndex="4123"><span nodeIndex="4124"><span nodeIndex="4125">。那么在</span></span></span></span></span><span nodeIndex="4126"><span nodeIndex="4127"><span nodeIndex="4128"><span nodeIndex="4129"><span lang="EN-US" nodeIndex="4130">get_base</span></span></span></span></span><span nodeIndex="4131"><span nodeIndex="4132"><span nodeIndex="4133"><span nodeIndex="4134"><span nodeIndex="4135">函数开始处增加一句</span></span></span></span></span><span nodeIndex="4136"><span nodeIndex="4137"><span nodeIndex="4138"><span nodeIndex="4139"><span lang="EN-US" nodeIndex="4140">and $0x0,%%edx</span></span></span></span></span><span nodeIndex="4141"><span nodeIndex="4142"><span nodeIndex="4143"><span nodeIndex="4144"><span nodeIndex="4145">，以防止高位溢出便可。</span></span></span></span></span></p>

<div id="RIL_IMG_31" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/31"/></div>
<p class="MsoNormal" nodeIndex="283"><span nodeIndex="4151"><span nodeIndex="4152"><span nodeIndex="4153"><span nodeIndex="4154"><span nodeIndex="4155">图</span></span></span></span></span><span nodeIndex="4156"><span nodeIndex="4157"><span nodeIndex="4158"><span nodeIndex="4159"><span lang="EN-US" nodeIndex="4160">3.18</span></span></span></span></span></p>

<p class="MsoNormal" nodeIndex="285"><span nodeIndex="4161"><span nodeIndex="4162"><span nodeIndex="4163"><span nodeIndex="4164"><span nodeIndex="4165">编译运行后发现此处仍有错误，</span></span></span></span></span><span nodeIndex="4166"><span nodeIndex="4167"><span nodeIndex="4168">再次查看</span></span></span><span nodeIndex="4169"><span nodeIndex="4170"><span lang="EN-US" nodeIndex="4171">get_base()</span></span></span><span nodeIndex="4172"><span nodeIndex="4173"><span nodeIndex="4174">汇编码如图</span></span></span><span nodeIndex="4175"><span nodeIndex="4176"><span lang="EN-US" nodeIndex="4177">3.19</span></span></span><span nodeIndex="4178"><span nodeIndex="4179"><span nodeIndex="4180">所示</span></span></span><span nodeIndex="508"><span><span>，特别注意标注红色下划线的语句，这些语句拷贝的源地址和目的地址使用了相同的寄存器</span></span></span><span nodeIndex="4181"><span nodeIndex="4182"><span lang="EN-US" nodeIndex="4183">edx</span></span></span><span nodeIndex="4184"><span nodeIndex="4185"><span nodeIndex="4186">，以</span></span></span><span nodeIndex="4187"><span nodeIndex="4188"><span lang="EN-US" nodeIndex="4189">edx</span></span></span><span nodeIndex="4190"><span nodeIndex="4191"><span nodeIndex="4192">为基地址取值赋给</span></span></span><span nodeIndex="4193"><span nodeIndex="4194"><span lang="EN-US" nodeIndex="4195">dh</span></span></span><span nodeIndex="4196"><span nodeIndex="4197"><span nodeIndex="4198">，这时候</span></span></span><span nodeIndex="4199"><span nodeIndex="4200"><span lang="EN-US" nodeIndex="4201">edx</span></span></span><span nodeIndex="4202"><span nodeIndex="4203"><span nodeIndex="4204">的值一定改变了；接下来又用</span></span></span><span nodeIndex="4205"><span nodeIndex="4206"><span lang="EN-US" nodeIndex="4207">edx</span></span></span><span nodeIndex="4208"><span nodeIndex="4209"><span nodeIndex="4210">为基地址取值赋给</span></span></span><span nodeIndex="4211"><span nodeIndex="4212"><span lang="EN-US" nodeIndex="4213">dl</span></span></span><span nodeIndex="4214"><span nodeIndex="4215"><span nodeIndex="4216">时，取到的值肯定不是应该的那个。晕，编译器脑残了吗？</span></span></span></p>
<p class="MsoNormal" nodeIndex="286"><span nodeIndex="4217"><span nodeIndex="4218"><span nodeIndex="4219">与图</span></span></span><span nodeIndex="4220"><span nodeIndex="4221"><span lang="EN-US" nodeIndex="4222">3.12</span></span></span><span nodeIndex="509"><span><span>对比，发现新编译器对这种老代码的编译并不稳定，之前编译的目的寄存器时</span></span></span><span nodeIndex="4223"><span nodeIndex="4224"><span lang="EN-US" nodeIndex="4225">ecx</span></span></span><span nodeIndex="4226"><span nodeIndex="4227"><span nodeIndex="4228">，现在却是</span></span></span><span nodeIndex="4229"><span nodeIndex="4230"><span lang="EN-US" nodeIndex="4231">edx</span></span></span><span nodeIndex="4232"><span nodeIndex="4233"><span nodeIndex="4234">，这中间我做什么了吗？<span nodeIndex="4235">好吧，求指点。</span></span></span></span></p>

<div id="RIL_IMG_32" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/32"/></div>
<p class="MsoNormal" nodeIndex="289"><span nodeIndex="4239"><span nodeIndex="4240"><span nodeIndex="4241">图</span></span></span><span nodeIndex="4242"><span nodeIndex="4243"><span lang="EN-US" nodeIndex="4244">3.19</span></span></span></p>

<p class="MsoNormal" nodeIndex="291"><span nodeIndex="4245"><span nodeIndex="4246"><span nodeIndex="4247">将</span></span></span><span nodeIndex="4248"><span nodeIndex="4249"><span lang="EN-US" nodeIndex="4250">get_base</span></span></span><span nodeIndex="4251"><span nodeIndex="4252"><span nodeIndex="4253">代码由图</span></span></span><span nodeIndex="4254"><span nodeIndex="4255"><span lang="EN-US" nodeIndex="4256">3.13</span></span></span><span nodeIndex="4257"><span nodeIndex="4258"><span nodeIndex="4259">修改为如图</span></span></span><span nodeIndex="4260"><span nodeIndex="4261"><span lang="EN-US" nodeIndex="4262">3.20</span></span></span><span nodeIndex="4263"><span nodeIndex="4264"><span nodeIndex="4265">所示，更换目的寄存器为</span></span></span><span nodeIndex="4266"><span nodeIndex="4267"><span lang="EN-US" nodeIndex="4268">ecx</span></span></span><span nodeIndex="4269"><span nodeIndex="4270"><span nodeIndex="4271">便可区分了。</span></span></span></p>

<div id="RIL_IMG_33" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/33"/></div>
<p class="MsoNormal" nodeIndex="294"><span nodeIndex="4275"><span nodeIndex="4276"><span nodeIndex="4277">图</span></span></span><span nodeIndex="4278"><span nodeIndex="4279"><span lang="EN-US" nodeIndex="4280">3.20</span></span></span></p>

<p class="MsoNormal" nodeIndex="296"><span nodeIndex="4281"><span nodeIndex="4282"><span nodeIndex="4283">编译运行后，</span></span></span><span nodeIndex="4284"><span nodeIndex="4285"><span lang="EN-US" nodeIndex="4286">execve</span></span></span><span nodeIndex="4287"><span nodeIndex="4288"><span nodeIndex="4289">系统调用终于通过了。</span></span></span></p>
<p class="MsoNormal" nodeIndex="297"><span nodeIndex="4290"><span nodeIndex="4291"><span nodeIndex="4292">问题</span></span></span><span nodeIndex="4293"><span nodeIndex="4294"><span lang="EN-US" nodeIndex="4295">7</span></span></span><span nodeIndex="4296"><span nodeIndex="4297"><span nodeIndex="4298">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="298"><span nodeIndex="4299"><span nodeIndex="4300"><span nodeIndex="4301">虽然</span></span></span><span nodeIndex="4302"><span nodeIndex="4303"><span lang="EN-US" nodeIndex="4304">execve</span></span></span><span nodeIndex="4305"><span nodeIndex="4306"><span nodeIndex="4307">成功了，但是加载的</span></span></span><span nodeIndex="4308"><span nodeIndex="4309"><span lang="EN-US" nodeIndex="4310">shell</span></span></span><span nodeIndex="510"><span><span>程序却无法正常运行。具体的错误界面没能留下，十分后悔当初记录不仔细。但</span></span></span><span nodeIndex="4311"><span nodeIndex="4312"><span lang="EN-US" nodeIndex="4313">shell</span></span></span><span nodeIndex="511"><span><span>程序没能正常运行是明确的。这个问题就更加难调试了，因为在执行了</span></span></span><span nodeIndex="4314"><span nodeIndex="4315"><span lang="EN-US" nodeIndex="4316">exeve</span></span></span><span nodeIndex="4317"><span nodeIndex="4318"><span nodeIndex="4319">之后，首先要进行需求加载，发生</span></span></span><span nodeIndex="4320"><span nodeIndex="4321"><span lang="EN-US" nodeIndex="4322">79(大约是这个数字)</span></span></span><span nodeIndex="4323"><span nodeIndex="4324"><span nodeIndex="4325">次</span></span></span><span nodeIndex="4326"><span nodeIndex="4327"><span lang="EN-US" nodeIndex="4328">do_no_page</span></span></span><span nodeIndex="4329"><span nodeIndex="4330"><span nodeIndex="4331">缺页中断从文件系统中加载</span></span></span><span nodeIndex="4332"><span nodeIndex="4333"><span lang="EN-US" nodeIndex="4334">shell</span></span></span><span nodeIndex="4335"><span nodeIndex="4336"><span nodeIndex="4337">文件，那错误就可能是中断处理时发生的，也可能是</span></span></span><span nodeIndex="4338"><span nodeIndex="4339"><span lang="EN-US" nodeIndex="4340">shell</span></span></span><span nodeIndex="4341"><span nodeIndex="4342"><span nodeIndex="4343">运行过程中发生的，而</span></span></span><span nodeIndex="4344"><span nodeIndex="4345"><span lang="EN-US" nodeIndex="4346">shell</span></span></span><span nodeIndex="512"><span><span>又是这个系统里面最大的程序，从中寻找一个错误何其困难。</span></span></span></p>
<p class="MsoNormal" nodeIndex="299"><span nodeIndex="513"><span><span>然而幸运的是，这个错误被我偶然间找到了。我在过滤缺页中断处理函数时，每次逻辑块拷贝（共四次）都查看了拷贝结果，发现</span></span></span><span nodeIndex="4347"><span nodeIndex="4348"><span lang="EN-US" nodeIndex="4349">shell</span></span></span><span nodeIndex="4350"><span nodeIndex="4351"><span nodeIndex="4352">的第一块数据被复制到申请的空闲页的</span></span></span><span nodeIndex="4353"><span nodeIndex="4354"><span lang="EN-US" nodeIndex="4355">0-0x3ff</span></span></span><span nodeIndex="4356"><span nodeIndex="4357"><span nodeIndex="4358">处，第二个块却被拷贝到</span></span></span><span nodeIndex="4359"><span nodeIndex="4360"><span lang="EN-US" nodeIndex="4361">0x800-0xbff</span></span></span><span nodeIndex="4362"><span nodeIndex="4363"><span nodeIndex="4364">处，依次类推，隔</span></span></span><span nodeIndex="4365"><span nodeIndex="4366"><span lang="EN-US" nodeIndex="4367">1024B</span></span></span><span nodeIndex="4368"><span nodeIndex="4369"><span nodeIndex="4370">复制一块数据，这样导致内存中的可执行文件是不连续的。查看</span></span></span><span nodeIndex="4371"><span nodeIndex="4372"><span lang="EN-US" nodeIndex="4373">COPYBLK</span></span></span><span nodeIndex="4374"><span nodeIndex="4375"><span nodeIndex="4376">函数，其汇编码如图</span></span></span><span nodeIndex="4377"><span nodeIndex="4378"><span lang="EN-US" nodeIndex="4379">3.21</span></span></span><span nodeIndex="4380"><span nodeIndex="4381"><span nodeIndex="4382">所示。思考一下可知，第一次调用</span></span></span><span nodeIndex="4383"><span nodeIndex="4384"><span lang="EN-US" nodeIndex="4385">COPYBLK()</span></span></span><span nodeIndex="4386"><span nodeIndex="4387"><span nodeIndex="4388">拷贝数据时，目的地址寄存器</span></span></span><span nodeIndex="4389"><span nodeIndex="4390"><span lang="EN-US" nodeIndex="4391">edi</span></span></span><span nodeIndex="4392"><span nodeIndex="4393"><span nodeIndex="4394">最后增加了</span></span></span><span nodeIndex="4395"><span nodeIndex="4396"><span lang="EN-US" nodeIndex="4397">0x400B</span></span></span><span nodeIndex="514"><span><span>，这个修改影响了下一次块拷贝。可见还是寄存器保存和恢复的问题啊。</span></span></span></p>

<div id="RIL_IMG_34" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/34"/></div>
<p class="MsoNormal" nodeIndex="302"><span nodeIndex="4401"><span nodeIndex="4402"><span nodeIndex="4403">图</span></span></span><span nodeIndex="4404"><span nodeIndex="4405"><span lang="EN-US" nodeIndex="4406">3.21</span></span></span></p>

<p class="MsoNormal" nodeIndex="304"><span nodeIndex="4407"><span nodeIndex="4408"><span nodeIndex="4409">增加红色括号标注的语句后</span></span></span><span nodeIndex="4410"><span nodeIndex="4411"><span lang="EN-US" nodeIndex="4412">COPYBLK</span></span></span><span nodeIndex="4413"><span nodeIndex="4414"><span nodeIndex="4415">代码</span></span></span><span nodeIndex="4416"><span nodeIndex="4417"><span nodeIndex="4418">如图</span></span></span><span nodeIndex="4419"><span nodeIndex="4420"><span lang="EN-US" nodeIndex="4421">3.22</span></span></span><span nodeIndex="4422"><span nodeIndex="4423"><span nodeIndex="4424">所示。</span></span></span></p>

<div id="RIL_IMG_35" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/35"/></div>
<p class="MsoNormal" nodeIndex="307"><span nodeIndex="4428"><span nodeIndex="4429"><span nodeIndex="4430">图</span></span></span><span nodeIndex="4431"><span nodeIndex="4432"><span lang="EN-US" nodeIndex="4433">3.22</span></span></span></p>
<p class="MsoNormal" nodeIndex="308"><span nodeIndex="515"><span><span>从这个问题的调试过程也说明问题越是复杂时候，细心越是重要。编译运行后结果如图</span></span></span><span nodeIndex="4434"><span nodeIndex="4435"><span lang="EN-US" nodeIndex="4436">3.23</span></span></span><span nodeIndex="4437"><span nodeIndex="4438"><span nodeIndex="4439">所示，打印出了</span></span></span><span nodeIndex="4440"><span nodeIndex="4441"><span lang="EN-US" nodeIndex="4442">“===Ok.”</span></span></span><span nodeIndex="4443"><span nodeIndex="4444"><span nodeIndex="4445">这些字符。</span></span></span></p>

<div id="RIL_IMG_36" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/36"/></div>
<p class="MsoNormal" nodeIndex="311"><span nodeIndex="4449"><span nodeIndex="4450"><span nodeIndex="4451">图</span></span></span><a name="OLE_LINK24" nodeIndex="4452"></a><a name="OLE_LINK23" nodeIndex="4453"><span nodeIndex="4454"><span nodeIndex="4455"><span nodeIndex="4456"><span lang="EN-US" nodeIndex="4457">3.23</span></span></span></span></a></p>
<p class="MsoNormal" nodeIndex="312"><span nodeIndex="4458"><span nodeIndex="4459"><span nodeIndex="4460">阅读</span></span></span><span nodeIndex="4461"><span nodeIndex="4462"><span lang="EN-US" nodeIndex="4463">init</span></span></span><span nodeIndex="4464"><span nodeIndex="4465"><span nodeIndex="4466">函数源码可知，该段功能是用</span></span></span><span nodeIndex="4467"><span nodeIndex="4468"><span lang="EN-US" nodeIndex="4469">shell</span></span></span><span nodeIndex="4470"><span nodeIndex="4471"><span nodeIndex="4472">执行</span></span></span><span nodeIndex="4473"><span nodeIndex="4474"><span lang="EN-US" nodeIndex="4475">/etc/rc</span></span></span><span nodeIndex="4476"><span nodeIndex="4477"><span nodeIndex="4478">脚本程序，打开使用</span></span></span><span nodeIndex="4479"><span nodeIndex="4480"><span lang="EN-US" nodeIndex="4481">hexdump |C <span nodeIndex="4482">rootimage-0.11|less</span></span></span></span><span nodeIndex="4483"><span nodeIndex="4484"><span nodeIndex="4485">命令打开</span></span></span><span nodeIndex="4486"><span nodeIndex="4487"><span lang="EN-US" nodeIndex="4488">rc</span></span></span><span nodeIndex="4489"><span nodeIndex="4490"><span nodeIndex="4491">文件，这里需要好好研究下</span></span></span><span nodeIndex="4492"><span nodeIndex="4493"><span lang="EN-US" nodeIndex="4494">minix</span></span></span><span nodeIndex="4495"><span nodeIndex="4496"><span nodeIndex="4497">文件系统（可参考赵博士的</span></span></span><span nodeIndex="4498"><span nodeIndex="4499"><span lang="EN-US" nodeIndex="4500">linux</span></span></span><span nodeIndex="4501"><span nodeIndex="4502"><span nodeIndex="4503">内核完全剖析）才能用找到具体的文件。如图</span></span></span><span nodeIndex="4504"><span nodeIndex="4505"><span lang="EN-US" nodeIndex="4506">3.24</span></span></span><span nodeIndex="4507"><span nodeIndex="4508"><span nodeIndex="4509">所示。可见运行结果正确。</span></span></span></p>

<div id="RIL_IMG_37" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/37"/></div>
<p class="MsoNormal" nodeIndex="315"><span nodeIndex="4513"><span nodeIndex="4514"><span nodeIndex="4515">图</span></span></span><span nodeIndex="4516"><span nodeIndex="4517"><span lang="EN-US" nodeIndex="4518">3.24</span></span></span></p>
<p class="MsoNormal" nodeIndex="316"><span nodeIndex="516"><span nodeIndex="4519"><span nodeIndex="4520">其实在这个问题解决后，如果我当时足够冷静，没有其他事情烦扰，应该会首先完成一件事情再继续下去。这件事情就是：为所有汇编写的函数增加寄存器的保存和恢复操作。然而，那几天我太忙了，忙的忘记了思考，于是发生了问题</span></span></span><span nodeIndex="4521"><span nodeIndex="4522"><span lang="EN-US" nodeIndex="4523">8</span></span></span><span nodeIndex="4524"><span nodeIndex="4525"><span nodeIndex="4526">这个惨剧，是的，对我来说真是个惨剧。</span></span></span></p>
<p class="MsoNormal" nodeIndex="317"><span nodeIndex="4527"><span nodeIndex="4528"><span nodeIndex="4529">问题</span></span></span><span nodeIndex="4530"><span nodeIndex="4531"><span lang="EN-US" nodeIndex="4532">8</span></span></span><span nodeIndex="4533"><span nodeIndex="4534"><span nodeIndex="4535">：</span></span></span></p>
<p class="MsoNormal" nodeIndex="318"><span nodeIndex="4536"><span nodeIndex="4537"><span nodeIndex="4538">上述美丽的输出结果下面却是如图</span></span></span><span nodeIndex="4539"><span nodeIndex="4540"><span lang="EN-US" nodeIndex="4541">3.25</span></span></span><span nodeIndex="4542"><span nodeIndex="4543"><span nodeIndex="4544">的错误提示信息。革命尚未成功，同志仍需努力啊。错误性质倒是比较明确，就是上述</span></span></span><span nodeIndex="4545"><span nodeIndex="4546"><span lang="EN-US" nodeIndex="4547">sh</span></span></span><span nodeIndex="4548"><span nodeIndex="4549"><span nodeIndex="4550">程序运行结束后，系统又创建了一个</span></span></span><span nodeIndex="4551"><span nodeIndex="4552"><span lang="EN-US" nodeIndex="4553">shell</span></span></span><span nodeIndex="517"><span><span>进程，用于和用户进行交互，这个进程无法打开某个文件，原因是进程结构体中的</span></span></span><span nodeIndex="4554"><span nodeIndex="4555"><span lang="EN-US" nodeIndex="4556">pwd</span></span></span><span nodeIndex="4557"><span nodeIndex="4558"><span nodeIndex="4559">元素指向的当前目录</span></span></span><span nodeIndex="4560"><span nodeIndex="4561"><span lang="EN-US" nodeIndex="4562">inode</span></span></span><span nodeIndex="4563"><span nodeIndex="4564"><span nodeIndex="4565">找不到了，还是有点诡异的。这个</span></span></span><span nodeIndex="4566"><span nodeIndex="4567"><span lang="EN-US" nodeIndex="4568">shell</span></span></span><span nodeIndex="4569"><span nodeIndex="4570"><span nodeIndex="4571">结束后，再创建下一个，如此循环往复。这个过程就比较熟悉了，就是平时使用</span></span></span><span nodeIndex="4572"><span nodeIndex="4573"><span lang="EN-US" nodeIndex="4574">linux</span></span></span><span nodeIndex="4575"><span nodeIndex="4576"><span nodeIndex="4577">时的</span></span></span><span nodeIndex="4578"><span nodeIndex="4579"><span lang="EN-US" nodeIndex="4580">tty</span></span></span><span nodeIndex="518"><span><span>里面的命令行嘛。因此凭我超常的男人直觉认为，这是最后一个问题了。</span></span></span></p>

<div id="RIL_IMG_38" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/38"/></div>
<p class="MsoNormal" nodeIndex="321"><span nodeIndex="4586"><span nodeIndex="4587"><span nodeIndex="4588">图</span></span></span><span nodeIndex="4589"><span nodeIndex="4590"><span lang="EN-US" nodeIndex="4591">3.25</span></span></span></p>
<p class="MsoNormal" nodeIndex="322"><span nodeIndex="519"><span><span>然而黎明前的黑暗真黑啊，这个问题也是最难<a name="OLE_LINK8"></a><a name="OLE_LINK7"><span>调试的问题，原因是</span></a>出现错误的程序不在内核源码中，而是从文件系统加载的</span></span></span><span nodeIndex="4592"><span nodeIndex="4593"><span lang="EN-US" nodeIndex="4594">sh</span></span></span><span nodeIndex="4595"><span nodeIndex="4596"><span nodeIndex="4597">可执行文件，如果分析</span></span></span><span nodeIndex="4598"><span nodeIndex="4599"><span lang="EN-US" nodeIndex="4600">bash</span></span></span><span nodeIndex="4601"><span nodeIndex="4602"><span nodeIndex="4603">源码可以参考</span></span></span><span nodeIndex="4604"><span nodeIndex="4605"><span lang="EN-US" nodeIndex="4606">http://www.linjian.cn/files/articles/bash_study/bash_linjian.html</span></span></span><span nodeIndex="4607"><span nodeIndex="4608"><span nodeIndex="4609">，但是比较费时耗力。因为</span></span></span><span nodeIndex="4610"><span nodeIndex="4611"><span lang="EN-US" nodeIndex="4612">sh</span></span></span><span nodeIndex="520"><span><span>可执行文件是不会出错的，错误肯定发生在被高级编译器编译后的内核程序中，所以可以先偷个懒。经过插桩调试，发现出错的是</span></span></span><span nodeIndex="4613"><span nodeIndex="4614"><span lang="EN-US" nodeIndex="4615">main.c</span></span></span> <span nodeIndex="4616"><span nodeIndex="4617"><span nodeIndex="4618">中</span></span></span><span nodeIndex="4619"><span nodeIndex="4620"><span lang="EN-US" nodeIndex="4621">init</span></span></span><span nodeIndex="4622"><span nodeIndex="4623"><span nodeIndex="4624">函数第二个</span></span></span><span nodeIndex="4625"><span nodeIndex="4626"><span lang="EN-US" nodeIndex="4627">execve</span></span></span><span nodeIndex="4628"><span nodeIndex="4629"><span nodeIndex="4630">系统调用，如图</span></span></span><span nodeIndex="4631"><span nodeIndex="4632"><span lang="EN-US" nodeIndex="4633">3.26</span></span></span><span nodeIndex="4634"><span nodeIndex="4635"><span nodeIndex="4636">所示。该系统调用加载</span></span></span><span nodeIndex="4637"><span nodeIndex="4638"><span lang="EN-US" nodeIndex="4639">/bin/sh</span></span></span><span nodeIndex="4640"><span nodeIndex="4641"><span nodeIndex="4642">文件并运行它。使用</span></span></span><span nodeIndex="4643"><span nodeIndex="4644"><span lang="EN-US" nodeIndex="4645">souce insight</span></span></span><span nodeIndex="4646"><span nodeIndex="4647"><span nodeIndex="4648">的查找引用功能，寻找“</span></span></span><span nodeIndex="4649"><span nodeIndex="4650"><span lang="EN-US" nodeIndex="4651">No cwd inode</span></span></span><span nodeIndex="4652"><span nodeIndex="4653"><span nodeIndex="4654">”的引用，发现该语句出现在</span></span></span><span nodeIndex="4655"><span nodeIndex="4656"><span lang="EN-US" nodeIndex="4657">Namei.c</span></span></span><span nodeIndex="4658"><span nodeIndex="4659"><span nodeIndex="4660">的</span></span></span><a name="OLE_LINK10" nodeIndex="4661"></a><a name="OLE_LINK9" nodeIndex="4662"><span nodeIndex="4663"><span nodeIndex="4664"><span nodeIndex="4665"><span lang="EN-US" nodeIndex="4666">get_dir()</span></span></span></span></a><span nodeIndex="4667"><span nodeIndex="4668"><span nodeIndex="4669">函数中，而</span></span></span><span nodeIndex="4670"><span nodeIndex="4671"><span lang="EN-US" nodeIndex="4672">get_dir()</span></span></span><span nodeIndex="4673"><span nodeIndex="4674"><span nodeIndex="4675">却</span></span></span><span nodeIndex="4676"><span nodeIndex="4677"><span nodeIndex="4678">是个静态函数，在</span></span></span><span nodeIndex="4679"><span nodeIndex="4680"><span lang="EN-US" nodeIndex="4681">system.map</span></span></span><span nodeIndex="4682"><span nodeIndex="4683"><span nodeIndex="4684">中不可见，还会被优化编译到</span></span></span><span nodeIndex="4685"><span nodeIndex="4686"><span lang="EN-US" nodeIndex="4687">sys_mkdir()</span></span></span><span nodeIndex="4688"><span nodeIndex="4689"><span nodeIndex="4690">、</span></span></span><span nodeIndex="4691"><span nodeIndex="4692"><span lang="EN-US" nodeIndex="4693">sys_open()</span></span></span><span nodeIndex="4694"><span nodeIndex="4695"><span nodeIndex="4696">、</span></span></span><span nodeIndex="4697"><span nodeIndex="4698"><span lang="EN-US" nodeIndex="4699">Namei()</span></span></span><span nodeIndex="4700"><span nodeIndex="4701"><span nodeIndex="4702">等多函数中</span></span></span><span nodeIndex="4703"><span nodeIndex="4704"><span nodeIndex="4705">。这下彻底迷失了。</span></span></span></p>

<div id="RIL_IMG_39" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/39"/></div>
<p class="MsoNormal" nodeIndex="325"><span nodeIndex="4709"><span nodeIndex="4710"><span nodeIndex="4711">图</span></span></span><span nodeIndex="4712"><span nodeIndex="4713"><span lang="EN-US" nodeIndex="4714">3.26</span></span></span></p>

<p class="MsoNormal" nodeIndex="327"><span nodeIndex="521"><span><span>只好一步一步来了。在系统运行进入第三个</span></span></span><span nodeIndex="4715"><span nodeIndex="4716"><span lang="EN-US" nodeIndex="4717">do_execve</span></span></span><span nodeIndex="4718"><span nodeIndex="4719"><span nodeIndex="4720">函数后，在</span></span></span><span nodeIndex="4721"><span nodeIndex="4722"><span lang="EN-US" nodeIndex="4723">Namei()</span></span></span><span nodeIndex="4724"><span nodeIndex="4725"><span nodeIndex="4726">处设置断点，到出错会经过两三个</span></span></span><span nodeIndex="4727"><span nodeIndex="4728"><span lang="EN-US" nodeIndex="4729">Namei()</span></span></span><span nodeIndex="4730"><span nodeIndex="4731"><span nodeIndex="4732">，跟踪最后一个，单步执行发现</span></span></span><span nodeIndex="4733"><span nodeIndex="4734"><span lang="EN-US" nodeIndex="4735">get_dir()</span></span></span><span nodeIndex="4736"><span nodeIndex="4737"><span nodeIndex="4738">如图</span></span></span><span nodeIndex="4739"><span nodeIndex="4740"><span lang="EN-US" nodeIndex="4741">3.27</span></span></span><span nodeIndex="4742"><span nodeIndex="4743"><span nodeIndex="4744">所示的</span></span></span><span nodeIndex="4745"><span nodeIndex="4746"><span nodeIndex="4747">判断没通过，当前进程</span></span></span><span nodeIndex="4748"><span nodeIndex="4749"><span lang="EN-US" nodeIndex="4750">root</span></span></span><span nodeIndex="4751"><span nodeIndex="4752"><span nodeIndex="4753">和</span></span></span><span nodeIndex="4754"><span nodeIndex="4755"><span lang="EN-US" nodeIndex="4756">pwd</span></span></span><span nodeIndex="4757"><span nodeIndex="4758"><span nodeIndex="4759">指向的</span></span></span><span nodeIndex="4760"><span nodeIndex="4761"><span lang="EN-US" nodeIndex="4762">i</span></span></span><span nodeIndex="4763"><span nodeIndex="4764"><span nodeIndex="4765">节点的引用数变为</span></span></span><span nodeIndex="4766"><span nodeIndex="4767"><span lang="EN-US" nodeIndex="4768">0</span></span></span><span nodeIndex="4769"><span nodeIndex="4770"><span nodeIndex="4771">了。这就相当诡异了，到底是调用什么函数更改了当前进程的</span></span></span><span nodeIndex="4772"><span nodeIndex="4773"><span lang="EN-US" nodeIndex="4774">root</span></span></span><span nodeIndex="4775"><span nodeIndex="4776"><span nodeIndex="4777">目录或</span></span></span><span nodeIndex="4778"><span nodeIndex="4779"><span lang="EN-US" nodeIndex="4780">pwd</span></span></span><span nodeIndex="4781"><span nodeIndex="4782"><span nodeIndex="4783">目录的</span></span></span><span nodeIndex="4784"><span nodeIndex="4785"><span lang="EN-US" nodeIndex="4786">i</span></span></span><span nodeIndex="4787"><span nodeIndex="4788"><span nodeIndex="4789">节点（此刻二者指向同一个</span></span></span><span nodeIndex="4790"><span nodeIndex="4791"><span lang="EN-US" nodeIndex="4792">inode</span></span></span><span nodeIndex="4793"><span nodeIndex="4794"><span nodeIndex="4795">）呢？</span></span></span></p>

<div id="RIL_IMG_40" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/40"/></div>
<p class="MsoNormal" nodeIndex="330"><span nodeIndex="4801"><span nodeIndex="4802"><span nodeIndex="4803">图</span></span></span><span nodeIndex="4804"><span nodeIndex="4805"><span lang="EN-US" nodeIndex="4806">3.27</span></span></span></p>
<p class="MsoNormal" nodeIndex="331"><span nodeIndex="522"><span><span>为了跟踪出错的位置，必须找到修改根目录</span></span></span><span nodeIndex="4807"><span nodeIndex="4808"><span lang="EN-US" nodeIndex="4809">inode</span></span></span><span nodeIndex="4810"><span nodeIndex="4811"><span nodeIndex="4812">（通过插桩输出得知，其内存地址为</span></span></span><span nodeIndex="4813"><span nodeIndex="4814"><span lang="EN-US" nodeIndex="4815">0x1c550</span></span></span><span nodeIndex="4816"><span nodeIndex="4817"><span nodeIndex="4818">，其</span></span></span><span nodeIndex="4819"><span nodeIndex="4820"><span lang="EN-US" nodeIndex="4821">i_count</span></span></span><span nodeIndex="4822"><span nodeIndex="4823"><span nodeIndex="4824">地址为</span></span></span><a name="OLE_LINK12" nodeIndex="4825"></a><a name="OLE_LINK11" nodeIndex="4826"><span nodeIndex="4827"><span nodeIndex="4828"><span nodeIndex="4829"><span lang="EN-US" nodeIndex="4830">0x1c580</span></span></span></span></a><span nodeIndex="4831"><span nodeIndex="4832"><span nodeIndex="4833">）的函数，然而通过</span></span></span><span nodeIndex="4834"><span nodeIndex="4835"><span lang="EN-US" nodeIndex="4836">bochs</span></span></span><span nodeIndex="4837"><span nodeIndex="4838"><span nodeIndex="4839">断点运行发现，</span></span></span><span nodeIndex="4840"><span nodeIndex="4841"><span lang="EN-US" nodeIndex="4842">sh</span></span></span><span nodeIndex="4843"><span nodeIndex="4844"><span nodeIndex="4845">程序在运行时，发生了</span></span></span><span nodeIndex="4846"><span nodeIndex="4847"><span lang="EN-US" nodeIndex="4848">79</span></span></span><span nodeIndex="4849"><span nodeIndex="4850"><span nodeIndex="4851">次缺页异常，即触发了</span></span></span><span nodeIndex="4852"><span nodeIndex="4853"><span lang="EN-US" nodeIndex="4854">79</span></span></span><span nodeIndex="4855"><span nodeIndex="4856"><span nodeIndex="4857">次需求加载功能（为了加快创建进程的速度，改善用户体验，</span></span></span><span nodeIndex="4858"><span nodeIndex="4859"><span lang="EN-US" nodeIndex="4860">linux</span></span></span><span nodeIndex="523"><span nodeIndex="4861"><span nodeIndex="4862">不是一下子把可执行文件从文件系统中拷贝到内存中，而是拷贝一页就运行该页的指令，运行完后触发缺页异常，进行下一页的拷贝，这样用户就不会有等待的感觉），通过反复测试得知，在第</span></span></span><span nodeIndex="4863"><span nodeIndex="4864"><span lang="EN-US" nodeIndex="4865">20</span></span></span><span nodeIndex="4866"><span nodeIndex="4867"><span nodeIndex="4868">页</span></span></span><span nodeIndex="4869"><span nodeIndex="4870"><span lang="EN-US" nodeIndex="4871">0x1c580</span></span></span><span nodeIndex="4872"><span nodeIndex="4873"><span nodeIndex="4874">中的值由</span></span></span><span nodeIndex="4875"><span nodeIndex="4876"><span lang="EN-US" nodeIndex="4877">8</span></span></span><span nodeIndex="4878"><span nodeIndex="4879"><span nodeIndex="4880">改为</span></span></span><span nodeIndex="4881"><span nodeIndex="4882"><span lang="EN-US" nodeIndex="4883">1</span></span></span><span nodeIndex="4884"><span nodeIndex="4885"><span nodeIndex="4886">和第</span></span></span><span nodeIndex="4887"><span nodeIndex="4888"><span lang="EN-US" nodeIndex="4889">21</span></span></span><span nodeIndex="4890"><span nodeIndex="4891"><span nodeIndex="4892">页由</span></span></span><span nodeIndex="4893"><span nodeIndex="4894"><span lang="EN-US" nodeIndex="4895">1</span></span></span><span nodeIndex="4896"><span nodeIndex="4897"><span nodeIndex="4898">改为</span></span></span><span nodeIndex="4899"><span nodeIndex="4900"><span lang="EN-US" nodeIndex="4901">0</span></span></span><span nodeIndex="4902"><span nodeIndex="4903"><span nodeIndex="4904">，从而直接导致</span></span></span><span nodeIndex="4905"><span nodeIndex="4906"><span lang="EN-US" nodeIndex="4907">Namei</span></span></span><span nodeIndex="4908"><span nodeIndex="4909"><span nodeIndex="4910">无法找到根目录。在第</span></span></span><span nodeIndex="4911"><span nodeIndex="4912"><span lang="EN-US" nodeIndex="4913">20</span></span></span><span nodeIndex="4914"><span nodeIndex="4915"><span nodeIndex="4916">页，使用</span></span></span><span nodeIndex="4917"><span nodeIndex="4918"><span lang="EN-US" nodeIndex="4919">bochs</span></span></span><span nodeIndex="4920"><span nodeIndex="4921"><span nodeIndex="4922">的</span></span></span><span nodeIndex="4923"><span nodeIndex="4924"><span lang="EN-US" nodeIndex="4925">watch write 0x1c580</span></span></span><span nodeIndex="4926"><span nodeIndex="4927"><span nodeIndex="4928">命令，发现系统在执行到</span></span></span><span nodeIndex="4929"><span nodeIndex="4930"><span lang="EN-US" nodeIndex="4931">0xa85e</span></span></span><span nodeIndex="4932"><span nodeIndex="4933"><span nodeIndex="4934">和</span></span></span><span nodeIndex="4935"><span nodeIndex="4936"><span lang="EN-US" nodeIndex="4937">0xa964</span></span></span><span nodeIndex="4938"><span nodeIndex="4939"><span nodeIndex="4940">之间的一条指令时修改了该值，根据</span></span></span><span nodeIndex="4941"><span nodeIndex="4942"><span lang="EN-US" nodeIndex="4943">system.map</span></span></span><span nodeIndex="4944"><span nodeIndex="4945"><span nodeIndex="4946">文件可知该区域是</span></span></span><a name="OLE_LINK14" nodeIndex="4947"></a><a name="OLE_LINK13" nodeIndex="4948"><span nodeIndex="4949"><span nodeIndex="4950"><span nodeIndex="4951"><span lang="EN-US" nodeIndex="4952">get_empty_inode()</span></span></span></span></a><span nodeIndex="4953"><span nodeIndex="4954"><span nodeIndex="4955">函数。而</span></span></span><span nodeIndex="4956"><span nodeIndex="4957"><span lang="EN-US" nodeIndex="4958">21</span></span></span><span nodeIndex="4959"><span nodeIndex="4960"><span nodeIndex="4961">页修改该值的是</span></span></span><span nodeIndex="4962"><span nodeIndex="4963"><span lang="EN-US" nodeIndex="4964">iput()</span></span></span><span nodeIndex="4965"><span nodeIndex="4966"><span nodeIndex="4967">，该函数释放一个</span></span></span><span nodeIndex="4968"><span nodeIndex="4969"><span lang="EN-US" nodeIndex="4970">inode</span></span></span><span nodeIndex="4971"><span nodeIndex="4972"><span nodeIndex="4973">会将其引用数减</span></span></span><span nodeIndex="4974"><span nodeIndex="4975"><span lang="EN-US" nodeIndex="4976">1</span></span></span><span nodeIndex="4977"><span nodeIndex="4978"><span nodeIndex="4979">，功能上没有问题。</span></span></span></p>
<p class="MsoNormal" nodeIndex="332"><span nodeIndex="4980"><span nodeIndex="4981"><span nodeIndex="4982">好了，经过九牛二虎之力把问题找到了，</span></span></span><span nodeIndex="4983"><span nodeIndex="4984"><span lang="EN-US" nodeIndex="4985">get_empty_inode()</span></span></span><span nodeIndex="4986"><span nodeIndex="4987"><span nodeIndex="4988">就是罪魁祸首。阅读其源码并单步跟踪其执行过程，该函数遍历</span></span></span><span nodeIndex="4989"><span nodeIndex="4990"><span lang="EN-US" nodeIndex="4991">inode_table</span></span></span><span nodeIndex="4992"><span nodeIndex="4993"><span nodeIndex="4994">（首地址为</span></span></span><span nodeIndex="4995"><span nodeIndex="4996"><span lang="EN-US" nodeIndex="4997">1c4e0</span></span></span><span nodeIndex="4998"><span nodeIndex="4999"><span nodeIndex="5000">），寻找一个空闲的</span></span></span><span nodeIndex="5001"><span nodeIndex="5002"><span lang="EN-US" nodeIndex="5003">inode</span></span></span><span nodeIndex="5004"><span nodeIndex="5005"><span nodeIndex="5006">，然后将其</span></span></span><span nodeIndex="5007"><span nodeIndex="5008"><span lang="EN-US" nodeIndex="5009">memset 0</span></span></span><span nodeIndex="5010"><span nodeIndex="5011"><span nodeIndex="5012">。</span></span></span> <span nodeIndex="5013"><span nodeIndex="5014"><span nodeIndex="5015">如图</span></span></span><span nodeIndex="5016"><span nodeIndex="5017"><span lang="EN-US" nodeIndex="5018">3.28</span></span></span><span nodeIndex="5019"><span nodeIndex="5020"><span nodeIndex="5021">所示，发现一个运行</span></span></span><span nodeIndex="5022"><span nodeIndex="5023"><span lang="EN-US" nodeIndex="5024">bug</span></span></span><span nodeIndex="5025"><span nodeIndex="5026"><span nodeIndex="5027">，红色圆圈处原来的语句是</span></span></span><span nodeIndex="5028"><span nodeIndex="5029"><span lang="EN-US" nodeIndex="5030">break</span></span></span><span nodeIndex="5031"><span nodeIndex="5032"><span nodeIndex="5033">，找到空闲并且没上锁的</span></span></span><span nodeIndex="5034"><span nodeIndex="5035"><span lang="EN-US" nodeIndex="5036">inode</span></span></span><span nodeIndex="5037"><span nodeIndex="5038"><span nodeIndex="5039">后，本应该跳出</span></span></span><span nodeIndex="5040"><span nodeIndex="5041"><span lang="EN-US" nodeIndex="5042">while</span></span></span><span nodeIndex="5043"><span nodeIndex="5044"><span nodeIndex="5045">循环，而源码仅仅跳出</span></span></span><span nodeIndex="5046"><span nodeIndex="5047"><span lang="EN-US" nodeIndex="5048">for</span></span></span><span nodeIndex="5049"><span nodeIndex="5050"><span nodeIndex="5051">循环，之后还得等待解锁，显然是不合理的，应该改为</span></span></span><span nodeIndex="5052"><span nodeIndex="5053"><span lang="EN-US" nodeIndex="5054">goto</span></span></span><span nodeIndex="5055"><span nodeIndex="5056"><span nodeIndex="5057">语句跳出来。</span></span></span></p>

<div id="RIL_IMG_41" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/41"/></div>
<p class="MsoNormal" nodeIndex="335"><span nodeIndex="5061"><span nodeIndex="5062"><span nodeIndex="5063">图</span></span></span><span nodeIndex="5064"><span nodeIndex="5065"><span lang="EN-US" nodeIndex="5066">3.28</span></span></span></p>
<p class="MsoNormal" nodeIndex="336"><span nodeIndex="5067"><span nodeIndex="5068"><span nodeIndex="5069">此外，跟踪</span></span></span><span nodeIndex="5070"><span nodeIndex="5071"><span lang="EN-US" nodeIndex="5072">memset</span></span></span><span nodeIndex="5073"><span nodeIndex="5074"><span nodeIndex="5075">汇编代码如图</span></span></span><span nodeIndex="5076"><span nodeIndex="5077"><span lang="EN-US" nodeIndex="5078">3.29</span></span></span><span nodeIndex="5079"><span nodeIndex="5080"><span nodeIndex="5081">所示，发现将</span></span></span><span nodeIndex="5082"><span nodeIndex="5083"><span lang="EN-US" nodeIndex="5084">1c518</span></span></span><span nodeIndex="5085"><span nodeIndex="5086"><span nodeIndex="5087">指向的</span></span></span><span nodeIndex="5088"><span nodeIndex="5089"><span lang="EN-US" nodeIndex="5090">inode</span></span></span><span nodeIndex="5091"><span nodeIndex="5092"><span nodeIndex="5093">清零后，</span></span></span><span nodeIndex="5094"><span nodeIndex="5095"><span lang="EN-US" nodeIndex="5096">edi</span></span></span><span nodeIndex="5097"><span nodeIndex="5098"><span nodeIndex="5099">变为</span></span></span><a name="OLE_LINK16" nodeIndex="5100"></a><a name="OLE_LINK15" nodeIndex="5101"><span nodeIndex="5102"><span nodeIndex="5103"><span nodeIndex="5104"><span lang="EN-US" nodeIndex="5105">1c550</span></span></span></span></a><span nodeIndex="5106"><span nodeIndex="5107"><span nodeIndex="5108">，这时</span></span></span><span nodeIndex="5109"><span nodeIndex="5110"><span lang="EN-US" nodeIndex="5111">memset</span></span></span><span nodeIndex="5112"><span nodeIndex="5113"><span nodeIndex="5114">函数已经结束了，接着</span></span></span><span nodeIndex="5115"><span nodeIndex="5116"><span lang="EN-US" nodeIndex="5117">get_empty_inode()</span></span></span><span nodeIndex="5118"><span nodeIndex="5119"><span nodeIndex="5120">就利用这个</span></span></span><span nodeIndex="5121"><span nodeIndex="5122"><span lang="EN-US" nodeIndex="5123">edi</span></span></span><span nodeIndex="5124"><span nodeIndex="5125"><span nodeIndex="5126">为</span></span></span><span nodeIndex="5127"><span nodeIndex="5128"><span lang="EN-US" nodeIndex="5129">1c518</span></span></span><span nodeIndex="5130"><span nodeIndex="5131"><span nodeIndex="5132">处的空闲</span></span></span><span nodeIndex="5133"><span nodeIndex="5134"><span lang="EN-US" nodeIndex="5135">inode</span></span></span><span nodeIndex="5136"><span nodeIndex="5137"><span nodeIndex="5138">引用置</span></span></span><span nodeIndex="5139"><span nodeIndex="5140"><span lang="EN-US" nodeIndex="5141">1</span></span></span><span nodeIndex="5142"><span nodeIndex="5143"><span nodeIndex="5144">，却错误地将</span></span></span><span nodeIndex="5145"><span nodeIndex="5146"><span lang="EN-US" nodeIndex="5147">1c550</span></span></span><span nodeIndex="5148"><span nodeIndex="5149"><span nodeIndex="5150">出的</span></span></span><span nodeIndex="5151"><span nodeIndex="5152"><span lang="EN-US" nodeIndex="5153">inode</span></span></span><span nodeIndex="5154"><span nodeIndex="5155"><span nodeIndex="5156">引用置</span></span></span><span nodeIndex="5157"><span nodeIndex="5158"><span lang="EN-US" nodeIndex="5159">1</span></span></span><span nodeIndex="5160"><span nodeIndex="5161"><span nodeIndex="5162">了，这样正好修改了进程根目录的引用数。</span></span></span></p>


<p class="MsoNormal" nodeIndex="339"><span nodeIndex="5168"><span nodeIndex="5169"><span nodeIndex="5170">图</span></span></span><span nodeIndex="5171"><span nodeIndex="5172"><span lang="EN-US" nodeIndex="5173">3.29</span></span></span></p>
<p class="MsoNormal" nodeIndex="340"><span nodeIndex="5174"><span nodeIndex="5175"><span nodeIndex="5176">修改过程如图</span></span></span><span nodeIndex="5177"><span nodeIndex="5178"><span lang="EN-US" nodeIndex="5179">3.30</span></span></span><span nodeIndex="5180"><span nodeIndex="5181"><span nodeIndex="5182">所示，其实就是用栈保存和恢复</span></span></span><span nodeIndex="5183"><span nodeIndex="5184"><span lang="EN-US" nodeIndex="5185">edi</span></span></span><span nodeIndex="5186"><span nodeIndex="5187"><span nodeIndex="5188">寄存器而已。</span></span></span></p>

<div id="RIL_IMG_42" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/42"/></div>
<p class="MsoNormal" nodeIndex="343"><span nodeIndex="5192"><span nodeIndex="5193"><span nodeIndex="5194">图</span></span></span><span nodeIndex="5195"><span nodeIndex="5196"><span lang="EN-US" nodeIndex="5197">3.30</span></span></span></p>
<p class="MsoNormal" nodeIndex="344"><span nodeIndex="5198"><span nodeIndex="5199"><span nodeIndex="5200">建议将所有的汇编函数都加上</span></span></span><span nodeIndex="5201"><span nodeIndex="5202"><span lang="EN-US" nodeIndex="5203">push</span></span></span> <span nodeIndex="5204"><span nodeIndex="5205"><span nodeIndex="5206">和</span></span></span><span nodeIndex="5207"><span nodeIndex="5208"><span lang="EN-US" nodeIndex="5209">pop</span></span></span><span nodeIndex="5210"><span nodeIndex="5211"><span nodeIndex="5212">语句保存和恢复函数中使用的寄存器（比如</span></span></span><span nodeIndex="5213"><span nodeIndex="5214"><span lang="EN-US" nodeIndex="5215">get_base</span></span></span><span nodeIndex="524"><span><span>函数），不然很可能以后还会出现其他错误。我猜想有两个可能的原因：早期</span></span></span><span nodeIndex="5216"><span nodeIndex="5217"><span lang="EN-US" nodeIndex="5218">gcc</span></span></span><span nodeIndex="5219"><span nodeIndex="5220"><span nodeIndex="5221">与现在</span></span></span><span nodeIndex="5222"><span nodeIndex="5223"><span lang="EN-US" nodeIndex="5224">gcc</span></span></span><span nodeIndex="5225"><span nodeIndex="5226"><span nodeIndex="5227">的不同，要么就是</span></span></span><span nodeIndex="5228"><span nodeIndex="5229"><span lang="EN-US" nodeIndex="5230">makefile</span></span></span><span nodeIndex="5231"><span nodeIndex="5232"><span nodeIndex="5233">中去掉的</span></span></span><span nodeIndex="5234"><span nodeIndex="5235"><span lang="EN-US" nodeIndex="5236">-fcombine-regs</span></span></span><span nodeIndex="5237"><span nodeIndex="5238"><span nodeIndex="5239">编译选项导致没有保存寄存器吧？<span nodeIndex="5240">这里求高人指点。</span></span></span></span></p>
<p class="MsoNormal" nodeIndex="345"><span nodeIndex="5241"><span nodeIndex="5242"><span nodeIndex="5243">如图</span></span></span><span nodeIndex="5244"><span nodeIndex="5245"><span lang="EN-US" nodeIndex="5246">3.31</span></span></span><span nodeIndex="5247"><span nodeIndex="5248"><span nodeIndex="5249">所示，</span></span></span><span nodeIndex="5250"><span nodeIndex="5251"><span nodeIndex="5252">终于可以跑通了，庆贺一下</span></span></span><span nodeIndex="5253"><span nodeIndex="5254"><span lang="EN-US" nodeIndex="5255">. . . . . .</span></span></span></p>

<div id="RIL_IMG_43" class="RIL_IMG"><img src="/media/posts_images/2015-11-10-1099320994/43"/></div>
<p class="MsoNormal" nodeIndex="348"><span nodeIndex="5259"><span nodeIndex="5260"><span nodeIndex="5261">图</span></span></span><span nodeIndex="5262"><span nodeIndex="5263"><span lang="EN-US" nodeIndex="5264">3.31</span></span></span></p>

<p class="MsoNormal" nodeIndex="350"><span nodeIndex="5265"><span nodeIndex="5266"><b nodeIndex="5267"><span nodeIndex="5268">四、总结及展望</span></b></span></span></p>
<p class="MsoNormal" nodeIndex="351"><span nodeIndex="525"><span><span>花了近一个月的时间，终于把上述工作完成，并记录了下来。这项工作完成的过程中耳边一直萦绕着着老师要论文的催促声，算是不太容易吧。其实总结一下，错误都出现在</span></span></span><span nodeIndex="5269"><span nodeIndex="5270"><span lang="EN-US" nodeIndex="5271">c</span></span></span><span nodeIndex="526"><span><span>和汇编合作的地方，多关注这些地方一定能省好多时间。本文开头已经说过，这个</span></span></span><span nodeIndex="5272"><span nodeIndex="5273"><span lang="EN-US" nodeIndex="5274">linux-0.11</span></span></span><span nodeIndex="5275"><span nodeIndex="5276"><span nodeIndex="5277">并未完全除尽其</span></span></span><span nodeIndex="5278"><span nodeIndex="5279"><span lang="EN-US" nodeIndex="5280">BUG</span></span></span><span nodeIndex="527"><span><span>，但是用上述方法一直做下去，一定能完成的。不过，我得先去干点别的事情了</span></span></span><span nodeIndex="5281"><span nodeIndex="5282"><span lang="EN-US" nodeIndex="5283">^_^</span></span></span><span nodeIndex="5284"><span nodeIndex="5285"><span nodeIndex="5286">。</span></span></span></p>

</div>